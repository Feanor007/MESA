<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MESA Ecospatial Tutorials (Murine Spleen, CODEX) &mdash; MESA 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../_static/nbsphinx-code-cells.css" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=01f34227"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
        <script src="../../_static/copybutton.js?v=f281be69"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="MESA Ecospatial Tutorials (Colorectal Cancer, CODEX)" href="MESA_tutorial_ecospatial_crc.html" />
    <link rel="prev" title="Tutorials" href="../../tutorials.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            MESA
          </a>
              <div class="version">
                0.1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">General</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../tutorials.html">Tutorials</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">MESA Ecospatial Tutorials (Murine Spleen, CODEX)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Read-Data">Read Data</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Customise-colour-palette">Customise colour palette</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Selecting-the-scale-for-spatial-tessellation">Selecting the scale for spatial tessellation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Perform-Ecospatial-Analysis-on-one-sample">Perform Ecospatial Analysis on one sample</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Calculate-MDI">Calculate MDI</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Diversity-Heatmap-Related-Analysis">Diversity Heatmap Related Analysis</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#Perform-Ecospatial-Analysis-on-all-samples">Perform Ecospatial Analysis on all samples</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id1">Calculate MDI</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Calculate-GDI">Calculate GDI</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Calculate-DPI">Calculate DPI</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Calculate-Global-Cell-Frequency-&amp;-Cell-Co-Occurrence">Calculate Global Cell Frequency &amp; Cell Co-Occurrence</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Calculate-Cell-Frequency-and-Cell-Co-Occurrence-in-hot/coldspots">Calculate Cell Frequency and Cell Co-Occurrence in hot/coldspots</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Process-Cell-Co-Occurrence-Dataframe">Process Cell Co-Occurrence Dataframe</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Cell-Co-Occurrence-Circle-Plot">Cell Co-Occurrence Circle Plot</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="MESA_tutorial_ecospatial_crc.html">MESA Ecospatial Tutorials (Colorectal Cancer, CODEX)</a></li>
<li class="toctree-l2"><a class="reference internal" href="MESA_tutorial_ecospatial_liver.html">Helper functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="MESA_tutorial_ecospatial_liver.html#Read-Data">Read Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="MESA_tutorial_ecospatial_liver.html#Perform-Ecospatial-Analysis-on-one-sample">Perform Ecospatial Analysis on one sample</a></li>
<li class="toctree-l2"><a class="reference internal" href="MESA_tutorial_ecospatial_liver.html#Perform-Ecospatial-Analysis-on-all-samples">Perform Ecospatial Analysis on all samples</a></li>
<li class="toctree-l2"><a class="reference internal" href="MESA_tutorial_multiomics.html">MESA Multiomics Tutorials</a></li>
<li class="toctree-l2"><a class="reference internal" href="MESA_in_R.html">Using MESA in R</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../unit_test.html">UnitTest</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">MESA</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../tutorials.html">Tutorials</a></li>
      <li class="breadcrumb-item active">MESA Ecospatial Tutorials (Murine Spleen, CODEX)</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/notebooks/tutorials/MESA_tutorial_ecospatial_murine.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="MESA-Ecospatial-Tutorials-(Murine-Spleen,-CODEX)">
<h1>MESA Ecospatial Tutorials (Murine Spleen, CODEX)<a class="headerlink" href="#MESA-Ecospatial-Tutorials-(Murine-Spleen,-CODEX)" title="Link to this heading"></a></h1>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">anndata</span> <span class="k">as</span> <span class="nn">ad</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.colors</span> <span class="k">as</span> <span class="nn">mcolors</span>
<span class="kn">from</span> <span class="nn">matplotlib.figure</span> <span class="kn">import</span> <span class="n">figaspect</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="n">os</span><span class="o">.</span><span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;../../../&#39;</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">mesa</span> <span class="kn">import</span> <span class="n">ecospatial</span> <span class="k">as</span> <span class="n">eco</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/opt/miniconda3/envs/mesa/lib/python3.11/site-packages/geopandas/_compat.py:106: UserWarning: The Shapely GEOS version (3.8.0-CAPI-1.13.1) is incompatible with the GEOS version PyGEOS was compiled with (3.10.4-CAPI-1.16.2). Conversions between both will be slow.
  warnings.warn(
OMP: Info #276: omp_set_nested routine deprecated, please use omp_set_max_active_levels instead.
/opt/miniconda3/envs/mesa/lib/python3.11/site-packages/spaghetti/network.py:41: FutureWarning: The next major release of pysal/spaghetti (2.0.0) will drop support for all ``libpysal.cg`` geometries. This change is a first step in refactoring ``spaghetti`` that is expected to result in dramatically reduced runtimes for network instantiation and operations. Users currently requiring network and point pattern input as ``libpysal.cg`` geometries should prepare for this simply by converting to ``shapely`` geometries.
  warnings.warn(dep_msg, FutureWarning, stacklevel=1)
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;font.family&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Arial&#39;</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;svg.fonttype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>  <span class="c1"># To keep text as editable text in SVGs</span>
</pre></div>
</div>
</div>
<section id="Read-Data">
<h2>Read Data<a class="headerlink" href="#Read-Data" title="Link to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata</span> <span class="o">=</span> <span class="n">ad</span><span class="o">.</span><span class="n">read_h5ad</span><span class="p">(</span><span class="s1">&#39;/Users/Emrys/Dropbox/spatial_augmentation/data/codex_mouse_spleen/codex_mouse_spleen.h5ad&#39;</span><span class="p">)</span>
<span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;spatial&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;spatial&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">1000</span> <span class="c1"># Convert units to microns</span>
</pre></div>
</div>
</div>
</section>
<section id="Customise-colour-palette">
<h2>Customise colour palette<a class="headerlink" href="#Customise-colour-palette" title="Link to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">colors</span> <span class="k">as</span> <span class="n">mcolors</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">colormaps</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cell_names</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;cell_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tab10</span> <span class="o">=</span> <span class="n">colormaps</span><span class="p">[</span><span class="s1">&#39;tab10&#39;</span><span class="p">]</span>
<span class="n">tab20b</span> <span class="o">=</span> <span class="n">colormaps</span><span class="p">[</span><span class="s1">&#39;tab20b&#39;</span><span class="p">]</span>
<span class="n">tab20c</span> <span class="o">=</span> <span class="n">colormaps</span><span class="p">[</span><span class="s1">&#39;tab20c&#39;</span><span class="p">]</span>

<span class="c1"># Extract specific colors by indexing into the colormap (values from 0 to 1)</span>
<span class="c1"># From tab20b: indices 8 to 19</span>
<span class="n">colors_from_tab20b</span> <span class="o">=</span> <span class="p">[</span><span class="n">tab20b</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">20</span><span class="p">)]</span> <span class="o">+</span> <span class="p">[</span><span class="n">tab20b</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="n">tab20b</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="n">tab20b</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
<span class="c1"># From tab20c: indices 0-3, 8-11, and 16-19</span>
<span class="n">colors_from_tab20c</span> <span class="o">=</span> <span class="p">[</span><span class="n">tab20c</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)]</span> <span class="o">+</span> <span class="p">[</span><span class="n">tab20c</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">12</span><span class="p">)]</span> <span class="o">+</span> <span class="p">[</span><span class="n">tab20c</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">20</span><span class="p">)]</span>


<span class="c1"># Combine the colors into a custom palette</span>
<span class="n">custom_palette</span> <span class="o">=</span> <span class="n">colors_from_tab20c</span> <span class="o">+</span> <span class="n">colors_from_tab20b</span>

<span class="n">colors_hex</span> <span class="o">=</span> <span class="p">[</span><span class="n">mcolors</span><span class="o">.</span><span class="n">rgb2hex</span><span class="p">(</span><span class="n">color</span><span class="p">)</span> <span class="k">for</span> <span class="n">color</span> <span class="ow">in</span> <span class="n">custom_palette</span><span class="p">]</span>
<span class="n">color_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">cell_names</span><span class="p">,</span> <span class="n">colors_hex</span><span class="p">))</span>
<span class="n">color_dict</span><span class="p">[</span><span class="s1">&#39;CD4(+) T cells&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mcolors</span><span class="o">.</span><span class="n">rgb2hex</span><span class="p">(</span><span class="n">tab10</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="n">color_dict</span><span class="p">[</span><span class="s1">&#39;CD8(+) T cells&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;#31a354&#39;</span>
<span class="n">color_dict</span><span class="p">[</span><span class="s1">&#39;CD106(+)CD16/32(-)Ly6C(+)CD31(+)&#39;</span><span class="p">]</span><span class="o">=</span> <span class="s1">&#39;#e7cb94&#39;</span>
<span class="n">color_dict</span><span class="p">[</span><span class="s1">&#39;F4/80(+) mphs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mcolors</span><span class="o">.</span><span class="n">rgb2hex</span><span class="p">(</span><span class="n">tab20c</span><span class="p">(</span><span class="mi">12</span><span class="p">))</span>
<span class="n">color_dict</span><span class="p">[</span><span class="s1">&#39;FDCs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mcolors</span><span class="o">.</span><span class="n">rgb2hex</span><span class="p">(</span><span class="n">tab10</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
<span class="n">color_dict</span><span class="p">[</span><span class="s1">&#39;CD4(+)MHCII(+)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;#637939&#39;</span>
<span class="n">color_dict</span><span class="p">[</span><span class="s1">&#39;CD106(-)CD16/32(-)Ly6C(+)CD31(+) stroma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mcolors</span><span class="o">.</span><span class="n">rgb2hex</span><span class="p">(</span><span class="n">tab10</span><span class="p">(</span><span class="mi">9</span><span class="p">))</span>
<span class="n">color_dict</span><span class="p">[</span><span class="s1">&#39;noid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;#8c6d31&#39;</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>

<span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">color</span> <span class="ow">in</span> <span class="n">color_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">([],</span> <span class="p">[],</span> <span class="n">c</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span><span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;x-small&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_tutorials_MESA_tutorial_ecospatial_murine_9_0.png" src="../../_images/notebooks_tutorials_MESA_tutorial_ecospatial_murine_9_0.png" />
</div>
</div>
</section>
<section id="Selecting-the-scale-for-spatial-tessellation">
<h2>Selecting the scale for spatial tessellation<a class="headerlink" href="#Selecting-the-scale-for-spatial-tessellation" title="Link to this heading"></a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">library_ids</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;sample&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

<span class="c1"># Define the sequence of scales</span>
<span class="n">scales</span> <span class="o">=</span> <span class="p">[</span><span class="mf">2.</span><span class="p">,</span> <span class="mf">4.</span><span class="p">,</span> <span class="mf">8.</span><span class="p">,</span> <span class="mf">16.</span><span class="p">,</span> <span class="mf">24.</span><span class="p">,</span> <span class="mf">32.</span><span class="p">,</span> <span class="mf">48.</span><span class="p">,</span> <span class="mf">64.</span><span class="p">,</span> <span class="mf">72.</span><span class="p">]</span>

<span class="n">mdi_results</span> <span class="o">=</span> <span class="n">eco</span><span class="o">.</span><span class="n">calculate_MDI</span><span class="p">(</span><span class="n">spatial_data</span><span class="o">=</span><span class="n">adata</span><span class="p">,</span>
                                <span class="n">scales</span><span class="o">=</span><span class="n">scales</span><span class="p">,</span>
                                <span class="n">library_key</span><span class="o">=</span><span class="s1">&#39;sample&#39;</span><span class="p">,</span>
                                <span class="n">library_id</span><span class="o">=</span><span class="n">library_ids</span><span class="p">,</span>
                                <span class="n">spatial_key</span><span class="o">=</span><span class="s1">&#39;spatial&#39;</span><span class="p">,</span>
                                <span class="n">cluster_key</span><span class="o">=</span><span class="s1">&#39;cell_type&#39;</span><span class="p">,</span>
                                <span class="n">selecting_scale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="n">random_patch</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                <span class="n">plotfigs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                <span class="n">savefigs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                <span class="n">patch_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;random_seed&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;min_points&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">},</span>
                                <span class="n">other_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;metric&#39;</span><span class="p">:</span> <span class="s1">&#39;Shannon Diversity&#39;</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Processing region: BALBc-1 at scale 2.0
0.000 per cent patches are empty
BALBc-1 at scale 2.0 has 0 patches with zero diveristy
BALBc-1 at scale 2.0 diversity is 2.8096339612313344
Processing region: BALBc-2 at scale 2.0
0.000 per cent patches are empty
BALBc-2 at scale 2.0 has 0 patches with zero diveristy
BALBc-2 at scale 2.0 diversity is 2.8382163972175585
Processing region: BALBc-3 at scale 2.0
0.000 per cent patches are empty
BALBc-3 at scale 2.0 has 0 patches with zero diveristy
BALBc-3 at scale 2.0 diversity is 2.741064715284067
Processing region: MRL-4 at scale 2.0
0.000 per cent patches are empty
MRL-4 at scale 2.0 has 0 patches with zero diveristy
MRL-4 at scale 2.0 diversity is 3.0831593675761644
Processing region: MRL-5 at scale 2.0
0.000 per cent patches are empty
MRL-5 at scale 2.0 has 0 patches with zero diveristy
MRL-5 at scale 2.0 diversity is 3.0598843042677837
Processing region: MRL-6 at scale 2.0
0.000 per cent patches are empty
MRL-6 at scale 2.0 has 0 patches with zero diveristy
MRL-6 at scale 2.0 diversity is 3.0862452321757026
Processing region: MRL-7 at scale 2.0
0.000 per cent patches are empty
MRL-7 at scale 2.0 has 0 patches with zero diveristy
MRL-7 at scale 2.0 diversity is 2.9923502002689952
Processing region: MRL-8 at scale 2.0
0.000 per cent patches are empty
MRL-8 at scale 2.0 has 0 patches with zero diveristy
MRL-8 at scale 2.0 diversity is 3.292377010141359
Processing region: MRL-9 at scale 2.0
0.000 per cent patches are empty
MRL-9 at scale 2.0 has 0 patches with zero diveristy
MRL-9 at scale 2.0 diversity is 3.200400887232563
Processing region: BALBc-1 at scale 4.0
0.000 per cent patches are empty
BALBc-1 at scale 4.0 has 0 patches with zero diveristy
BALBc-1 at scale 4.0 diversity is 2.6784053488305974
Processing region: BALBc-2 at scale 4.0
0.000 per cent patches are empty
BALBc-2 at scale 4.0 has 0 patches with zero diveristy
BALBc-2 at scale 4.0 diversity is 2.6853948865791275
Processing region: BALBc-3 at scale 4.0
0.000 per cent patches are empty
BALBc-3 at scale 4.0 has 0 patches with zero diveristy
BALBc-3 at scale 4.0 diversity is 2.6305199375873096
Processing region: MRL-4 at scale 4.0
0.000 per cent patches are empty
MRL-4 at scale 4.0 has 0 patches with zero diveristy
MRL-4 at scale 4.0 diversity is 2.9864270563061894
Processing region: MRL-5 at scale 4.0
0.000 per cent patches are empty
MRL-5 at scale 4.0 has 0 patches with zero diveristy
MRL-5 at scale 4.0 diversity is 2.8110161541535192
Processing region: MRL-6 at scale 4.0
0.000 per cent patches are empty
MRL-6 at scale 4.0 has 0 patches with zero diveristy
MRL-6 at scale 4.0 diversity is 2.957160443128632
Processing region: MRL-7 at scale 4.0
0.000 per cent patches are empty
MRL-7 at scale 4.0 has 0 patches with zero diveristy
MRL-7 at scale 4.0 diversity is 2.7304462437482897
Processing region: MRL-8 at scale 4.0
0.000 per cent patches are empty
MRL-8 at scale 4.0 has 0 patches with zero diveristy
MRL-8 at scale 4.0 diversity is 3.0901648127096593
Processing region: MRL-9 at scale 4.0
0.000 per cent patches are empty
MRL-9 at scale 4.0 has 0 patches with zero diveristy
MRL-9 at scale 4.0 diversity is 3.0674673256522307
Processing region: BALBc-1 at scale 8.0
0.000 per cent patches are empty
BALBc-1 at scale 8.0 has 0 patches with zero diveristy
BALBc-1 at scale 8.0 diversity is 2.4799987919407114
Processing region: BALBc-2 at scale 8.0
1.562 per cent patches are empty
BALBc-2 at scale 8.0 has 0 patches with zero diveristy
BALBc-2 at scale 8.0 diversity is 2.5268685163240683
Processing region: BALBc-3 at scale 8.0
1.562 per cent patches are empty
BALBc-3 at scale 8.0 has 0 patches with zero diveristy
BALBc-3 at scale 8.0 diversity is 2.463874240684387
Processing region: MRL-4 at scale 8.0
0.000 per cent patches are empty
MRL-4 at scale 8.0 has 0 patches with zero diveristy
MRL-4 at scale 8.0 diversity is 2.781459883250105
Processing region: MRL-5 at scale 8.0
0.000 per cent patches are empty
MRL-5 at scale 8.0 has 0 patches with zero diveristy
MRL-5 at scale 8.0 diversity is 2.5436517302775545
Processing region: MRL-6 at scale 8.0
0.000 per cent patches are empty
MRL-6 at scale 8.0 has 0 patches with zero diveristy
MRL-6 at scale 8.0 diversity is 2.74441429620238
Processing region: MRL-7 at scale 8.0
0.000 per cent patches are empty
MRL-7 at scale 8.0 has 0 patches with zero diveristy
MRL-7 at scale 8.0 diversity is 2.491933508895646
Processing region: MRL-8 at scale 8.0
0.000 per cent patches are empty
MRL-8 at scale 8.0 has 0 patches with zero diveristy
MRL-8 at scale 8.0 diversity is 2.8661607204492103
Processing region: MRL-9 at scale 8.0
0.000 per cent patches are empty
MRL-9 at scale 8.0 has 0 patches with zero diveristy
MRL-9 at scale 8.0 diversity is 2.8482716801311714
Processing region: BALBc-1 at scale 16.0
1.172 per cent patches are empty
BALBc-1 at scale 16.0 has 0 patches with zero diveristy
BALBc-1 at scale 16.0 diversity is 2.286806849622593
Processing region: BALBc-2 at scale 16.0
2.734 per cent patches are empty
BALBc-2 at scale 16.0 has 1 patches with zero diveristy
BALBc-2 at scale 16.0 diversity is 2.305147780044155
Processing region: BALBc-3 at scale 16.0
3.906 per cent patches are empty
BALBc-3 at scale 16.0 has 0 patches with zero diveristy
BALBc-3 at scale 16.0 diversity is 2.2551143500517985
Processing region: MRL-4 at scale 16.0
0.000 per cent patches are empty
MRL-4 at scale 16.0 has 1 patches with zero diveristy
MRL-4 at scale 16.0 diversity is 2.5551198016811867
Processing region: MRL-5 at scale 16.0
0.000 per cent patches are empty
MRL-5 at scale 16.0 has 0 patches with zero diveristy
MRL-5 at scale 16.0 diversity is 2.3339712388594913
Processing region: MRL-6 at scale 16.0
0.000 per cent patches are empty
MRL-6 at scale 16.0 has 0 patches with zero diveristy
MRL-6 at scale 16.0 diversity is 2.5482756959354242
Processing region: MRL-7 at scale 16.0
0.000 per cent patches are empty
MRL-7 at scale 16.0 has 0 patches with zero diveristy
MRL-7 at scale 16.0 diversity is 2.2869583672535363
Processing region: MRL-8 at scale 16.0
0.000 per cent patches are empty
MRL-8 at scale 16.0 has 0 patches with zero diveristy
MRL-8 at scale 16.0 diversity is 2.631288636532884
Processing region: MRL-9 at scale 16.0
0.000 per cent patches are empty
MRL-9 at scale 16.0 has 0 patches with zero diveristy
MRL-9 at scale 16.0 diversity is 2.6694817985568324
Processing region: BALBc-1 at scale 24.0
1.389 per cent patches are empty
BALBc-1 at scale 24.0 has 1 patches with zero diveristy
BALBc-1 at scale 24.0 diversity is 2.1534111973440258
Processing region: BALBc-2 at scale 24.0
3.819 per cent patches are empty
BALBc-2 at scale 24.0 has 2 patches with zero diveristy
BALBc-2 at scale 24.0 diversity is 2.1717911387351725
Processing region: BALBc-3 at scale 24.0
5.382 per cent patches are empty
BALBc-3 at scale 24.0 has 1 patches with zero diveristy
BALBc-3 at scale 24.0 diversity is 2.1108304169705465
Processing region: MRL-4 at scale 24.0
0.174 per cent patches are empty
MRL-4 at scale 24.0 has 1 patches with zero diveristy
MRL-4 at scale 24.0 diversity is 2.402229261520018
Processing region: MRL-5 at scale 24.0
0.000 per cent patches are empty
MRL-5 at scale 24.0 has 1 patches with zero diveristy
MRL-5 at scale 24.0 diversity is 2.1729982824419456
Processing region: MRL-6 at scale 24.0
0.000 per cent patches are empty
MRL-6 at scale 24.0 has 0 patches with zero diveristy
MRL-6 at scale 24.0 diversity is 2.4037326787430233
Processing region: MRL-7 at scale 24.0
0.000 per cent patches are empty
MRL-7 at scale 24.0 has 0 patches with zero diveristy
MRL-7 at scale 24.0 diversity is 2.1427801224385314
Processing region: MRL-8 at scale 24.0
0.000 per cent patches are empty
MRL-8 at scale 24.0 has 0 patches with zero diveristy
MRL-8 at scale 24.0 diversity is 2.461267774609977
Processing region: MRL-9 at scale 24.0
0.000 per cent patches are empty
MRL-9 at scale 24.0 has 0 patches with zero diveristy
MRL-9 at scale 24.0 diversity is 2.5363818819973907
Processing region: BALBc-1 at scale 32.0
1.855 per cent patches are empty
BALBc-1 at scale 32.0 has 0 patches with zero diveristy
BALBc-1 at scale 32.0 diversity is 2.0660450865998814
Processing region: BALBc-2 at scale 32.0
4.395 per cent patches are empty
BALBc-2 at scale 32.0 has 2 patches with zero diveristy
BALBc-2 at scale 32.0 diversity is 2.077747085040528
Processing region: BALBc-3 at scale 32.0
6.250 per cent patches are empty
BALBc-3 at scale 32.0 has 4 patches with zero diveristy
BALBc-3 at scale 32.0 diversity is 2.0045285007782714
Processing region: MRL-4 at scale 32.0
0.293 per cent patches are empty
MRL-4 at scale 32.0 has 1 patches with zero diveristy
MRL-4 at scale 32.0 diversity is 2.269587989274803
Processing region: MRL-5 at scale 32.0
0.098 per cent patches are empty
MRL-5 at scale 32.0 has 2 patches with zero diveristy
MRL-5 at scale 32.0 diversity is 2.038872313385172
Processing region: MRL-6 at scale 32.0
0.000 per cent patches are empty
MRL-6 at scale 32.0 has 0 patches with zero diveristy
MRL-6 at scale 32.0 diversity is 2.2839611402939903
Processing region: MRL-7 at scale 32.0
0.000 per cent patches are empty
MRL-7 at scale 32.0 has 0 patches with zero diveristy
MRL-7 at scale 32.0 diversity is 2.0264183988555406
Processing region: MRL-8 at scale 32.0
0.000 per cent patches are empty
MRL-8 at scale 32.0 has 0 patches with zero diveristy
MRL-8 at scale 32.0 diversity is 2.332991483128386
Processing region: MRL-9 at scale 32.0
0.000 per cent patches are empty
MRL-9 at scale 32.0 has 0 patches with zero diveristy
MRL-9 at scale 32.0 diversity is 2.4175820356238615
Processing region: BALBc-1 at scale 48.0
2.040 per cent patches are empty
BALBc-1 at scale 48.0 has 4 patches with zero diveristy
BALBc-1 at scale 48.0 diversity is 1.8875194186683664
Processing region: BALBc-2 at scale 48.0
5.165 per cent patches are empty
BALBc-2 at scale 48.0 has 10 patches with zero diveristy
BALBc-2 at scale 48.0 diversity is 1.8958711148324436
Processing region: BALBc-3 at scale 48.0
7.292 per cent patches are empty
BALBc-3 at scale 48.0 has 18 patches with zero diveristy
BALBc-3 at scale 48.0 diversity is 1.8267423093106196
Processing region: MRL-4 at scale 48.0
0.521 per cent patches are empty
MRL-4 at scale 48.0 has 6 patches with zero diveristy
MRL-4 at scale 48.0 diversity is 2.024556351764647
Processing region: MRL-5 at scale 48.0
0.304 per cent patches are empty
MRL-5 at scale 48.0 has 31 patches with zero diveristy
MRL-5 at scale 48.0 diversity is 1.8019013773172798
Processing region: MRL-6 at scale 48.0
0.043 per cent patches are empty
MRL-6 at scale 48.0 has 8 patches with zero diveristy
MRL-6 at scale 48.0 diversity is 2.048425275602085
Processing region: MRL-7 at scale 48.0
0.087 per cent patches are empty
MRL-7 at scale 48.0 has 6 patches with zero diveristy
MRL-7 at scale 48.0 diversity is 1.812888141604879
Processing region: MRL-8 at scale 48.0
0.043 per cent patches are empty
MRL-8 at scale 48.0 has 4 patches with zero diveristy
MRL-8 at scale 48.0 diversity is 2.0926448720351902
Processing region: MRL-9 at scale 48.0
0.000 per cent patches are empty
MRL-9 at scale 48.0 has 1 patches with zero diveristy
MRL-9 at scale 48.0 diversity is 2.1966705026590057
Processing region: BALBc-1 at scale 64.0
2.222 per cent patches are empty
BALBc-1 at scale 64.0 has 28 patches with zero diveristy
BALBc-1 at scale 64.0 diversity is 1.7211111421043181
Processing region: BALBc-2 at scale 64.0
5.542 per cent patches are empty
BALBc-2 at scale 64.0 has 45 patches with zero diveristy
BALBc-2 at scale 64.0 diversity is 1.7323775368753875
Processing region: BALBc-3 at scale 64.0
7.812 per cent patches are empty
BALBc-3 at scale 64.0 has 83 patches with zero diveristy
BALBc-3 at scale 64.0 diversity is 1.6591825505403395
Processing region: MRL-4 at scale 64.0
0.708 per cent patches are empty
MRL-4 at scale 64.0 has 51 patches with zero diveristy
MRL-4 at scale 64.0 diversity is 1.7929988800461276
Processing region: MRL-5 at scale 64.0
0.708 per cent patches are empty
MRL-5 at scale 64.0 has 140 patches with zero diveristy
MRL-5 at scale 64.0 diversity is 1.5852570804754544
Processing region: MRL-6 at scale 64.0
0.220 per cent patches are empty
MRL-6 at scale 64.0 has 30 patches with zero diveristy
MRL-6 at scale 64.0 diversity is 1.8367502236578277
Processing region: MRL-7 at scale 64.0
0.220 per cent patches are empty
MRL-7 at scale 64.0 has 69 patches with zero diveristy
MRL-7 at scale 64.0 diversity is 1.6188286349155905
Processing region: MRL-8 at scale 64.0
0.098 per cent patches are empty
MRL-8 at scale 64.0 has 27 patches with zero diveristy
MRL-8 at scale 64.0 diversity is 1.8713334691757577
Processing region: MRL-9 at scale 64.0
0.000 per cent patches are empty
MRL-9 at scale 64.0 has 15 patches with zero diveristy
MRL-9 at scale 64.0 diversity is 1.9853016901779386
Processing region: BALBc-1 at scale 72.0
2.276 per cent patches are empty
BALBc-1 at scale 72.0 has 56 patches with zero diveristy
BALBc-1 at scale 72.0 diversity is 1.6389677973112058
Processing region: BALBc-2 at scale 72.0
5.671 per cent patches are empty
BALBc-2 at scale 72.0 has 106 patches with zero diveristy
BALBc-2 at scale 72.0 diversity is 1.648178138270326
Processing region: BALBc-3 at scale 72.0
8.102 per cent patches are empty
BALBc-3 at scale 72.0 has 171 patches with zero diveristy
BALBc-3 at scale 72.0 diversity is 1.5798392256220148
Processing region: MRL-4 at scale 72.0
0.791 per cent patches are empty
MRL-4 at scale 72.0 has 132 patches with zero diveristy
MRL-4 at scale 72.0 diversity is 1.6847274790086848
Processing region: MRL-5 at scale 72.0
0.887 per cent patches are empty
MRL-5 at scale 72.0 has 296 patches with zero diveristy
MRL-5 at scale 72.0 diversity is 1.4909160751992683
Processing region: MRL-6 at scale 72.0
0.367 per cent patches are empty
MRL-6 at scale 72.0 has 62 patches with zero diveristy
MRL-6 at scale 72.0 diversity is 1.7428611543774717
Processing region: MRL-7 at scale 72.0
0.270 per cent patches are empty
MRL-7 at scale 72.0 has 154 patches with zero diveristy
MRL-7 at scale 72.0 diversity is 1.5339191149171367
Processing region: MRL-8 at scale 72.0
0.154 per cent patches are empty
MRL-8 at scale 72.0 has 65 patches with zero diveristy
MRL-8 at scale 72.0 diversity is 1.767184117600446
Processing region: MRL-9 at scale 72.0
0.000 per cent patches are empty
MRL-9 at scale 72.0 has 23 patches with zero diveristy
MRL-9 at scale 72.0 diversity is 1.8826653669493028
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Add &#39;Condition&#39; and &#39;Sample_id&#39; to the columns</span>
<span class="n">mdi_results</span><span class="p">[</span><span class="s1">&#39;Condition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span>
<span class="n">mdi_results</span><span class="p">[</span><span class="s1">&#39;Sample_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mdi_results</span><span class="o">.</span><span class="n">index</span>
<span class="n">mdi_results</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mdi_results</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;BALBc&#39;</span><span class="p">),</span> <span class="s1">&#39;Condition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;BALBc&#39;</span>
<span class="n">mdi_results</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mdi_results</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;MRL&#39;</span><span class="p">),</span> <span class="s1">&#39;Condition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;MRL&#39;</span>
<span class="n">mdi_results</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>2.0</th>
      <th>4.0</th>
      <th>8.0</th>
      <th>16.0</th>
      <th>24.0</th>
      <th>32.0</th>
      <th>48.0</th>
      <th>64.0</th>
      <th>72.0</th>
      <th>Slope</th>
      <th>Condition</th>
      <th>Sample_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>BALBc-1</th>
      <td>-0.333333</td>
      <td>-0.107221</td>
      <td>0.140644</td>
      <td>0.409988</td>
      <td>0.592221</td>
      <td>0.660386</td>
      <td>0.688184</td>
      <td>0.639407</td>
      <td>0.609959</td>
      <td>-0.200370</td>
      <td>BALBc</td>
      <td>BALBc-1</td>
    </tr>
    <tr>
      <th>BALBc-2</th>
      <td>-0.333333</td>
      <td>-0.204658</td>
      <td>0.036941</td>
      <td>0.51098</td>
      <td>0.626039</td>
      <td>0.678081</td>
      <td>0.706806</td>
      <td>0.689433</td>
      <td>0.672925</td>
      <td>-0.222745</td>
      <td>BALBc</td>
      <td>BALBc-2</td>
    </tr>
    <tr>
      <th>BALBc-3</th>
      <td>-0.333333</td>
      <td>0.10437</td>
      <td>0.19612</td>
      <td>0.440936</td>
      <td>0.552639</td>
      <td>0.631155</td>
      <td>0.702497</td>
      <td>0.69676</td>
      <td>0.67912</td>
      <td>-0.189041</td>
      <td>BALBc</td>
      <td>BALBc-3</td>
    </tr>
    <tr>
      <th>MRL-4</th>
      <td>-0.333333</td>
      <td>-0.091653</td>
      <td>0.161746</td>
      <td>0.373263</td>
      <td>0.456682</td>
      <td>0.492916</td>
      <td>0.508202</td>
      <td>0.489871</td>
      <td>0.456314</td>
      <td>-0.158657</td>
      <td>MRL</td>
      <td>MRL-4</td>
    </tr>
    <tr>
      <th>MRL-5</th>
      <td>-0.333333</td>
      <td>0.233238</td>
      <td>0.301263</td>
      <td>0.392814</td>
      <td>0.454695</td>
      <td>0.473725</td>
      <td>0.478762</td>
      <td>0.465093</td>
      <td>0.447434</td>
      <td>-0.121308</td>
      <td>MRL</td>
      <td>MRL-5</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_melted</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">mdi_results</span><span class="p">,</span> <span class="n">id_vars</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Sample_id&#39;</span><span class="p">,</span> <span class="s1">&#39;Condition&#39;</span><span class="p">],</span> <span class="n">value_vars</span><span class="o">=</span><span class="n">scales</span><span class="p">,</span>
                    <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;Scale&#39;</span><span class="p">,</span> <span class="n">value_name</span><span class="o">=</span><span class="s1">&#39;Diversity Value&#39;</span><span class="p">)</span>
<span class="n">df_melted</span><span class="p">[</span><span class="s1">&#39;sample&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Tissue Sample&#39;</span>
<span class="n">df_melted</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Sample_id</th>
      <th>Condition</th>
      <th>Scale</th>
      <th>Diversity Value</th>
      <th>sample</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>BALBc-1</td>
      <td>BALBc</td>
      <td>2.0</td>
      <td>-0.333333</td>
      <td>Tissue Sample</td>
    </tr>
    <tr>
      <th>1</th>
      <td>BALBc-2</td>
      <td>BALBc</td>
      <td>2.0</td>
      <td>-0.333333</td>
      <td>Tissue Sample</td>
    </tr>
    <tr>
      <th>2</th>
      <td>BALBc-3</td>
      <td>BALBc</td>
      <td>2.0</td>
      <td>-0.333333</td>
      <td>Tissue Sample</td>
    </tr>
    <tr>
      <th>3</th>
      <td>MRL-4</td>
      <td>MRL</td>
      <td>2.0</td>
      <td>-0.333333</td>
      <td>Tissue Sample</td>
    </tr>
    <tr>
      <th>4</th>
      <td>MRL-5</td>
      <td>MRL</td>
      <td>2.0</td>
      <td>-0.333333</td>
      <td>Tissue Sample</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>76</th>
      <td>MRL-5</td>
      <td>MRL</td>
      <td>72.0</td>
      <td>0.447434</td>
      <td>Tissue Sample</td>
    </tr>
    <tr>
      <th>77</th>
      <td>MRL-6</td>
      <td>MRL</td>
      <td>72.0</td>
      <td>0.401908</td>
      <td>Tissue Sample</td>
    </tr>
    <tr>
      <th>78</th>
      <td>MRL-7</td>
      <td>MRL</td>
      <td>72.0</td>
      <td>0.440493</td>
      <td>Tissue Sample</td>
    </tr>
    <tr>
      <th>79</th>
      <td>MRL-8</td>
      <td>MRL</td>
      <td>72.0</td>
      <td>0.362344</td>
      <td>Tissue Sample</td>
    </tr>
    <tr>
      <th>80</th>
      <td>MRL-9</td>
      <td>MRL</td>
      <td>72.0</td>
      <td>0.384536</td>
      <td>Tissue Sample</td>
    </tr>
  </tbody>
</table>
<p>81 rows × 5 columns</p>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">xrange</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">yrange</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;sample&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
    <span class="n">spatial_value</span> <span class="o">=</span> <span class="n">adata</span><span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;sample&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">region</span><span class="p">]</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;spatial&#39;</span><span class="p">]</span>
    <span class="n">xrange</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spatial_value</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">spatial_value</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">yrange</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spatial_value</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">spatial_value</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">mean_xrange</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">xrange</span><span class="p">)</span>
<span class="n">std_xrange</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">xrange</span><span class="p">)</span>
<span class="n">mean_yrange</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">yrange</span><span class="p">)</span>
<span class="n">std_yrange</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">yrange</span><span class="p">)</span>

<span class="c1"># Calculate mean and confidence interval</span>
<span class="n">grouped</span> <span class="o">=</span> <span class="n">df_melted</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;Scale&#39;</span><span class="p">)</span>
<span class="n">mean_values</span> <span class="o">=</span> <span class="n">grouped</span><span class="p">[</span><span class="s1">&#39;Diversity Value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">conf_intervals</span> <span class="o">=</span> <span class="n">grouped</span><span class="p">[</span><span class="s1">&#39;Diversity Value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">stats</span><span class="o">.</span><span class="n">sem</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">ppf</span><span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="mf">0.95</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>

<span class="c1"># Plotting using sns.lineplot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df_melted</span><span class="p">,</span>
                  <span class="n">x</span><span class="o">=</span><span class="s1">&#39;Scale&#39;</span><span class="p">,</span>
                  <span class="n">y</span><span class="o">=</span><span class="s1">&#39;Diversity Value&#39;</span><span class="p">,</span>
                  <span class="n">style</span><span class="o">=</span><span class="s1">&#39;sample&#39;</span><span class="p">,</span>
                  <span class="n">markers</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                  <span class="n">estimator</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span>
                  <span class="n">err_style</span><span class="o">=</span><span class="s1">&#39;bars&#39;</span><span class="p">,</span>
                  <span class="n">errorbar</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;ci&quot;</span><span class="p">,</span> <span class="mi">95</span><span class="p">),</span>
                  <span class="n">err_kws</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;capsize&quot;</span><span class="p">:</span><span class="mf">5.0</span><span class="p">}</span>
                 <span class="p">)</span>

<span class="c1"># Annotating error bars with their value</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">scale</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">ci</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">mean_values</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">mean_values</span><span class="p">,</span> <span class="n">conf_intervals</span><span class="p">)):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">scale</span><span class="p">,</span> <span class="n">mean</span> <span class="o">+</span> <span class="n">ci</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">mean</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">±</span><span class="si">{</span><span class="n">ci</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">)</span>

<span class="c1"># Drawing red dashed horizontal lines at half the maximum of x and y axes</span>
<span class="n">mean_diversity_per_scale</span> <span class="o">=</span> <span class="n">df_melted</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;Scale&#39;</span><span class="p">)[</span><span class="s1">&#39;Diversity Value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">y_sep</span> <span class="o">=</span> <span class="n">mean_diversity_per_scale</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
<span class="n">x_sep</span> <span class="o">=</span> <span class="n">mean_diversity_per_scale</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span>

<span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y_sep</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x_sep</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">get_legend</span><span class="p">()</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>

<span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;GDI&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

<span class="c1"># Add secondary x-axis</span>
<span class="n">xtick_labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">tick</span><span class="o">.</span><span class="n">get_text</span><span class="p">()</span> <span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">()][</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">scales</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">label</span><span class="p">)</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">xtick_labels</span> <span class="k">if</span> <span class="n">label</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>
<span class="n">x_sizes</span> <span class="o">=</span> <span class="p">[</span><span class="n">mean_xrange</span> <span class="o">/</span> <span class="n">scale</span> <span class="k">for</span> <span class="n">scale</span> <span class="ow">in</span> <span class="n">scales</span><span class="p">]</span>
<span class="n">y_sizes</span> <span class="o">=</span> <span class="p">[</span><span class="n">mean_yrange</span> <span class="o">/</span> <span class="n">scale</span> <span class="k">for</span> <span class="n">scale</span> <span class="ow">in</span> <span class="n">scales</span><span class="p">]</span>
<span class="n">size_labels</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">x_size</span><span class="p">)</span><span class="si">}</span><span class="s2">×</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">y_size</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">x_size</span><span class="p">,</span> <span class="n">y_size</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x_sizes</span><span class="p">,</span> <span class="n">y_sizes</span><span class="p">)]</span>
<span class="n">secax</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">secondary_xaxis</span><span class="p">(</span><span class="n">location</span><span class="o">=-</span><span class="mf">0.075</span><span class="p">)</span>
<span class="n">secax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">scales</span><span class="p">)</span>
<span class="n">secax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">size_labels</span><span class="p">)</span>
<span class="n">secax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">secax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;bottom&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">secax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Scale </span><span class="se">\n</span><span class="s1"> (Area μm²)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;GDI per Scale with 95% Confidence Intervals&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_tutorials_MESA_tutorial_ecospatial_murine_14_0.png" src="../../_images/notebooks_tutorials_MESA_tutorial_ecospatial_murine_14_0.png" />
</div>
</div>
<p>To determine the optimal quadrat size or tiling scale, we generated plots of global diversity index (GDI) values for all samples across different scales, as shown in the figure above. The x-axis represents different scales, with corresponding sizes of the resulting patches annotated. The red horizontal line indicates the median of the mean GDI across all scales, while the red vertical line marks the scale with the highest mean GDI. We recommend selecting scales from the top-right quadrant of the
plot, as it represents both higher GDI values and finer tessellation.</p>
</section>
<section id="Perform-Ecospatial-Analysis-on-one-sample">
<h2>Perform Ecospatial Analysis on one sample<a class="headerlink" href="#Perform-Ecospatial-Analysis-on-one-sample" title="Link to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define sample</span>
<span class="n">sample_id</span> <span class="o">=</span> <span class="s1">&#39;MRL-8&#39;</span>
<span class="n">scale</span> <span class="o">=</span> <span class="mf">64.</span>

<span class="c1"># Generate Quardrats</span>
<span class="n">patches_coordinates</span> <span class="o">=</span> <span class="n">eco</span><span class="o">.</span><span class="n">generate_patches</span><span class="p">(</span><span class="n">spatial_data</span><span class="o">=</span><span class="n">adata</span><span class="p">,</span>
                                           <span class="n">library_key</span><span class="o">=</span><span class="s1">&#39;sample&#39;</span><span class="p">,</span>
                                           <span class="n">library_id</span><span class="o">=</span><span class="n">sample_id</span><span class="p">,</span>
                                           <span class="n">scaling_factor</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span>
                                           <span class="n">spatial_key</span><span class="o">=</span><span class="s1">&#39;spatial&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<section id="Calculate-MDI">
<h3>Calculate MDI<a class="headerlink" href="#Calculate-MDI" title="Link to this heading"></a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define the sequence of scales</span>
<span class="n">scales</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">,</span> <span class="mf">4.</span><span class="p">,</span> <span class="mf">8.</span><span class="p">,</span> <span class="mf">16.</span><span class="p">,</span> <span class="mf">32.</span><span class="p">,</span> <span class="mf">64.</span><span class="p">]</span>

<span class="n">df_results</span> <span class="o">=</span> <span class="n">eco</span><span class="o">.</span><span class="n">calculate_MDI</span><span class="p">(</span><span class="n">spatial_data</span><span class="o">=</span><span class="n">adata</span><span class="p">,</span>
                               <span class="n">scales</span><span class="o">=</span><span class="n">scales</span><span class="p">,</span>
                               <span class="n">library_key</span><span class="o">=</span><span class="s1">&#39;sample&#39;</span><span class="p">,</span>
                               <span class="n">library_id</span><span class="o">=</span><span class="p">[</span><span class="n">sample_id</span><span class="p">],</span>
                               <span class="n">spatial_key</span><span class="o">=</span><span class="s1">&#39;spatial&#39;</span><span class="p">,</span>
                               <span class="n">cluster_key</span><span class="o">=</span><span class="s1">&#39;cell_type&#39;</span><span class="p">,</span>
                               <span class="n">random_patch</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                               <span class="n">plotfigs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                               <span class="n">savefigs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                               <span class="n">patch_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;random_seed&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;min_points&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">},</span>
                               <span class="n">other_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;metric&#39;</span><span class="p">:</span> <span class="s1">&#39;Shannon Diversity&#39;</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Processing region: MRL-8 at scale 1.0
0.000 per cent patches are empty
MRL-8 at scale 1.0 has 0 patches with zero diveristy
MRL-8 at scale 1.0 diversity is 3.4656779602794114
Processing region: MRL-8 at scale 2.0
0.000 per cent patches are empty
MRL-8 at scale 2.0 has 0 patches with zero diveristy
MRL-8 at scale 2.0 diversity is 3.292377010141359
Processing region: MRL-8 at scale 4.0
0.000 per cent patches are empty
MRL-8 at scale 4.0 has 0 patches with zero diveristy
MRL-8 at scale 4.0 diversity is 3.0901648127096593
Processing region: MRL-8 at scale 8.0
0.000 per cent patches are empty
MRL-8 at scale 8.0 has 0 patches with zero diveristy
MRL-8 at scale 8.0 diversity is 2.8661607204492103
Processing region: MRL-8 at scale 16.0
0.000 per cent patches are empty
MRL-8 at scale 16.0 has 0 patches with zero diveristy
MRL-8 at scale 16.0 diversity is 2.631288636532884
Processing region: MRL-8 at scale 32.0
0.000 per cent patches are empty
MRL-8 at scale 32.0 has 0 patches with zero diveristy
MRL-8 at scale 32.0 diversity is 2.332991483128386
Processing region: MRL-8 at scale 64.0
0.098 per cent patches are empty
MRL-8 at scale 64.0 has 27 patches with zero diveristy
MRL-8 at scale 64.0 diversity is 1.8713334691757577
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MDI: </span><span class="si">{</span><span class="n">df_results</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sample_id</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
MDI: 3.466
</pre></div></div>
</div>
</section>
<section id="Diversity-Heatmap-Related-Analysis">
<h3>Diversity Heatmap Related Analysis<a class="headerlink" href="#Diversity-Heatmap-Related-Analysis" title="Link to this heading"></a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Caculate Shannon Diversity Index for each quadrat</span>
<span class="n">patch_indices</span><span class="p">,</span> <span class="n">patches_comp</span> <span class="o">=</span> <span class="n">eco</span><span class="o">.</span><span class="n">calculate_diversity_index</span><span class="p">(</span><span class="n">spatial_data</span><span class="o">=</span><span class="n">adata</span><span class="p">,</span>
                                                            <span class="n">library_key</span><span class="o">=</span><span class="s1">&#39;sample&#39;</span><span class="p">,</span>
                                                            <span class="n">library_id</span><span class="o">=</span><span class="n">sample_id</span><span class="p">,</span>
                                                            <span class="n">spatial_key</span><span class="o">=</span><span class="s1">&#39;spatial&#39;</span><span class="p">,</span>
                                                            <span class="n">patches</span><span class="o">=</span><span class="n">patches_coordinates</span><span class="p">,</span>
                                                            <span class="n">cluster_key</span><span class="o">=</span><span class="s1">&#39;cell_type&#39;</span><span class="p">,</span>
                                                            <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;Shannon Diversity&#39;</span><span class="p">,</span> <span class="n">return_comp</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="c1"># Visualize the diversity indices of quadrats</span>
<span class="n">grid</span><span class="p">,</span> <span class="n">heatmap_fig</span> <span class="o">=</span> <span class="n">eco</span><span class="o">.</span><span class="n">diversity_heatmap</span><span class="p">(</span><span class="n">spatial_data</span><span class="o">=</span><span class="n">adata</span><span class="p">,</span>
                                          <span class="n">library_key</span><span class="o">=</span><span class="s1">&#39;sample&#39;</span><span class="p">,</span>
                                          <span class="n">library_id</span><span class="o">=</span><span class="n">sample_id</span><span class="p">,</span>
                                          <span class="n">spatial_key</span><span class="o">=</span><span class="s1">&#39;spatial&#39;</span><span class="p">,</span>
                                          <span class="n">patches</span><span class="o">=</span><span class="n">patches_coordinates</span><span class="p">,</span>
                                          <span class="n">heterogeneity_indices</span><span class="o">=</span><span class="n">patch_indices</span><span class="p">,</span>
                                          <span class="n">tissue_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                          <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                          <span class="n">return_fig</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
0.098 per cent patches are empty
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_tutorials_MESA_tutorial_ecospatial_murine_22_1.png" src="../../_images/notebooks_tutorials_MESA_tutorial_ecospatial_murine_22_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calculate GDI</span>
<span class="n">GDI</span><span class="p">,</span> <span class="n">p_sim</span> <span class="o">=</span> <span class="n">eco</span><span class="o">.</span><span class="n">global_spatial_stats</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;MoranI&#39;</span><span class="p">,</span> <span class="n">tissue_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">plot_weights</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;GDI: </span><span class="si">{</span><span class="n">GDI</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, p-value: </span><span class="si">{</span><span class="n">p_sim</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
GDI: 0.379, p-value: 0.001
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">lisa</span> <span class="o">=</span> <span class="n">eco</span><span class="o">.</span><span class="n">local_spatial_stats</span><span class="p">(</span><span class="n">grid</span><span class="o">=</span><span class="n">grid</span><span class="p">,</span>
                                     <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;MoranI&#39;</span><span class="p">,</span>
                                     <span class="n">tissue_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                     <span class="n">p_value</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
                                     <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
                                     <span class="n">plot_weights</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                     <span class="n">return_stats</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">heatmap_fig</span> <span class="o">=</span> <span class="n">eco</span><span class="o">.</span><span class="n">signif_heatmap</span><span class="p">(</span><span class="n">spatial_data</span><span class="o">=</span><span class="n">adata</span><span class="p">,</span>
                                 <span class="n">library_key</span><span class="o">=</span><span class="s1">&#39;sample&#39;</span><span class="p">,</span>
                                 <span class="n">library_id</span><span class="o">=</span><span class="n">sample_id</span><span class="p">,</span>
                                 <span class="n">spatial_key</span><span class="o">=</span><span class="s1">&#39;spatial&#39;</span><span class="p">,</span>
                                 <span class="n">patches</span><span class="o">=</span><span class="n">patches_coordinates</span><span class="p">,</span>
                                 <span class="n">heterogeneity_indices</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">lisa</span><span class="o">.</span><span class="n">p_sim</span><span class="p">),</span>
                                 <span class="n">tissue_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                 <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                 <span class="n">discrete</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                 <span class="n">return_fig</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Using MoranI
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_tutorials_MESA_tutorial_ecospatial_murine_24_1.png" src="../../_images/notebooks_tutorials_MESA_tutorial_ecospatial_murine_24_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calculate LDI and find hot/coldspots</span>
<span class="n">hotspots</span><span class="p">,</span> <span class="n">coldspots</span> <span class="o">=</span> <span class="n">eco</span><span class="o">.</span><span class="n">local_spatial_stats</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;MoranI&#39;</span><span class="p">,</span> <span class="n">p_value</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">tissue_only</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Using MoranI
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Visualise hot/coldspots</span>
<span class="n">combined_spots</span> <span class="o">=</span> <span class="p">(</span><span class="n">hotspots</span> <span class="o">*</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">coldspots</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">seismic</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">seismic</span>
<span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">seismic</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">seismic</span><span class="p">(</span><span class="mf">0.999</span><span class="p">)]</span>
<span class="n">cmap</span> <span class="o">=</span> <span class="n">mcolors</span><span class="o">.</span><span class="n">LinearSegmentedColormap</span><span class="o">.</span><span class="n">from_list</span><span class="p">(</span><span class="s2">&quot;custom_map&quot;</span><span class="p">,</span> <span class="n">colors</span><span class="p">)</span>

<span class="n">spatial_value</span> <span class="o">=</span> <span class="n">adata</span><span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;sample&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">sample_id</span><span class="p">]</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;spatial&#39;</span><span class="p">]</span>
<span class="n">min_x</span><span class="p">,</span> <span class="n">min_y</span> <span class="o">=</span> <span class="n">spatial_value</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">spatial_value</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">max_x</span><span class="p">,</span> <span class="n">max_y</span> <span class="o">=</span> <span class="n">spatial_value</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">spatial_value</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">width</span> <span class="o">=</span> <span class="n">max_x</span> <span class="o">-</span> <span class="n">min_x</span>
<span class="n">height</span> <span class="o">=</span> <span class="n">max_y</span> <span class="o">-</span> <span class="n">min_y</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;width: </span><span class="si">{</span><span class="n">width</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, height: </span><span class="si">{</span><span class="n">height</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">figaspect</span><span class="p">(</span><span class="n">height</span><span class="o">/</span><span class="n">width</span><span class="p">)</span>

<span class="n">spot_fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">spot_fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

<span class="c1"># Create a 2D grid</span>
<span class="n">grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="n">max_y</span> <span class="o">-</span> <span class="n">min_y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">max_x</span> <span class="o">-</span> <span class="n">min_x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>

<span class="c1"># Fill the grid with heterogeneity indices</span>
<span class="k">for</span> <span class="n">patch</span><span class="p">,</span> <span class="n">diversity_index</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">combined_spots</span><span class="o">.</span><span class="n">flatten</span><span class="p">()):</span>
    <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="n">patches_coordinates</span><span class="p">[</span><span class="n">patch</span><span class="p">]</span>
    <span class="n">grid</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">y0</span><span class="o">-</span><span class="n">min_y</span><span class="p">):</span><span class="nb">int</span><span class="p">(</span><span class="n">y1</span><span class="o">-</span><span class="n">min_y</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">x0</span><span class="o">-</span><span class="n">min_x</span><span class="p">):</span><span class="nb">int</span><span class="p">(</span><span class="n">x1</span><span class="o">-</span><span class="n">min_x</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">diversity_index</span>

<span class="c1"># Plot the heatmap</span>
<span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
width: 1768.140, height: 1704.784
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.image.AxesImage at 0x1543808d0&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_tutorials_MESA_tutorial_ecospatial_murine_26_2.png" src="../../_images/notebooks_tutorials_MESA_tutorial_ecospatial_murine_26_2.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calculate DPI for hotspots</span>
<span class="n">Hot</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># Set True to investigate hot islands</span>
<span class="n">proximity_I</span> <span class="o">=</span> <span class="n">eco</span><span class="o">.</span><span class="n">calculate_DPI</span><span class="p">(</span><span class="n">spatial_data</span><span class="o">=</span><span class="n">adata</span><span class="p">,</span>
                                <span class="n">scale</span><span class="o">=</span><span class="mf">64.0</span><span class="p">,</span>
                                <span class="n">library_key</span><span class="o">=</span><span class="s1">&#39;sample&#39;</span><span class="p">,</span>
                                <span class="n">library_id</span><span class="o">=</span><span class="p">[</span><span class="n">sample_id</span><span class="p">],</span>
                                <span class="n">spatial_key</span><span class="o">=</span><span class="s1">&#39;spatial&#39;</span><span class="p">,</span>
                                <span class="n">cluster_key</span><span class="o">=</span><span class="s1">&#39;cell_type&#39;</span><span class="p">,</span>
                                <span class="n">hotspot</span><span class="o">=</span><span class="n">Hot</span><span class="p">,</span>
                                <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;MoranI&#39;</span><span class="p">,</span>
                                <span class="n">p_value</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
                                <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;Shannon Diversity&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DPI: </span><span class="si">{</span><span class="n">proximity_I</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sample_id</span><span class="p">,</span><span class="s1">&#39;DPI&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Processing region: MRL-8 at scale 64.0
0.098 per cent patches are empty
Using MoranI
Region MRL-8 contains 331 diversity hotspots
61 islands identified
DPI: 183.256
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Visualise Islands composition and similarity</span>
<span class="kn">from</span> <span class="nn">scipy.spatial.distance</span> <span class="kn">import</span> <span class="n">pdist</span><span class="p">,</span> <span class="n">squareform</span>
<span class="n">labelled_hot</span><span class="p">,</span> <span class="n">num_hot_islands</span> <span class="o">=</span> <span class="n">eco</span><span class="o">.</span><span class="n">_utils</span><span class="o">.</span><span class="n">_label_islands</span><span class="p">(</span><span class="n">hotspots</span><span class="p">,</span> <span class="n">rook</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">labelled_cold</span><span class="p">,</span> <span class="n">num_cold_islands</span> <span class="o">=</span> <span class="n">eco</span><span class="o">.</span><span class="n">_utils</span><span class="o">.</span><span class="n">_label_islands</span><span class="p">(</span><span class="n">coldspots</span><span class="p">,</span> <span class="n">rook</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">if</span> <span class="n">Hot</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Aggregating hot islands composition&quot;</span><span class="p">)</span>
    <span class="n">filtered_patches_coordinates</span> <span class="o">=</span> <span class="p">[</span><span class="n">patch</span> <span class="k">for</span> <span class="n">patch</span><span class="p">,</span> <span class="n">is_hotspot</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">patches_coordinates</span><span class="p">,</span> <span class="n">hotspots</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span> <span class="k">if</span> <span class="n">is_hotspot</span><span class="p">]</span>
    <span class="n">filtered_patches_comp</span> <span class="o">=</span> <span class="p">[</span><span class="n">patch</span> <span class="k">for</span> <span class="n">patch</span><span class="p">,</span> <span class="n">is_hotspot</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">patches_comp</span><span class="p">,</span> <span class="n">hotspots</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span> <span class="k">if</span> <span class="n">is_hotspot</span><span class="p">]</span>
    <span class="n">island_comp</span> <span class="o">=</span> <span class="n">eco</span><span class="o">.</span><span class="n">_utils</span><span class="o">.</span><span class="n">aggregate_spot_compositions</span><span class="p">(</span><span class="n">labelled_hot</span><span class="p">,</span> <span class="n">patches_comp</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Aggregating cold islands composition&quot;</span><span class="p">)</span>
    <span class="n">filtered_patches_coordinates</span> <span class="o">=</span> <span class="p">[</span><span class="n">patch</span> <span class="k">for</span> <span class="n">patch</span><span class="p">,</span> <span class="n">is_coldspot</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">patches_coordinates</span><span class="p">,</span> <span class="n">coldspots</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span> <span class="k">if</span> <span class="n">is_coldspot</span><span class="p">]</span>
    <span class="n">filtered_patches_comp</span> <span class="o">=</span> <span class="p">[</span><span class="n">patch</span> <span class="k">for</span> <span class="n">patch</span><span class="p">,</span> <span class="n">is_coldspot</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">patches_comp</span><span class="p">,</span> <span class="n">coldspots</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span> <span class="k">if</span> <span class="n">is_coldspot</span><span class="p">]</span>
    <span class="n">island_comp</span> <span class="o">=</span> <span class="n">eco</span><span class="o">.</span><span class="n">_utils</span><span class="o">.</span><span class="n">aggregate_spot_compositions</span><span class="p">(</span><span class="n">labelled_cold</span><span class="p">,</span> <span class="n">patches_comp</span><span class="p">)</span>
<span class="n">island_comp</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Aggregating hot islands composition
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>B cells</th>
      <th>B220(+) DN T cells</th>
      <th>CD106(+)CD16/32(+)CD31(+) stroma</th>
      <th>CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma</th>
      <th>CD106(+)CD16/32(-)Ly6C(+)CD31(+)</th>
      <th>CD106(-)CD16/32(+)Ly6C(+)CD31(-)</th>
      <th>CD106(-)CD16/32(-)Ly6C(+)CD31(+) stroma</th>
      <th>CD11c(+) B cells</th>
      <th>CD3(+) other markers (-)</th>
      <th>CD31(hi) vascular</th>
      <th>...</th>
      <th>F4/80(+) mphs</th>
      <th>FDCs</th>
      <th>NK cells</th>
      <th>capsule</th>
      <th>erythroblasts</th>
      <th>granulocytes</th>
      <th>marginal zone mphs</th>
      <th>megakaryocytes</th>
      <th>noid</th>
      <th>plasma cells</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Island_1</th>
      <td>16.0</td>
      <td>4.0</td>
      <td>0.0</td>
      <td>18.0</td>
      <td>5.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>4.0</td>
      <td>...</td>
      <td>3.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>12.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>9.0</td>
    </tr>
    <tr>
      <th>Island_2</th>
      <td>2.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>20.0</td>
      <td>0.0</td>
      <td>2.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>2.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>5.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>14.0</td>
      <td>4.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>3.0</td>
    </tr>
    <tr>
      <th>Island_3</th>
      <td>6.0</td>
      <td>11.0</td>
      <td>3.0</td>
      <td>29.0</td>
      <td>0.0</td>
      <td>2.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>4.0</td>
      <td>0.0</td>
      <td>2.0</td>
      <td>0.0</td>
      <td>7.0</td>
      <td>2.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>13.0</td>
    </tr>
    <tr>
      <th>Island_4</th>
      <td>28.0</td>
      <td>6.0</td>
      <td>2.0</td>
      <td>7.0</td>
      <td>15.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>8.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>12.0</td>
      <td>0.0</td>
      <td>5.0</td>
      <td>0.0</td>
      <td>46.0</td>
      <td>14.0</td>
      <td>0.0</td>
      <td>2.0</td>
      <td>1.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>Island_5</th>
      <td>18.0</td>
      <td>5.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>3.0</td>
      <td>0.0</td>
      <td>7.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 27 columns</p>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Visualise labelled islands (hot islands in red; cold islands in blue)</span>
<span class="kn">from</span> <span class="nn">scipy.ndimage</span> <span class="kn">import</span> <span class="n">center_of_mass</span>
<span class="n">combined_spots</span> <span class="o">=</span> <span class="p">(</span><span class="n">hotspots</span> <span class="o">*</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">coldspots</span> <span class="o">*</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">seismic</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">seismic</span>
<span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="s1">&#39;grey&#39;</span><span class="p">]</span>
<span class="n">cmap</span> <span class="o">=</span> <span class="n">mcolors</span><span class="o">.</span><span class="n">LinearSegmentedColormap</span><span class="o">.</span><span class="n">from_list</span><span class="p">(</span><span class="s2">&quot;single_color_map&quot;</span><span class="p">,</span> <span class="n">colors</span><span class="p">)</span>

<span class="n">labelled_hot</span><span class="p">,</span> <span class="n">num_hot_islands</span> <span class="o">=</span> <span class="n">eco</span><span class="o">.</span><span class="n">_utils</span><span class="o">.</span><span class="n">_label_islands</span><span class="p">(</span><span class="n">hotspots</span><span class="p">,</span> <span class="n">rook</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">labelled_cold</span><span class="p">,</span> <span class="n">num_cold_islands</span> <span class="o">=</span> <span class="n">eco</span><span class="o">.</span><span class="n">_utils</span><span class="o">.</span><span class="n">_label_islands</span><span class="p">(</span><span class="n">coldspots</span><span class="p">,</span> <span class="n">rook</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">min_x</span><span class="p">,</span> <span class="n">min_y</span> <span class="o">=</span> <span class="n">spatial_value</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">spatial_value</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">max_x</span><span class="p">,</span> <span class="n">max_y</span> <span class="o">=</span> <span class="n">spatial_value</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">spatial_value</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">width</span> <span class="o">=</span> <span class="n">max_x</span> <span class="o">-</span> <span class="n">min_x</span>
<span class="n">height</span> <span class="o">=</span> <span class="n">max_y</span> <span class="o">-</span> <span class="n">min_y</span>
<span class="nb">print</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
<span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">figaspect</span><span class="p">(</span><span class="n">height</span><span class="o">/</span><span class="n">width</span><span class="p">)</span>

<span class="n">spot_fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">spot_fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

<span class="c1"># Create a 2D grid</span>
<span class="n">grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="n">max_y</span> <span class="o">-</span> <span class="n">min_y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">max_x</span> <span class="o">-</span> <span class="n">min_x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>

<span class="c1"># Fill the grid with diversity indices</span>
<span class="k">for</span> <span class="n">patch</span><span class="p">,</span> <span class="n">diversity_index</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">combined_spots</span><span class="o">.</span><span class="n">flatten</span><span class="p">()):</span>
    <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="n">patches_coordinates</span><span class="p">[</span><span class="n">patch</span><span class="p">]</span>
    <span class="n">grid</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">y0</span><span class="o">-</span><span class="n">min_y</span><span class="p">):</span><span class="nb">int</span><span class="p">(</span><span class="n">y1</span><span class="o">-</span><span class="n">min_y</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">x0</span><span class="o">-</span><span class="n">min_x</span><span class="p">):</span><span class="nb">int</span><span class="p">(</span><span class="n">x1</span><span class="o">-</span><span class="n">min_x</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">diversity_index</span>

<span class="c1"># Calculate centroids of hot/cold islands and label them</span>
<span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_hot_islands</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
    <span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">labelled_hot</span> <span class="o">==</span> <span class="n">label</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">positions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">centroid</span> <span class="o">=</span> <span class="n">center_of_mass</span><span class="p">(</span><span class="n">labelled_hot</span> <span class="o">==</span> <span class="n">label</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">centroid</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">width</span><span class="o">/</span><span class="n">scale</span><span class="p">,</span>
                <span class="n">centroid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">height</span><span class="o">/</span><span class="n">scale</span><span class="p">,</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">label</span><span class="p">),</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;semibold&#39;</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="n">seismic</span><span class="p">(</span><span class="mf">0.999</span><span class="p">),</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
                <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_cold_islands</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
    <span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">labelled_cold</span> <span class="o">==</span> <span class="n">label</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">positions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">centroid</span> <span class="o">=</span> <span class="n">center_of_mass</span><span class="p">(</span><span class="n">labelled_cold</span> <span class="o">==</span> <span class="n">label</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">centroid</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">width</span><span class="o">/</span><span class="n">scale</span><span class="p">,</span>
                <span class="n">centroid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">height</span><span class="o">/</span><span class="n">scale</span><span class="p">,</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">label</span><span class="p">),</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;semibold&#39;</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="n">seismic</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
                <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;X Coordinates&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Y Coordinates&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
1768.1399999999999 1704.784
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.image.AxesImage at 0x154bdfd50&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_tutorials_MESA_tutorial_ecospatial_murine_29_2.png" src="../../_images/notebooks_tutorials_MESA_tutorial_ecospatial_murine_29_2.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">color_dict</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">island_comp</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">island_comp</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;barh&#39;</span><span class="p">,</span> <span class="n">stacked</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">9</span><span class="p">))</span>

<span class="c1"># Set plot title, axis labels, and legend</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Number of Cells&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_tutorials_MESA_tutorial_ecospatial_murine_30_0.png" src="../../_images/notebooks_tutorials_MESA_tutorial_ecospatial_murine_30_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">island_comp</span> <span class="o">=</span> <span class="n">island_comp</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">island_comp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">island_comp_filled</span> <span class="o">=</span> <span class="n">island_comp</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># Calculate Bray-Curtis distance</span>
<span class="n">distances</span> <span class="o">=</span> <span class="n">pdist</span><span class="p">(</span><span class="n">island_comp_filled</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;braycurtis&#39;</span><span class="p">)</span>

<span class="c1"># Convert the condensed distance matrix to a square matrix</span>
<span class="n">distance_matrix</span> <span class="o">=</span> <span class="n">squareform</span><span class="p">(</span><span class="n">distances</span><span class="p">)</span>

<span class="c1"># Create a mask for the upper triangle</span>
<span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">triu</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">distance_matrix</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">),</span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">axis_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">distance_matrix</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">distance_matrix</span><span class="p">,</span>
            <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
            <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;rocket&#39;</span><span class="p">,</span>
            <span class="n">vmin</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
            <span class="n">vmax</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
            <span class="n">annot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">square</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">linewidths</span><span class="o">=</span><span class="mf">.5</span><span class="p">,</span>
            <span class="n">xticklabels</span><span class="o">=</span><span class="n">axis_labels</span><span class="p">,</span>
            <span class="n">yticklabels</span><span class="o">=</span><span class="n">axis_labels</span><span class="p">,</span>
            <span class="n">cbar_kws</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;shrink&quot;</span><span class="p">:</span> <span class="mf">.5</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;Bray-Curtis Dissimilarity&quot;</span><span class="p">})</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_tutorials_MESA_tutorial_ecospatial_murine_31_0.png" src="../../_images/notebooks_tutorials_MESA_tutorial_ecospatial_murine_31_0.png" />
</div>
</div>
</section>
</section>
<section id="Perform-Ecospatial-Analysis-on-all-samples">
<h2>Perform Ecospatial Analysis on all samples<a class="headerlink" href="#Perform-Ecospatial-Analysis-on-all-samples" title="Link to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">library_ids</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;sample&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</pre></div>
</div>
</div>
<section id="id1">
<h3>Calculate MDI<a class="headerlink" href="#id1" title="Link to this heading"></a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define the sequence of scales</span>
<span class="n">scales</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">,</span> <span class="mf">4.</span><span class="p">,</span> <span class="mf">8.</span><span class="p">,</span> <span class="mf">16.</span><span class="p">,</span> <span class="mf">32.</span><span class="p">,</span> <span class="mf">64.</span><span class="p">]</span>

<span class="n">mdi_results</span> <span class="o">=</span> <span class="n">eco</span><span class="o">.</span><span class="n">calculate_MDI</span><span class="p">(</span><span class="n">spatial_data</span><span class="o">=</span><span class="n">adata</span><span class="p">,</span>
                                <span class="n">scales</span><span class="o">=</span><span class="n">scales</span><span class="p">,</span>
                                <span class="n">library_key</span><span class="o">=</span><span class="s1">&#39;sample&#39;</span><span class="p">,</span>
                                <span class="n">library_id</span><span class="o">=</span><span class="n">library_ids</span><span class="p">,</span>
                                <span class="n">spatial_key</span><span class="o">=</span><span class="s1">&#39;spatial&#39;</span><span class="p">,</span>
                                <span class="n">cluster_key</span><span class="o">=</span><span class="s1">&#39;cell_type&#39;</span><span class="p">,</span>
                                <span class="n">random_patch</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                <span class="n">plotfigs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                <span class="n">savefigs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                <span class="n">patch_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;random_seed&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;min_points&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">},</span>
                                <span class="n">other_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;metric&#39;</span><span class="p">:</span> <span class="s1">&#39;Shannon Diversity&#39;</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Processing region: BALBc-1 at scale 1.0
0.000 per cent patches are empty
BALBc-1 at scale 1.0 has 0 patches with zero diveristy
BALBc-1 at scale 1.0 diversity is 2.8224049147168166
Processing region: BALBc-2 at scale 1.0
0.000 per cent patches are empty
BALBc-2 at scale 1.0 has 0 patches with zero diveristy
BALBc-2 at scale 1.0 diversity is 2.8742375282078143
Processing region: BALBc-3 at scale 1.0
0.000 per cent patches are empty
BALBc-3 at scale 1.0 has 0 patches with zero diveristy
BALBc-3 at scale 1.0 diversity is 2.8116755585127406
Processing region: MRL-4 at scale 1.0
0.000 per cent patches are empty
MRL-4 at scale 1.0 has 0 patches with zero diveristy
MRL-4 at scale 1.0 diversity is 3.126137234736102
Processing region: MRL-5 at scale 1.0
0.000 per cent patches are empty
MRL-5 at scale 1.0 has 0 patches with zero diveristy
MRL-5 at scale 1.0 diversity is 3.2585089241112524
Processing region: MRL-6 at scale 1.0
0.000 per cent patches are empty
MRL-6 at scale 1.0 has 0 patches with zero diveristy
MRL-6 at scale 1.0 diversity is 3.3443099513229604
Processing region: MRL-7 at scale 1.0
0.000 per cent patches are empty
MRL-7 at scale 1.0 has 0 patches with zero diveristy
MRL-7 at scale 1.0 diversity is 3.128433889698631
Processing region: MRL-8 at scale 1.0
0.000 per cent patches are empty
MRL-8 at scale 1.0 has 0 patches with zero diveristy
MRL-8 at scale 1.0 diversity is 3.4656779602794114
Processing region: MRL-9 at scale 1.0
0.000 per cent patches are empty
MRL-9 at scale 1.0 has 0 patches with zero diveristy
MRL-9 at scale 1.0 diversity is 3.3719588637812334
Processing region: BALBc-1 at scale 2.0
0.000 per cent patches are empty
BALBc-1 at scale 2.0 has 0 patches with zero diveristy
BALBc-1 at scale 2.0 diversity is 2.8096339612313344
Processing region: BALBc-2 at scale 2.0
0.000 per cent patches are empty
BALBc-2 at scale 2.0 has 0 patches with zero diveristy
BALBc-2 at scale 2.0 diversity is 2.8382163972175585
Processing region: BALBc-3 at scale 2.0
0.000 per cent patches are empty
BALBc-3 at scale 2.0 has 0 patches with zero diveristy
BALBc-3 at scale 2.0 diversity is 2.741064715284067
Processing region: MRL-4 at scale 2.0
0.000 per cent patches are empty
MRL-4 at scale 2.0 has 0 patches with zero diveristy
MRL-4 at scale 2.0 diversity is 3.0831593675761644
Processing region: MRL-5 at scale 2.0
0.000 per cent patches are empty
MRL-5 at scale 2.0 has 0 patches with zero diveristy
MRL-5 at scale 2.0 diversity is 3.0598843042677837
Processing region: MRL-6 at scale 2.0
0.000 per cent patches are empty
MRL-6 at scale 2.0 has 0 patches with zero diveristy
MRL-6 at scale 2.0 diversity is 3.0862452321757026
Processing region: MRL-7 at scale 2.0
0.000 per cent patches are empty
MRL-7 at scale 2.0 has 0 patches with zero diveristy
MRL-7 at scale 2.0 diversity is 2.9923502002689952
Processing region: MRL-8 at scale 2.0
0.000 per cent patches are empty
MRL-8 at scale 2.0 has 0 patches with zero diveristy
MRL-8 at scale 2.0 diversity is 3.292377010141359
Processing region: MRL-9 at scale 2.0
0.000 per cent patches are empty
MRL-9 at scale 2.0 has 0 patches with zero diveristy
MRL-9 at scale 2.0 diversity is 3.200400887232563
Processing region: BALBc-1 at scale 4.0
0.000 per cent patches are empty
BALBc-1 at scale 4.0 has 0 patches with zero diveristy
BALBc-1 at scale 4.0 diversity is 2.6784053488305974
Processing region: BALBc-2 at scale 4.0
0.000 per cent patches are empty
BALBc-2 at scale 4.0 has 0 patches with zero diveristy
BALBc-2 at scale 4.0 diversity is 2.6853948865791275
Processing region: BALBc-3 at scale 4.0
0.000 per cent patches are empty
BALBc-3 at scale 4.0 has 0 patches with zero diveristy
BALBc-3 at scale 4.0 diversity is 2.6305199375873096
Processing region: MRL-4 at scale 4.0
0.000 per cent patches are empty
MRL-4 at scale 4.0 has 0 patches with zero diveristy
MRL-4 at scale 4.0 diversity is 2.9864270563061894
Processing region: MRL-5 at scale 4.0
0.000 per cent patches are empty
MRL-5 at scale 4.0 has 0 patches with zero diveristy
MRL-5 at scale 4.0 diversity is 2.8110161541535192
Processing region: MRL-6 at scale 4.0
0.000 per cent patches are empty
MRL-6 at scale 4.0 has 0 patches with zero diveristy
MRL-6 at scale 4.0 diversity is 2.957160443128632
Processing region: MRL-7 at scale 4.0
0.000 per cent patches are empty
MRL-7 at scale 4.0 has 0 patches with zero diveristy
MRL-7 at scale 4.0 diversity is 2.7304462437482897
Processing region: MRL-8 at scale 4.0
0.000 per cent patches are empty
MRL-8 at scale 4.0 has 0 patches with zero diveristy
MRL-8 at scale 4.0 diversity is 3.0901648127096593
Processing region: MRL-9 at scale 4.0
0.000 per cent patches are empty
MRL-9 at scale 4.0 has 0 patches with zero diveristy
MRL-9 at scale 4.0 diversity is 3.0674673256522307
Processing region: BALBc-1 at scale 8.0
0.000 per cent patches are empty
BALBc-1 at scale 8.0 has 0 patches with zero diveristy
BALBc-1 at scale 8.0 diversity is 2.4799987919407114
Processing region: BALBc-2 at scale 8.0
1.562 per cent patches are empty
BALBc-2 at scale 8.0 has 0 patches with zero diveristy
BALBc-2 at scale 8.0 diversity is 2.5268685163240683
Processing region: BALBc-3 at scale 8.0
1.562 per cent patches are empty
BALBc-3 at scale 8.0 has 0 patches with zero diveristy
BALBc-3 at scale 8.0 diversity is 2.463874240684387
Processing region: MRL-4 at scale 8.0
0.000 per cent patches are empty
MRL-4 at scale 8.0 has 0 patches with zero diveristy
MRL-4 at scale 8.0 diversity is 2.781459883250105
Processing region: MRL-5 at scale 8.0
0.000 per cent patches are empty
MRL-5 at scale 8.0 has 0 patches with zero diveristy
MRL-5 at scale 8.0 diversity is 2.5436517302775545
Processing region: MRL-6 at scale 8.0
0.000 per cent patches are empty
MRL-6 at scale 8.0 has 0 patches with zero diveristy
MRL-6 at scale 8.0 diversity is 2.74441429620238
Processing region: MRL-7 at scale 8.0
0.000 per cent patches are empty
MRL-7 at scale 8.0 has 0 patches with zero diveristy
MRL-7 at scale 8.0 diversity is 2.491933508895646
Processing region: MRL-8 at scale 8.0
0.000 per cent patches are empty
MRL-8 at scale 8.0 has 0 patches with zero diveristy
MRL-8 at scale 8.0 diversity is 2.8661607204492103
Processing region: MRL-9 at scale 8.0
0.000 per cent patches are empty
MRL-9 at scale 8.0 has 0 patches with zero diveristy
MRL-9 at scale 8.0 diversity is 2.8482716801311714
Processing region: BALBc-1 at scale 16.0
1.172 per cent patches are empty
BALBc-1 at scale 16.0 has 0 patches with zero diveristy
BALBc-1 at scale 16.0 diversity is 2.286806849622593
Processing region: BALBc-2 at scale 16.0
2.734 per cent patches are empty
BALBc-2 at scale 16.0 has 1 patches with zero diveristy
BALBc-2 at scale 16.0 diversity is 2.305147780044155
Processing region: BALBc-3 at scale 16.0
3.906 per cent patches are empty
BALBc-3 at scale 16.0 has 0 patches with zero diveristy
BALBc-3 at scale 16.0 diversity is 2.2551143500517985
Processing region: MRL-4 at scale 16.0
0.000 per cent patches are empty
MRL-4 at scale 16.0 has 1 patches with zero diveristy
MRL-4 at scale 16.0 diversity is 2.5551198016811867
Processing region: MRL-5 at scale 16.0
0.000 per cent patches are empty
MRL-5 at scale 16.0 has 0 patches with zero diveristy
MRL-5 at scale 16.0 diversity is 2.3339712388594913
Processing region: MRL-6 at scale 16.0
0.000 per cent patches are empty
MRL-6 at scale 16.0 has 0 patches with zero diveristy
MRL-6 at scale 16.0 diversity is 2.5482756959354242
Processing region: MRL-7 at scale 16.0
0.000 per cent patches are empty
MRL-7 at scale 16.0 has 0 patches with zero diveristy
MRL-7 at scale 16.0 diversity is 2.2869583672535363
Processing region: MRL-8 at scale 16.0
0.000 per cent patches are empty
MRL-8 at scale 16.0 has 0 patches with zero diveristy
MRL-8 at scale 16.0 diversity is 2.631288636532884
Processing region: MRL-9 at scale 16.0
0.000 per cent patches are empty
MRL-9 at scale 16.0 has 0 patches with zero diveristy
MRL-9 at scale 16.0 diversity is 2.6694817985568324
Processing region: BALBc-1 at scale 32.0
1.855 per cent patches are empty
BALBc-1 at scale 32.0 has 0 patches with zero diveristy
BALBc-1 at scale 32.0 diversity is 2.0660450865998814
Processing region: BALBc-2 at scale 32.0
4.395 per cent patches are empty
BALBc-2 at scale 32.0 has 2 patches with zero diveristy
BALBc-2 at scale 32.0 diversity is 2.077747085040528
Processing region: BALBc-3 at scale 32.0
6.250 per cent patches are empty
BALBc-3 at scale 32.0 has 4 patches with zero diveristy
BALBc-3 at scale 32.0 diversity is 2.0045285007782714
Processing region: MRL-4 at scale 32.0
0.293 per cent patches are empty
MRL-4 at scale 32.0 has 1 patches with zero diveristy
MRL-4 at scale 32.0 diversity is 2.269587989274803
Processing region: MRL-5 at scale 32.0
0.098 per cent patches are empty
MRL-5 at scale 32.0 has 2 patches with zero diveristy
MRL-5 at scale 32.0 diversity is 2.038872313385172
Processing region: MRL-6 at scale 32.0
0.000 per cent patches are empty
MRL-6 at scale 32.0 has 0 patches with zero diveristy
MRL-6 at scale 32.0 diversity is 2.2839611402939903
Processing region: MRL-7 at scale 32.0
0.000 per cent patches are empty
MRL-7 at scale 32.0 has 0 patches with zero diveristy
MRL-7 at scale 32.0 diversity is 2.0264183988555406
Processing region: MRL-8 at scale 32.0
0.000 per cent patches are empty
MRL-8 at scale 32.0 has 0 patches with zero diveristy
MRL-8 at scale 32.0 diversity is 2.332991483128386
Processing region: MRL-9 at scale 32.0
0.000 per cent patches are empty
MRL-9 at scale 32.0 has 0 patches with zero diveristy
MRL-9 at scale 32.0 diversity is 2.4175820356238615
Processing region: BALBc-1 at scale 64.0
2.222 per cent patches are empty
BALBc-1 at scale 64.0 has 28 patches with zero diveristy
BALBc-1 at scale 64.0 diversity is 1.7211111421043181
Processing region: BALBc-2 at scale 64.0
5.542 per cent patches are empty
BALBc-2 at scale 64.0 has 45 patches with zero diveristy
BALBc-2 at scale 64.0 diversity is 1.7323775368753875
Processing region: BALBc-3 at scale 64.0
7.812 per cent patches are empty
BALBc-3 at scale 64.0 has 83 patches with zero diveristy
BALBc-3 at scale 64.0 diversity is 1.6591825505403395
Processing region: MRL-4 at scale 64.0
0.708 per cent patches are empty
MRL-4 at scale 64.0 has 51 patches with zero diveristy
MRL-4 at scale 64.0 diversity is 1.7929988800461276
Processing region: MRL-5 at scale 64.0
0.708 per cent patches are empty
MRL-5 at scale 64.0 has 140 patches with zero diveristy
MRL-5 at scale 64.0 diversity is 1.5852570804754544
Processing region: MRL-6 at scale 64.0
0.220 per cent patches are empty
MRL-6 at scale 64.0 has 30 patches with zero diveristy
MRL-6 at scale 64.0 diversity is 1.8367502236578277
Processing region: MRL-7 at scale 64.0
0.220 per cent patches are empty
MRL-7 at scale 64.0 has 69 patches with zero diveristy
MRL-7 at scale 64.0 diversity is 1.6188286349155905
Processing region: MRL-8 at scale 64.0
0.098 per cent patches are empty
MRL-8 at scale 64.0 has 27 patches with zero diveristy
MRL-8 at scale 64.0 diversity is 1.8713334691757577
Processing region: MRL-9 at scale 64.0
0.000 per cent patches are empty
MRL-9 at scale 64.0 has 15 patches with zero diveristy
MRL-9 at scale 64.0 diversity is 1.9853016901779386
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mdi_results</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>1.0</th>
      <th>2.0</th>
      <th>4.0</th>
      <th>8.0</th>
      <th>16.0</th>
      <th>32.0</th>
      <th>64.0</th>
      <th>Slope</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>BALBc-1</th>
      <td>2.822405</td>
      <td>2.809634</td>
      <td>2.678405</td>
      <td>2.479999</td>
      <td>2.286807</td>
      <td>2.066045</td>
      <td>1.721111</td>
      <td>0.185095</td>
    </tr>
    <tr>
      <th>BALBc-2</th>
      <td>2.874238</td>
      <td>2.838216</td>
      <td>2.685395</td>
      <td>2.526869</td>
      <td>2.305148</td>
      <td>2.077747</td>
      <td>1.732378</td>
      <td>0.190242</td>
    </tr>
    <tr>
      <th>BALBc-3</th>
      <td>2.811676</td>
      <td>2.741065</td>
      <td>2.63052</td>
      <td>2.463874</td>
      <td>2.255114</td>
      <td>2.004529</td>
      <td>1.659183</td>
      <td>0.189498</td>
    </tr>
    <tr>
      <th>MRL-4</th>
      <td>3.126137</td>
      <td>3.083159</td>
      <td>2.986427</td>
      <td>2.78146</td>
      <td>2.55512</td>
      <td>2.269588</td>
      <td>1.792999</td>
      <td>0.216352</td>
    </tr>
    <tr>
      <th>MRL-5</th>
      <td>3.258509</td>
      <td>3.059884</td>
      <td>2.811016</td>
      <td>2.543652</td>
      <td>2.333971</td>
      <td>2.038872</td>
      <td>1.585257</td>
      <td>0.269244</td>
    </tr>
    <tr>
      <th>MRL-6</th>
      <td>3.34431</td>
      <td>3.086245</td>
      <td>2.95716</td>
      <td>2.744414</td>
      <td>2.548276</td>
      <td>2.283961</td>
      <td>1.83675</td>
      <td>0.233433</td>
    </tr>
    <tr>
      <th>MRL-7</th>
      <td>3.128434</td>
      <td>2.99235</td>
      <td>2.730446</td>
      <td>2.491934</td>
      <td>2.286958</td>
      <td>2.026418</td>
      <td>1.618829</td>
      <td>0.246577</td>
    </tr>
    <tr>
      <th>MRL-8</th>
      <td>3.465678</td>
      <td>3.292377</td>
      <td>3.090165</td>
      <td>2.866161</td>
      <td>2.631289</td>
      <td>2.332991</td>
      <td>1.871333</td>
      <td>0.255739</td>
    </tr>
    <tr>
      <th>MRL-9</th>
      <td>3.371959</td>
      <td>3.200401</td>
      <td>3.067467</td>
      <td>2.848272</td>
      <td>2.669482</td>
      <td>2.417582</td>
      <td>1.985302</td>
      <td>0.218700</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Add &#39;Condition&#39; and &#39;Sample_id&#39; to the columns</span>
<span class="n">mdi_results</span><span class="p">[</span><span class="s1">&#39;Condition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span>
<span class="n">mdi_results</span><span class="p">[</span><span class="s1">&#39;Sample_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mdi_results</span><span class="o">.</span><span class="n">index</span>
<span class="n">mdi_results</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mdi_results</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;BALBc&#39;</span><span class="p">),</span> <span class="s1">&#39;Condition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;BALBc&#39;</span>
<span class="n">mdi_results</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mdi_results</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;MRL&#39;</span><span class="p">),</span> <span class="s1">&#39;Condition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;MRL&#39;</span>
<span class="n">mdi_results</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>1.0</th>
      <th>2.0</th>
      <th>4.0</th>
      <th>8.0</th>
      <th>16.0</th>
      <th>32.0</th>
      <th>64.0</th>
      <th>Slope</th>
      <th>Condition</th>
      <th>Sample_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>BALBc-1</th>
      <td>2.822405</td>
      <td>2.809634</td>
      <td>2.678405</td>
      <td>2.479999</td>
      <td>2.286807</td>
      <td>2.066045</td>
      <td>1.721111</td>
      <td>0.185095</td>
      <td>BALBc</td>
      <td>BALBc-1</td>
    </tr>
    <tr>
      <th>BALBc-2</th>
      <td>2.874238</td>
      <td>2.838216</td>
      <td>2.685395</td>
      <td>2.526869</td>
      <td>2.305148</td>
      <td>2.077747</td>
      <td>1.732378</td>
      <td>0.190242</td>
      <td>BALBc</td>
      <td>BALBc-2</td>
    </tr>
    <tr>
      <th>BALBc-3</th>
      <td>2.811676</td>
      <td>2.741065</td>
      <td>2.63052</td>
      <td>2.463874</td>
      <td>2.255114</td>
      <td>2.004529</td>
      <td>1.659183</td>
      <td>0.189498</td>
      <td>BALBc</td>
      <td>BALBc-3</td>
    </tr>
    <tr>
      <th>MRL-4</th>
      <td>3.126137</td>
      <td>3.083159</td>
      <td>2.986427</td>
      <td>2.78146</td>
      <td>2.55512</td>
      <td>2.269588</td>
      <td>1.792999</td>
      <td>0.216352</td>
      <td>MRL</td>
      <td>MRL-4</td>
    </tr>
    <tr>
      <th>MRL-5</th>
      <td>3.258509</td>
      <td>3.059884</td>
      <td>2.811016</td>
      <td>2.543652</td>
      <td>2.333971</td>
      <td>2.038872</td>
      <td>1.585257</td>
      <td>0.269244</td>
      <td>MRL</td>
      <td>MRL-5</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</section>
<section id="Calculate-GDI">
<h3>Calculate GDI<a class="headerlink" href="#Calculate-GDI" title="Link to this heading"></a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gdi_results</span> <span class="o">=</span> <span class="n">eco</span><span class="o">.</span><span class="n">calculate_GDI</span><span class="p">(</span><span class="n">spatial_data</span><span class="o">=</span><span class="n">adata</span><span class="p">,</span>
                                <span class="n">scale</span><span class="o">=</span><span class="mf">64.0</span><span class="p">,</span>
                                <span class="n">library_key</span><span class="o">=</span><span class="s1">&#39;sample&#39;</span><span class="p">,</span>
                                <span class="n">library_id</span><span class="o">=</span><span class="n">library_ids</span><span class="p">,</span>
                                <span class="n">spatial_key</span><span class="o">=</span><span class="s1">&#39;spatial&#39;</span><span class="p">,</span>
                                <span class="n">cluster_key</span><span class="o">=</span><span class="s1">&#39;cell_type&#39;</span><span class="p">,</span>
                                <span class="n">hotspot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="n">restricted</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;Shannon Diversity&#39;</span><span class="p">)</span>
<span class="n">gdi_results</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Processing region: BALBc-1 at scale 64.0
2.222 per cent patches are empty
Processing region: BALBc-2 at scale 64.0
5.542 per cent patches are empty
Processing region: BALBc-3 at scale 64.0
7.812 per cent patches are empty
Processing region: MRL-4 at scale 64.0
0.708 per cent patches are empty
Processing region: MRL-5 at scale 64.0
0.708 per cent patches are empty
Processing region: MRL-6 at scale 64.0
0.220 per cent patches are empty
Processing region: MRL-7 at scale 64.0
0.220 per cent patches are empty
Processing region: MRL-8 at scale 64.0
0.098 per cent patches are empty
Processing region: MRL-9 at scale 64.0
0.000 per cent patches are empty
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>GDI</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>BALBc-1</th>
      <td>0.639407</td>
    </tr>
    <tr>
      <th>BALBc-2</th>
      <td>0.689433</td>
    </tr>
    <tr>
      <th>BALBc-3</th>
      <td>0.696760</td>
    </tr>
    <tr>
      <th>MRL-4</th>
      <td>0.489871</td>
    </tr>
    <tr>
      <th>MRL-5</th>
      <td>0.465093</td>
    </tr>
    <tr>
      <th>MRL-6</th>
      <td>0.424368</td>
    </tr>
    <tr>
      <th>MRL-7</th>
      <td>0.463416</td>
    </tr>
    <tr>
      <th>MRL-8</th>
      <td>0.379494</td>
    </tr>
    <tr>
      <th>MRL-9</th>
      <td>0.433336</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</section>
<section id="Calculate-DPI">
<h3>Calculate DPI<a class="headerlink" href="#Calculate-DPI" title="Link to this heading"></a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calculate DPI for hotspots</span>
<span class="n">dpi_results</span> <span class="o">=</span> <span class="n">eco</span><span class="o">.</span><span class="n">calculate_DPI</span><span class="p">(</span><span class="n">spatial_data</span><span class="o">=</span><span class="n">adata</span><span class="p">,</span>
                                <span class="n">scale</span><span class="o">=</span><span class="mf">64.0</span><span class="p">,</span>
                                <span class="n">library_key</span><span class="o">=</span><span class="s1">&#39;sample&#39;</span><span class="p">,</span>
                                <span class="n">library_id</span><span class="o">=</span><span class="n">library_ids</span><span class="p">,</span>
                                <span class="n">spatial_key</span><span class="o">=</span><span class="s1">&#39;spatial&#39;</span><span class="p">,</span>
                                <span class="n">cluster_key</span><span class="o">=</span><span class="s1">&#39;cell_type&#39;</span><span class="p">,</span>
                                <span class="n">hotspot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;Shannon Diversity&#39;</span><span class="p">)</span>
<span class="n">dpi_results</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Processing region: BALBc-1 at scale 64.0
2.222 per cent patches are empty
Region BALBc-1 contains 687 diversity hotspots
48 islands identified
Processing region: BALBc-2 at scale 64.0
5.542 per cent patches are empty
Region BALBc-2 contains 851 diversity hotspots
47 islands identified
Processing region: BALBc-3 at scale 64.0
7.812 per cent patches are empty
Region BALBc-3 contains 712 diversity hotspots
46 islands identified
Processing region: MRL-4 at scale 64.0
0.708 per cent patches are empty
Region MRL-4 contains 480 diversity hotspots
53 islands identified
Processing region: MRL-5 at scale 64.0
0.708 per cent patches are empty
Region MRL-5 contains 443 diversity hotspots
43 islands identified
Processing region: MRL-6 at scale 64.0
0.220 per cent patches are empty
Region MRL-6 contains 326 diversity hotspots
61 islands identified
Processing region: MRL-7 at scale 64.0
0.220 per cent patches are empty
Region MRL-7 contains 499 diversity hotspots
46 islands identified
Processing region: MRL-8 at scale 64.0
0.098 per cent patches are empty
Region MRL-8 contains 331 diversity hotspots
61 islands identified
Processing region: MRL-9 at scale 64.0
0.000 per cent patches are empty
Region MRL-9 contains 348 diversity hotspots
71 islands identified
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>DPI</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>BALBc-1</th>
      <td>404.254256</td>
    </tr>
    <tr>
      <th>BALBc-2</th>
      <td>506.251921</td>
    </tr>
    <tr>
      <th>BALBc-3</th>
      <td>425.808947</td>
    </tr>
    <tr>
      <th>MRL-4</th>
      <td>270.151840</td>
    </tr>
    <tr>
      <th>MRL-5</th>
      <td>224.575542</td>
    </tr>
    <tr>
      <th>MRL-6</th>
      <td>135.896041</td>
    </tr>
    <tr>
      <th>MRL-7</th>
      <td>262.844537</td>
    </tr>
    <tr>
      <th>MRL-8</th>
      <td>183.255600</td>
    </tr>
    <tr>
      <th>MRL-9</th>
      <td>208.151759</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</section>
<section id="Calculate-Global-Cell-Frequency-&amp;-Cell-Co-Occurrence">
<h3>Calculate Global Cell Frequency &amp; Cell Co-Occurrence<a class="headerlink" href="#Calculate-Global-Cell-Frequency-&-Cell-Co-Occurrence" title="Link to this heading"></a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">global_cellfreq_df</span><span class="p">,</span> <span class="n">global_co_occurrence_df</span> <span class="o">=</span> <span class="n">eco</span><span class="o">.</span><span class="n">spot_cellfreq</span><span class="p">(</span><span class="n">spatial_data</span><span class="o">=</span><span class="n">adata</span><span class="p">,</span>
                                                                <span class="n">scale</span><span class="o">=</span><span class="mf">64.0</span><span class="p">,</span>
                                                                <span class="n">library_key</span><span class="o">=</span><span class="s1">&#39;sample&#39;</span><span class="p">,</span>
                                                                <span class="n">library_id</span><span class="o">=</span><span class="n">library_ids</span><span class="p">,</span>
                                                                <span class="n">spatial_key</span><span class="o">=</span><span class="s1">&#39;spatial&#39;</span><span class="p">,</span>
                                                                <span class="n">cluster_key</span><span class="o">=</span><span class="s1">&#39;cell_type&#39;</span><span class="p">,</span>
                                                                <span class="n">spots</span><span class="o">=</span><span class="s1">&#39;global&#39;</span><span class="p">,</span>
                                                                <span class="n">top</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                                <span class="n">selected_comb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                                <span class="n">restricted</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                                <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;Shannon Diversity&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Processing region: BALBc-1 at scale 64.0
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/Users/Emrys/MESA/docs/notebooks/tutorials/../../../mesa/ecospatial/_ecospatial.py:1281: FutureWarning: The default of observed=False is deprecated and will be changed to True in a future version of pandas. Pass observed=False to retain current behavior or observed=True to adopt the future default and silence this warning.
  global_cell_count = spatial_df.groupby([library_key, cluster_key]).size().unstack(fill_value=0)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
2.222 per cent patches are empty
Using MoranI
Considering whole tissue
Processing region: BALBc-2 at scale 64.0
5.542 per cent patches are empty
Using MoranI
Considering whole tissue
Processing region: BALBc-3 at scale 64.0
7.812 per cent patches are empty
Using MoranI
Considering whole tissue
Processing region: MRL-4 at scale 64.0
0.708 per cent patches are empty
Using MoranI
Considering whole tissue
Processing region: MRL-5 at scale 64.0
0.708 per cent patches are empty
Using MoranI
Considering whole tissue
Processing region: MRL-6 at scale 64.0
0.220 per cent patches are empty
Using MoranI
Considering whole tissue
Processing region: MRL-7 at scale 64.0
0.220 per cent patches are empty
Using MoranI
Considering whole tissue
Processing region: MRL-8 at scale 64.0
0.098 per cent patches are empty
Using MoranI
Considering whole tissue
Processing region: MRL-9 at scale 64.0
0.000 per cent patches are empty
Using MoranI
Considering whole tissue
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">global_cellfreq_df</span><span class="p">[</span><span class="s1">&#39;Condition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span>
<span class="n">global_cellfreq_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">global_cellfreq_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;BALBc&#39;</span><span class="p">),</span> <span class="s1">&#39;Condition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;BALBc&#39;</span>
<span class="n">global_cellfreq_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">global_cellfreq_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;MRL&#39;</span><span class="p">),</span> <span class="s1">&#39;Condition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;MRL&#39;</span>

<span class="n">global_co_occurrence_subcols</span> <span class="o">=</span> <span class="n">global_co_occurrence_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">global_co_occurrence_df</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">&gt;</span><span class="mf">0.05</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">global_co_occurrence_df</span><span class="p">[</span><span class="s1">&#39;Condition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span>
<span class="n">global_co_occurrence_df</span><span class="p">[</span><span class="s1">&#39;Mouse&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">global_co_occurrence_df</span><span class="o">.</span><span class="n">index</span>
<span class="n">global_co_occurrence_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">global_co_occurrence_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;BALBc&#39;</span><span class="p">),</span> <span class="s1">&#39;Condition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;BALBc&#39;</span>
<span class="n">global_co_occurrence_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">global_co_occurrence_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;MRL&#39;</span><span class="p">),</span> <span class="s1">&#39;Condition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;MRL&#39;</span>
<span class="n">global_co_occurrence_subcols</span><span class="o">.</span><span class="n">extend</span><span class="p">([(</span><span class="s1">&#39;Condition&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">),(</span><span class="s1">&#39;Mouse&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)])</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Melt the dataframe for easier plotting and statistical analysis</span>
<span class="n">global_cellfreq_df_melt</span> <span class="o">=</span> <span class="n">global_cellfreq_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">id_vars</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sample&#39;</span><span class="p">,</span> <span class="s1">&#39;Condition&#39;</span><span class="p">])</span>
<span class="n">global_cellfreq_df_melt</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sample&#39;</span><span class="p">,</span> <span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="s1">&#39;cell_type&#39;</span><span class="p">,</span> <span class="s1">&#39;Frequency&#39;</span><span class="p">]</span>

<span class="n">global_cellfreq_df_melt</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>sample</th>
      <th>group</th>
      <th>cell_type</th>
      <th>Frequency</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>BALBc-1</td>
      <td>BALBc</td>
      <td>B220(+) DN T cells</td>
      <td>0.003969</td>
    </tr>
    <tr>
      <th>1</th>
      <td>BALBc-2</td>
      <td>BALBc</td>
      <td>B220(+) DN T cells</td>
      <td>0.003772</td>
    </tr>
    <tr>
      <th>2</th>
      <td>BALBc-3</td>
      <td>BALBc</td>
      <td>B220(+) DN T cells</td>
      <td>0.005446</td>
    </tr>
    <tr>
      <th>3</th>
      <td>MRL-4</td>
      <td>MRL</td>
      <td>B220(+) DN T cells</td>
      <td>0.014466</td>
    </tr>
    <tr>
      <th>4</th>
      <td>MRL-5</td>
      <td>MRL</td>
      <td>B220(+) DN T cells</td>
      <td>0.019893</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>238</th>
      <td>MRL-5</td>
      <td>MRL</td>
      <td>plasma cells</td>
      <td>0.003016</td>
    </tr>
    <tr>
      <th>239</th>
      <td>MRL-6</td>
      <td>MRL</td>
      <td>plasma cells</td>
      <td>0.013661</td>
    </tr>
    <tr>
      <th>240</th>
      <td>MRL-7</td>
      <td>MRL</td>
      <td>plasma cells</td>
      <td>0.003686</td>
    </tr>
    <tr>
      <th>241</th>
      <td>MRL-8</td>
      <td>MRL</td>
      <td>plasma cells</td>
      <td>0.016240</td>
    </tr>
    <tr>
      <th>242</th>
      <td>MRL-9</td>
      <td>MRL</td>
      <td>plasma cells</td>
      <td>0.006100</td>
    </tr>
  </tbody>
</table>
<p>243 rows × 4 columns</p>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Perform t-tests</span>
<span class="n">selected_cell_types</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;cell_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="n">selected_p_values</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">ct</span> <span class="ow">in</span> <span class="n">selected_cell_types</span><span class="p">:</span>
    <span class="n">group1</span> <span class="o">=</span> <span class="n">global_cellfreq_df_melt</span><span class="p">[(</span><span class="n">global_cellfreq_df_melt</span><span class="p">[</span><span class="s1">&#39;cell_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ct</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">global_cellfreq_df_melt</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;BALBc&#39;</span><span class="p">)][</span><span class="s1">&#39;Frequency&#39;</span><span class="p">]</span>
    <span class="n">group2</span> <span class="o">=</span> <span class="n">global_cellfreq_df_melt</span><span class="p">[(</span><span class="n">global_cellfreq_df_melt</span><span class="p">[</span><span class="s1">&#39;cell_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ct</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">global_cellfreq_df_melt</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;MRL&#39;</span><span class="p">)][</span><span class="s1">&#39;Frequency&#39;</span><span class="p">]</span>
    <span class="n">t_stat</span><span class="p">,</span> <span class="n">p_value</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">ttest_ind</span><span class="p">(</span><span class="n">group1</span><span class="p">,</span> <span class="n">group2</span><span class="p">,</span> <span class="n">equal_var</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ct</span><span class="si">}</span><span class="s2"> has p value of </span><span class="si">{</span><span class="n">p_value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">selected_p_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_value</span><span class="p">)</span>

<span class="n">pvals_corrected</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">false_discovery_control</span><span class="p">(</span><span class="n">selected_p_values</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;bh&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">42</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;p-values after correction:&quot;</span><span class="p">)</span>

<span class="c1"># Plot</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">global_cellfreq_df_melt</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;cell_type&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;Frequency&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="s1">&#39;muted&#39;</span><span class="p">,</span> <span class="n">boxprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">.3</span><span class="p">),</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">dodge</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">selected_cell_types</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">swarmplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">global_cellfreq_df_melt</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;cell_type&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;Frequency&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="s1">&#39;dark:black&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">dodge</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">selected_cell_types</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">handles</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">labels</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Groups&quot;</span><span class="p">,</span> <span class="n">handletextpad</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">columnspacing</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>

<span class="n">p_vals_corrected_dict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">yrange</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ct</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">selected_cell_types</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">yrange</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;p = </span><span class="si">{</span><span class="n">pvals_corrected</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ct</span><span class="si">}</span><span class="s2"> has p value = </span><span class="si">{</span><span class="n">pvals_corrected</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">p_vals_corrected_dict</span><span class="p">[</span><span class="n">ct</span><span class="p">]</span> <span class="o">=</span> <span class="n">pvals_corrected</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">selected_cell_types</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mf">0.55</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Frequency&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
B cells has p value of 0.006408963135728074
B220(+) DN T cells has p value of 0.08363460243637065
CD106(+)CD16/32(+)CD31(+) stroma has p value of 0.10246220899780342
CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma has p value of 0.04098951744156447
CD106(+)CD16/32(-)Ly6C(+)CD31(+) has p value of 0.48760707221130684
CD106(-)CD16/32(+)Ly6C(+)CD31(-) has p value of 0.00014746290448731814
CD106(-)CD16/32(-)Ly6C(+)CD31(+) stroma has p value of 0.029644306916028648
CD11c(+) B cells has p value of 0.04433015687789797
CD3(+) other markers (-) has p value of 0.0039461017917897965
CD31(hi) vascular has p value of 0.744873603519344
CD4(+) T cells has p value of 0.23629828012676266
CD4(+)CD8(-)cDC has p value of 0.002101995902806824
CD4(+)MHCII(+) has p value of 0.27737999550550363
CD4(-)CD8(+)cDC has p value of 0.00013225110887609995
CD4(-)CD8(-) cDC has p value of 0.13322938432638706
CD8(+) T cells has p value of 0.8144572874311375
ERTR7(+) stroma has p value of 0.5151830491689221
F4/80(+) mphs has p value of 0.010569967873872599
FDCs has p value of 0.05479798379321029
NK cells has p value of 0.6906209729704317
capsule has p value of 0.03375417362245463
erythroblasts has p value of 0.006927955270797655
granulocytes has p value of 8.550715896090467e-06
marginal zone mphs has p value of 0.0024009677611480013
megakaryocytes has p value of 0.00616336220396191
noid has p value of 0.0859271670427784
plasma cells has p value of 0.22183894046691652
------------------------------------------
p-values after correction:
B cells has p value = 0.021
B220(+) DN T cells has p value = 0.136
CD106(+)CD16/32(+)CD31(+) stroma has p value = 0.154
CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma has p value = 0.085
CD106(+)CD16/32(-)Ly6C(+)CD31(+) has p value = 0.572
CD106(-)CD16/32(+)Ly6C(+)CD31(-) has p value = 0.001
CD106(-)CD16/32(-)Ly6C(+)CD31(+) stroma has p value = 0.073
CD11c(+) B cells has p value = 0.085
CD3(+) other markers (-) has p value = 0.018
CD31(hi) vascular has p value = 0.774
CD4(+) T cells has p value = 0.304
CD4(+)CD8(-)cDC has p value = 0.013
CD4(+)MHCII(+) has p value = 0.340
CD4(-)CD8(+)cDC has p value = 0.001
CD4(-)CD8(-) cDC has p value = 0.189
CD8(+) T cells has p value = 0.814
ERTR7(+) stroma has p value = 0.580
F4/80(+) mphs has p value = 0.029
FDCs has p value = 0.099
NK cells has p value = 0.746
capsule has p value = 0.076
erythroblasts has p value = 0.021
granulocytes has p value = 0.000
marginal zone mphs has p value = 0.013
megakaryocytes has p value = 0.021
noid has p value = 0.136
plasma cells has p value = 0.299
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_tutorials_MESA_tutorial_ecospatial_murine_46_1.png" src="../../_images/notebooks_tutorials_MESA_tutorial_ecospatial_murine_46_1.png" />
</div>
</div>
</section>
<section id="Calculate-Cell-Frequency-and-Cell-Co-Occurrence-in-hot/coldspots">
<h3>Calculate Cell Frequency and Cell Co-Occurrence in hot/coldspots<a class="headerlink" href="#Calculate-Cell-Frequency-and-Cell-Co-Occurrence-in-hot/coldspots" title="Link to this heading"></a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spot_cellfreq_df</span><span class="p">,</span> <span class="n">spot_co_occurrence_df</span> <span class="o">=</span> <span class="n">eco</span><span class="o">.</span><span class="n">spot_cellfreq</span><span class="p">(</span><span class="n">spatial_data</span><span class="o">=</span><span class="n">adata</span><span class="p">,</span>
                                                            <span class="n">scale</span><span class="o">=</span><span class="mf">64.0</span><span class="p">,</span>
                                                            <span class="n">library_key</span><span class="o">=</span><span class="s1">&#39;sample&#39;</span><span class="p">,</span>
                                                            <span class="n">library_id</span><span class="o">=</span><span class="n">library_ids</span><span class="p">,</span>
                                                            <span class="n">spatial_key</span><span class="o">=</span><span class="s1">&#39;spatial&#39;</span><span class="p">,</span>
                                                            <span class="n">cluster_key</span><span class="o">=</span><span class="s1">&#39;cell_type&#39;</span><span class="p">,</span>
                                                            <span class="n">spots</span><span class="o">=</span><span class="s1">&#39;hot&#39;</span><span class="p">,</span>
                                                            <span class="n">top</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                            <span class="n">selected_comb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                            <span class="n">restricted</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                            <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;Shannon Diversity&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Processing region: BALBc-1 at scale 64.0
2.222 per cent patches are empty
Using MoranI
Region BALBc-1 contains 687 diversity hotspots
Processing region: BALBc-2 at scale 64.0
5.542 per cent patches are empty
Using MoranI
Region BALBc-2 contains 851 diversity hotspots
Processing region: BALBc-3 at scale 64.0
7.812 per cent patches are empty
Using MoranI
Region BALBc-3 contains 712 diversity hotspots
Processing region: MRL-4 at scale 64.0
0.708 per cent patches are empty
Using MoranI
Region MRL-4 contains 480 diversity hotspots
Processing region: MRL-5 at scale 64.0
0.708 per cent patches are empty
Using MoranI
Region MRL-5 contains 443 diversity hotspots
Processing region: MRL-6 at scale 64.0
0.220 per cent patches are empty
Using MoranI
Region MRL-6 contains 326 diversity hotspots
Processing region: MRL-7 at scale 64.0
0.220 per cent patches are empty
Using MoranI
Region MRL-7 contains 499 diversity hotspots
Processing region: MRL-8 at scale 64.0
0.098 per cent patches are empty
Using MoranI
Region MRL-8 contains 331 diversity hotspots
Processing region: MRL-9 at scale 64.0
0.000 per cent patches are empty
Using MoranI
Region MRL-9 contains 348 diversity hotspots
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spot_cellfreq_df</span><span class="p">[</span><span class="s1">&#39;Condition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span>
<span class="n">spot_cellfreq_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spot_cellfreq_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;BALBc&#39;</span><span class="p">),</span> <span class="s1">&#39;Condition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;BALBc&#39;</span>
<span class="n">spot_cellfreq_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spot_cellfreq_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;MRL&#39;</span><span class="p">),</span> <span class="s1">&#39;Condition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;MRL&#39;</span>

<span class="n">spot_co_occurrence_subcols</span> <span class="o">=</span> <span class="n">spot_co_occurrence_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">spot_co_occurrence_df</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">&gt;</span><span class="mf">0.05</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">spot_co_occurrence_df</span><span class="p">[</span><span class="s1">&#39;Condition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span>
<span class="n">spot_co_occurrence_df</span><span class="p">[</span><span class="s1">&#39;Mouse&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spot_co_occurrence_df</span><span class="o">.</span><span class="n">index</span>
<span class="n">spot_co_occurrence_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spot_co_occurrence_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;BALBc&#39;</span><span class="p">),</span> <span class="s1">&#39;Condition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;BALBc&#39;</span>
<span class="n">spot_co_occurrence_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spot_co_occurrence_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;MRL&#39;</span><span class="p">),</span> <span class="s1">&#39;Condition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;MRL&#39;</span>
<span class="n">spot_co_occurrence_subcols</span><span class="o">.</span><span class="n">extend</span><span class="p">([(</span><span class="s1">&#39;Condition&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">),(</span><span class="s1">&#39;Mouse&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)])</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spot_cellfreq_df</span><span class="p">[</span><span class="s1">&#39;Mouse&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spot_cellfreq_df</span><span class="o">.</span><span class="n">index</span>

<span class="c1"># Melt the DataFrame</span>
<span class="n">spot_cellfreq_df_melt</span> <span class="o">=</span> <span class="n">spot_cellfreq_df</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">id_vars</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Mouse&#39;</span><span class="p">,</span> <span class="s1">&#39;Condition&#39;</span><span class="p">],</span> <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;CellType&#39;</span><span class="p">,</span> <span class="n">value_name</span><span class="o">=</span><span class="s1">&#39;Frequency&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">selected_cell_types</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">spot_cellfreq_df_melt</span><span class="p">[</span><span class="s1">&#39;CellType&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="n">selected_p_values</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Perform t-tests</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;p-value before correction:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">ct</span> <span class="ow">in</span> <span class="n">selected_cell_types</span><span class="p">:</span> <span class="c1"># df_melted[&#39;CellType&#39;].unique():</span>
    <span class="n">subset</span> <span class="o">=</span> <span class="n">spot_cellfreq_df_melt</span><span class="p">[</span><span class="n">spot_cellfreq_df_melt</span><span class="p">[</span><span class="s1">&#39;CellType&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ct</span><span class="p">]</span>
    <span class="n">group1</span> <span class="o">=</span> <span class="n">subset</span><span class="p">[</span><span class="n">subset</span><span class="p">[</span><span class="s1">&#39;Condition&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;BALBc&#39;</span><span class="p">][</span><span class="s1">&#39;Frequency&#39;</span><span class="p">]</span>
    <span class="n">group2</span> <span class="o">=</span> <span class="n">subset</span><span class="p">[</span><span class="n">subset</span><span class="p">[</span><span class="s1">&#39;Condition&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;MRL&#39;</span><span class="p">][</span><span class="s1">&#39;Frequency&#39;</span><span class="p">]</span>

    <span class="n">t_stat</span><span class="p">,</span> <span class="n">p_value</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">ttest_ind</span><span class="p">(</span><span class="n">group1</span><span class="p">,</span> <span class="n">group2</span><span class="p">,</span> <span class="n">equal_var</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ct</span><span class="si">}</span><span class="s2"> has p value = </span><span class="si">{</span><span class="n">p_value</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">selected_p_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_value</span><span class="p">)</span>

<span class="c1"># Filter the dataframe based on selected CellTypes</span>
<span class="n">df_filtered</span> <span class="o">=</span> <span class="n">spot_cellfreq_df_melt</span><span class="p">[</span><span class="n">spot_cellfreq_df_melt</span><span class="p">[</span><span class="s1">&#39;CellType&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">selected_cell_types</span><span class="p">)]</span>

<span class="c1"># Plot the filtered data</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df_filtered</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;CellType&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;Frequency&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;Condition&#39;</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="s1">&#39;muted&#39;</span><span class="p">,</span> <span class="n">boxprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">.3</span><span class="p">),</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">dodge</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="n">selected_cell_types</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">swarmplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df_filtered</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;CellType&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;Frequency&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;Condition&#39;</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="s1">&#39;dark:black&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">dodge</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">selected_cell_types</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="n">handles</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">labels</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Groups&quot;</span><span class="p">,</span> <span class="n">handletextpad</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">columnspacing</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">spot_pvals_corrected</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">false_discovery_control</span><span class="p">(</span><span class="n">selected_p_values</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;bh&#39;</span><span class="p">)</span>
<span class="n">spot_pvals_corrected</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="p">:</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="p">,</span> <span class="n">selected_cell_types</span><span class="p">,</span> <span class="n">spot_pvals_corrected</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">42</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;p-values after correction: &quot;</span><span class="p">)</span>

<span class="n">yrange</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ct</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">selected_cell_types</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">yrange</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;p = </span><span class="si">{</span><span class="n">spot_pvals_corrected</span><span class="p">[</span><span class="n">ct</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ct</span><span class="si">}</span><span class="s2"> in hot spots has p value = </span><span class="si">{</span><span class="n">spot_pvals_corrected</span><span class="p">[</span><span class="n">ct</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">spot_pvals_corrected</span><span class="p">[</span><span class="n">ct</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.05</span> <span class="ow">and</span> <span class="n">p_vals_corrected_dict</span><span class="p">[</span><span class="n">ct</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.05</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ct</span><span class="si">}</span><span class="s2"> in whole tissue has p value = </span><span class="si">{</span><span class="n">p_vals_corrected_dict</span><span class="p">[</span><span class="n">ct</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="o">*</span><span class="mi">42</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">selected_cell_types</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mf">0.55</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Frequency&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
p-value before correction:
B cells has p value = 0.0000
B220(+) DN T cells has p value = 0.0139
CD106(+)CD16/32(+)CD31(+) stroma has p value = 0.0097
CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma has p value = 0.0062
CD106(+)CD16/32(-)Ly6C(+)CD31(+) has p value = 0.9028
CD106(-)CD16/32(+)Ly6C(+)CD31(-) has p value = 0.0112
CD106(-)CD16/32(-)Ly6C(+)CD31(+) stroma has p value = 0.0295
CD11c(+) B cells has p value = 0.0342
CD3(+) other markers (-) has p value = 0.0460
CD31(hi) vascular has p value = 0.0861
CD4(+) T cells has p value = 0.1443
CD4(+)CD8(-)cDC has p value = 0.0067
CD4(+)MHCII(+) has p value = 0.4478
CD4(-)CD8(+)cDC has p value = 0.0015
CD4(-)CD8(-) cDC has p value = 0.1899
CD8(+) T cells has p value = 0.2234
ERTR7(+) stroma has p value = 0.2324
F4/80(+) mphs has p value = 0.0012
FDCs has p value = 0.6537
NK cells has p value = 0.2228
capsule has p value = 0.0739
erythroblasts has p value = 0.0149
granulocytes has p value = 0.0010
marginal zone mphs has p value = 0.0311
megakaryocytes has p value = 0.0195
noid has p value = 0.3912
plasma cells has p value = 0.4404
------------------------------------------
p-values after correction:
B cells in hot spots has p value = 0.000
B220(+) DN T cells in hot spots has p value = 0.040
B220(+) DN T cells in whole tissue has p value = 0.136
******************************************
CD106(+)CD16/32(+)CD31(+) stroma in hot spots has p value = 0.037
CD106(+)CD16/32(+)CD31(+) stroma in whole tissue has p value = 0.154
******************************************
CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma in hot spots has p value = 0.030
CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma in whole tissue has p value = 0.085
******************************************
CD106(+)CD16/32(-)Ly6C(+)CD31(+) in hot spots has p value = 0.903
CD106(-)CD16/32(+)Ly6C(+)CD31(-) in hot spots has p value = 0.038
CD106(-)CD16/32(-)Ly6C(+)CD31(+) stroma in hot spots has p value = 0.065
CD11c(+) B cells in hot spots has p value = 0.066
CD3(+) other markers (-) in hot spots has p value = 0.083
CD31(hi) vascular in hot spots has p value = 0.137
CD4(+) T cells in hot spots has p value = 0.216
CD4(+)CD8(-)cDC in hot spots has p value = 0.030
CD4(+)MHCII(+) in hot spots has p value = 0.484
CD4(-)CD8(+)cDC in hot spots has p value = 0.010
CD4(-)CD8(-) cDC in hot spots has p value = 0.270
CD8(+) T cells in hot spots has p value = 0.285
ERTR7(+) stroma in hot spots has p value = 0.285
F4/80(+) mphs in hot spots has p value = 0.010
FDCs in hot spots has p value = 0.679
NK cells in hot spots has p value = 0.285
capsule in hot spots has p value = 0.125
erythroblasts in hot spots has p value = 0.040
granulocytes in hot spots has p value = 0.010
marginal zone mphs in hot spots has p value = 0.065
megakaryocytes in hot spots has p value = 0.048
noid in hot spots has p value = 0.459
plasma cells in hot spots has p value = 0.484
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_tutorials_MESA_tutorial_ecospatial_murine_51_1.png" src="../../_images/notebooks_tutorials_MESA_tutorial_ecospatial_murine_51_1.png" />
</div>
</div>
</section>
<section id="Process-Cell-Co-Occurrence-Dataframe">
<h3>Process Cell Co-Occurrence Dataframe<a class="headerlink" href="#Process-Cell-Co-Occurrence-Dataframe" title="Link to this heading"></a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">union_cols</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">global_co_occurrence_subcols</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">spot_co_occurrence_subcols</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Make them have the same set of columns</span>
<span class="n">global_co_occurrence_df</span> <span class="o">=</span> <span class="n">global_co_occurrence_df</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">union_cols</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">spot_co_occurrence_df</span> <span class="o">=</span> <span class="n">spot_co_occurrence_df</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">union_cols</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Global Cell Co-Occurrence</span>
<span class="c1"># Multi-index to single-index column</span>
<span class="n">new_columns</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">global_co_occurrence_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>  <span class="c1"># This checks if the column is a MultiIndex</span>
        <span class="c1"># Join only if the column name is not &#39;Mouse&#39; or &#39;Condition&#39;</span>
        <span class="k">if</span> <span class="s2">&quot;Mouse&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">col</span> <span class="ow">and</span> <span class="s2">&quot;Condition&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">col</span><span class="p">:</span>
            <span class="n">new_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&amp;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">col</span><span class="p">))</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If &#39;Mouse&#39; or &#39;Condition&#39; is in the column, it is not joined with &#39;&amp;&#39;</span>
            <span class="n">new_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">new_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>

<span class="n">global_co_occurrence_df_single</span> <span class="o">=</span> <span class="n">global_co_occurrence_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">global_co_occurrence_df_single</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">new_columns</span>
<span class="n">global_co_occurrence_df_single</span> <span class="o">=</span> <span class="n">global_co_occurrence_df_single</span><span class="p">[[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">global_co_occurrence_df_single</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s1">&#39;noid&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">col</span><span class="p">]]</span>

<span class="c1"># Melt the DataFrame</span>
<span class="n">global_co_occurrence_melted</span> <span class="o">=</span> <span class="n">global_co_occurrence_df_single</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">id_vars</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Mouse&#39;</span><span class="p">,</span> <span class="s1">&#39;Condition&#39;</span><span class="p">],</span> <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;Cell Combination&#39;</span><span class="p">,</span> <span class="n">value_name</span><span class="o">=</span><span class="s1">&#39;Frequency&#39;</span><span class="p">)</span>
<span class="n">global_co_occurrence_melted</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Mouse</th>
      <th>Condition</th>
      <th>Cell Combination</th>
      <th>Frequency</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>BALBc-1</td>
      <td>BALBc</td>
      <td>CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma&amp;CD4(+)...</td>
      <td>0.068664</td>
    </tr>
    <tr>
      <th>1</th>
      <td>BALBc-2</td>
      <td>BALBc</td>
      <td>CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma&amp;CD4(+)...</td>
      <td>0.058930</td>
    </tr>
    <tr>
      <th>2</th>
      <td>BALBc-3</td>
      <td>BALBc</td>
      <td>CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma&amp;CD4(+)...</td>
      <td>0.052436</td>
    </tr>
    <tr>
      <th>3</th>
      <td>MRL-4</td>
      <td>MRL</td>
      <td>CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma&amp;CD4(+)...</td>
      <td>0.117777</td>
    </tr>
    <tr>
      <th>4</th>
      <td>MRL-5</td>
      <td>MRL</td>
      <td>CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma&amp;CD4(+)...</td>
      <td>0.146791</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>976</th>
      <td>MRL-5</td>
      <td>MRL</td>
      <td>CD8(+) T cells&amp;F4/80(+) mphs</td>
      <td>0.122449</td>
    </tr>
    <tr>
      <th>977</th>
      <td>MRL-6</td>
      <td>MRL</td>
      <td>CD8(+) T cells&amp;F4/80(+) mphs</td>
      <td>0.164424</td>
    </tr>
    <tr>
      <th>978</th>
      <td>MRL-7</td>
      <td>MRL</td>
      <td>CD8(+) T cells&amp;F4/80(+) mphs</td>
      <td>0.142403</td>
    </tr>
    <tr>
      <th>979</th>
      <td>MRL-8</td>
      <td>MRL</td>
      <td>CD8(+) T cells&amp;F4/80(+) mphs</td>
      <td>0.108749</td>
    </tr>
    <tr>
      <th>980</th>
      <td>MRL-9</td>
      <td>MRL</td>
      <td>CD8(+) T cells&amp;F4/80(+) mphs</td>
      <td>0.098389</td>
    </tr>
  </tbody>
</table>
<p>981 rows × 4 columns</p>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Global Cell Co-Occurrence</span>
<span class="n">selected_cell_types</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">global_co_occurrence_melted</span><span class="p">[</span><span class="s1">&#39;Cell Combination&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="n">selected_p_values</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Perform t-tests</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;p-value before correction:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">ct</span> <span class="ow">in</span> <span class="n">selected_cell_types</span><span class="p">:</span>
    <span class="n">subset</span> <span class="o">=</span> <span class="n">global_co_occurrence_melted</span><span class="p">[</span><span class="n">global_co_occurrence_melted</span><span class="p">[</span><span class="s1">&#39;Cell Combination&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ct</span><span class="p">]</span>
    <span class="n">group1</span> <span class="o">=</span> <span class="n">subset</span><span class="p">[</span><span class="n">subset</span><span class="p">[</span><span class="s1">&#39;Condition&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;BALBc&#39;</span><span class="p">][</span><span class="s1">&#39;Frequency&#39;</span><span class="p">]</span>
    <span class="n">group2</span> <span class="o">=</span> <span class="n">subset</span><span class="p">[</span><span class="n">subset</span><span class="p">[</span><span class="s1">&#39;Condition&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;MRL&#39;</span><span class="p">][</span><span class="s1">&#39;Frequency&#39;</span><span class="p">]</span>

    <span class="n">t_stat</span><span class="p">,</span> <span class="n">p_value</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">ttest_ind</span><span class="p">(</span><span class="n">group1</span><span class="p">,</span> <span class="n">group2</span><span class="p">,</span> <span class="n">equal_var</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ct</span><span class="si">}</span><span class="s2"> has p value = </span><span class="si">{</span><span class="n">p_value</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">selected_p_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_value</span><span class="p">)</span>

<span class="c1"># Filter the dataframe based on selected Cell Combinations</span>
<span class="n">df_filtered</span> <span class="o">=</span> <span class="n">global_co_occurrence_melted</span><span class="p">[</span><span class="n">global_co_occurrence_melted</span><span class="p">[</span><span class="s1">&#39;Cell Combination&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">selected_cell_types</span><span class="p">)]</span>

<span class="c1"># Plot the filtered data</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">45</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df_filtered</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;Cell Combination&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;Frequency&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;Condition&#39;</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="s1">&#39;muted&#39;</span><span class="p">,</span> <span class="n">boxprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">.3</span><span class="p">),</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">dodge</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="n">selected_cell_types</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">swarmplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df_filtered</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;Cell Combination&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;Frequency&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;Condition&#39;</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="s1">&#39;dark:black&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">dodge</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="n">selected_cell_types</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="n">handles</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">labels</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Groups&quot;</span><span class="p">,</span> <span class="n">handletextpad</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">columnspacing</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">pvals_corrected</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">false_discovery_control</span><span class="p">(</span><span class="n">selected_p_values</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;bh&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">42</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;p-values after correction:&quot;</span><span class="p">)</span>

<span class="n">p_vals_corrected_dict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">yrange</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ct</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">selected_cell_types</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">yrange</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;p = </span><span class="si">{</span><span class="n">pvals_corrected</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ct</span><span class="si">}</span><span class="s2"> has p value = </span><span class="si">{</span><span class="n">pvals_corrected</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">p_vals_corrected_dict</span><span class="p">[</span><span class="n">ct</span><span class="p">]</span> <span class="o">=</span> <span class="n">pvals_corrected</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">selected_cell_types</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mf">0.55</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Frequency&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
p-value before correction:
B cells&amp;B220(+) DN T cells has p value = 0.034
B cells&amp;CD106(+)CD16/32(+)CD31(+) stroma has p value = 0.001
B cells&amp;CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma has p value = 0.161
B cells&amp;CD106(+)CD16/32(-)Ly6C(+)CD31(+) has p value = 0.008
B cells&amp;CD106(-)CD16/32(+)Ly6C(+)CD31(-) has p value = 0.053
B cells&amp;CD3(+) other markers (-) has p value = 0.236
B cells&amp;CD4(+) T cells has p value = 0.006
B cells&amp;CD4(+)CD8(-)cDC has p value = 0.686
B cells&amp;CD4(-)CD8(+)cDC has p value = 0.003
B cells&amp;CD8(+) T cells has p value = 0.004
B cells&amp;ERTR7(+) stroma has p value = 0.033
B cells&amp;F4/80(+) mphs has p value = 0.000
B cells&amp;NK cells has p value = 0.006
B cells&amp;erythroblasts has p value = 0.031
B cells&amp;granulocytes has p value = 0.960
B cells&amp;marginal zone mphs has p value = 0.004
B cells&amp;plasma cells has p value = 0.232
B220(+) DN T cells&amp;CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma has p value = 0.041
B220(+) DN T cells&amp;CD4(+) T cells has p value = 0.031
B220(+) DN T cells&amp;CD4(+)CD8(-)cDC has p value = 0.022
B220(+) DN T cells&amp;CD4(-)CD8(+)cDC has p value = 0.002
B220(+) DN T cells&amp;CD8(+) T cells has p value = 0.031
B220(+) DN T cells&amp;ERTR7(+) stroma has p value = 0.114
B220(+) DN T cells&amp;F4/80(+) mphs has p value = 0.041
B220(+) DN T cells&amp;erythroblasts has p value = 0.024
B220(+) DN T cells&amp;granulocytes has p value = 0.037
CD106(+)CD16/32(+)CD31(+) stroma&amp;CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma has p value = 0.579
CD106(+)CD16/32(+)CD31(+) stroma&amp;CD4(+) T cells has p value = 0.004
CD106(+)CD16/32(+)CD31(+) stroma&amp;CD4(+)CD8(-)cDC has p value = 0.660
CD106(+)CD16/32(+)CD31(+) stroma&amp;CD8(+) T cells has p value = 0.005
CD106(+)CD16/32(+)CD31(+) stroma&amp;ERTR7(+) stroma has p value = 0.479
CD106(+)CD16/32(+)CD31(+) stroma&amp;F4/80(+) mphs has p value = 0.000
CD106(+)CD16/32(+)CD31(+) stroma&amp;erythroblasts has p value = 0.124
CD106(+)CD16/32(+)CD31(+) stroma&amp;granulocytes has p value = 0.035
CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma&amp;CD106(+)CD16/32(-)Ly6C(+)CD31(+) has p value = 0.231
CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma&amp;CD106(-)CD16/32(+)Ly6C(+)CD31(-) has p value = 0.007
CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma&amp;CD3(+) other markers (-) has p value = 0.009
CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma&amp;CD4(+) T cells has p value = 0.100
CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma&amp;CD4(+)CD8(-)cDC has p value = 0.005
CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma&amp;CD4(-)CD8(+)cDC has p value = 0.000
CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma&amp;CD8(+) T cells has p value = 0.077
CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma&amp;ERTR7(+) stroma has p value = 0.242
CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma&amp;F4/80(+) mphs has p value = 0.142
CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma&amp;NK cells has p value = 0.718
CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma&amp;erythroblasts has p value = 0.009
CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma&amp;granulocytes has p value = 0.001
CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma&amp;plasma cells has p value = 0.097
CD106(+)CD16/32(-)Ly6C(+)CD31(+)&amp;CD4(+) T cells has p value = 0.002
CD106(+)CD16/32(-)Ly6C(+)CD31(+)&amp;CD4(+)CD8(-)cDC has p value = 0.168
CD106(+)CD16/32(-)Ly6C(+)CD31(+)&amp;CD8(+) T cells has p value = 0.011
CD106(+)CD16/32(-)Ly6C(+)CD31(+)&amp;ERTR7(+) stroma has p value = 0.826
CD106(+)CD16/32(-)Ly6C(+)CD31(+)&amp;F4/80(+) mphs has p value = 0.000
CD106(+)CD16/32(-)Ly6C(+)CD31(+)&amp;erythroblasts has p value = 0.184
CD106(+)CD16/32(-)Ly6C(+)CD31(+)&amp;granulocytes has p value = 0.582
CD106(-)CD16/32(+)Ly6C(+)CD31(-)&amp;CD4(+) T cells has p value = 0.004
CD106(-)CD16/32(+)Ly6C(+)CD31(-)&amp;CD4(+)CD8(-)cDC has p value = 0.003
CD106(-)CD16/32(+)Ly6C(+)CD31(-)&amp;CD8(+) T cells has p value = 0.001
CD106(-)CD16/32(+)Ly6C(+)CD31(-)&amp;ERTR7(+) stroma has p value = 0.049
CD106(-)CD16/32(+)Ly6C(+)CD31(-)&amp;F4/80(+) mphs has p value = 0.003
CD106(-)CD16/32(+)Ly6C(+)CD31(-)&amp;erythroblasts has p value = 0.000
CD106(-)CD16/32(+)Ly6C(+)CD31(-)&amp;granulocytes has p value = 0.000
CD3(+) other markers (-)&amp;CD4(+) T cells has p value = 0.017
CD3(+) other markers (-)&amp;CD8(+) T cells has p value = 0.018
CD3(+) other markers (-)&amp;F4/80(+) mphs has p value = 0.140
CD3(+) other markers (-)&amp;erythroblasts has p value = 0.004
CD3(+) other markers (-)&amp;granulocytes has p value = 0.002
CD4(+) T cells&amp;CD4(+)CD8(-)cDC has p value = 0.004
CD4(+) T cells&amp;CD4(-)CD8(+)cDC has p value = 0.000
CD4(+) T cells&amp;CD4(-)CD8(-) cDC has p value = 0.154
CD4(+) T cells&amp;CD8(+) T cells has p value = 0.344
CD4(+) T cells&amp;ERTR7(+) stroma has p value = 0.501
CD4(+) T cells&amp;F4/80(+) mphs has p value = 0.003
CD4(+) T cells&amp;NK cells has p value = 0.004
CD4(+) T cells&amp;erythroblasts has p value = 0.211
CD4(+) T cells&amp;granulocytes has p value = 0.036
CD4(+) T cells&amp;marginal zone mphs has p value = 0.008
CD4(+) T cells&amp;plasma cells has p value = 0.120
CD4(+)CD8(-)cDC&amp;CD4(-)CD8(+)cDC has p value = 0.000
CD4(+)CD8(-)cDC&amp;CD8(+) T cells has p value = 0.002
CD4(+)CD8(-)cDC&amp;ERTR7(+) stroma has p value = 0.057
CD4(+)CD8(-)cDC&amp;F4/80(+) mphs has p value = 0.549
CD4(+)CD8(-)cDC&amp;NK cells has p value = 0.106
CD4(+)CD8(-)cDC&amp;erythroblasts has p value = 0.004
CD4(+)CD8(-)cDC&amp;granulocytes has p value = 0.002
CD4(+)CD8(-)cDC&amp;plasma cells has p value = 0.056
CD4(-)CD8(+)cDC&amp;CD8(+) T cells has p value = 0.000
CD4(-)CD8(+)cDC&amp;ERTR7(+) stroma has p value = 0.002
CD4(-)CD8(+)cDC&amp;F4/80(+) mphs has p value = 0.003
CD4(-)CD8(+)cDC&amp;erythroblasts has p value = 0.000
CD4(-)CD8(+)cDC&amp;granulocytes has p value = 0.000
CD8(+) T cells&amp;ERTR7(+) stroma has p value = 0.334
CD8(+) T cells&amp;F4/80(+) mphs has p value = 0.021
CD8(+) T cells&amp;NK cells has p value = 0.016
CD8(+) T cells&amp;erythroblasts has p value = 0.208
CD8(+) T cells&amp;granulocytes has p value = 0.017
CD8(+) T cells&amp;plasma cells has p value = 0.148
ERTR7(+) stroma&amp;F4/80(+) mphs has p value = 0.011
ERTR7(+) stroma&amp;NK cells has p value = 0.580
ERTR7(+) stroma&amp;erythroblasts has p value = 0.568
ERTR7(+) stroma&amp;granulocytes has p value = 0.036
ERTR7(+) stroma&amp;plasma cells has p value = 0.519
F4/80(+) mphs&amp;NK cells has p value = 0.002
F4/80(+) mphs&amp;erythroblasts has p value = 0.007
F4/80(+) mphs&amp;granulocytes has p value = 0.555
F4/80(+) mphs&amp;plasma cells has p value = 0.003
NK cells&amp;erythroblasts has p value = 0.578
NK cells&amp;granulocytes has p value = 0.116
erythroblasts&amp;granulocytes has p value = 0.000
erythroblasts&amp;plasma cells has p value = 0.581
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/var/folders/7g/phdhh_ld3dlbnrst0t60bwzr0000gn/T/ipykernel_61050/3825649457.py:22: FutureWarning: Use &#34;auto&#34; to set automatic grayscale colors. From v0.14.0, &#34;gray&#34; will default to matplotlib&#39;s definition.
  sns.swarmplot(data=df_filtered, x=&#39;Cell Combination&#39;, y=&#39;Frequency&#39;, hue=&#39;Condition&#39;, palette=&#39;dark:black&#39;, size=1.0, dodge=True,order=selected_cell_types, ax=ax, edgecolor=&#39;gray&#39;, linewidth=0.5)
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
------------------------------------------
p-values after correction:
B cells&amp;B220(+) DN T cells has p value = 0.062
B cells&amp;CD106(+)CD16/32(+)CD31(+) stroma has p value = 0.010
B cells&amp;CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma has p value = 0.212
B cells&amp;CD106(+)CD16/32(-)Ly6C(+)CD31(+) has p value = 0.019
B cells&amp;CD106(-)CD16/32(+)Ly6C(+)CD31(-) has p value = 0.085
B cells&amp;CD3(+) other markers (-) has p value = 0.286
B cells&amp;CD4(+) T cells has p value = 0.016
B cells&amp;CD4(+)CD8(-)cDC has p value = 0.706
B cells&amp;CD4(-)CD8(+)cDC has p value = 0.013
B cells&amp;CD8(+) T cells has p value = 0.014
B cells&amp;ERTR7(+) stroma has p value = 0.061
B cells&amp;F4/80(+) mphs has p value = 0.001
B cells&amp;NK cells has p value = 0.016
B cells&amp;erythroblasts has p value = 0.059
B cells&amp;granulocytes has p value = 0.960
B cells&amp;marginal zone mphs has p value = 0.013
B cells&amp;plasma cells has p value = 0.285
B220(+) DN T cells&amp;CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma has p value = 0.068
B220(+) DN T cells&amp;CD4(+) T cells has p value = 0.059
B220(+) DN T cells&amp;CD4(+)CD8(-)cDC has p value = 0.045
B220(+) DN T cells&amp;CD4(-)CD8(+)cDC has p value = 0.011
B220(+) DN T cells&amp;CD8(+) T cells has p value = 0.059
B220(+) DN T cells&amp;ERTR7(+) stroma has p value = 0.165
B220(+) DN T cells&amp;F4/80(+) mphs has p value = 0.068
B220(+) DN T cells&amp;erythroblasts has p value = 0.048
B220(+) DN T cells&amp;granulocytes has p value = 0.063
CD106(+)CD16/32(+)CD31(+) stroma&amp;CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma has p value = 0.610
CD106(+)CD16/32(+)CD31(+) stroma&amp;CD4(+) T cells has p value = 0.013
CD106(+)CD16/32(+)CD31(+) stroma&amp;CD4(+)CD8(-)cDC has p value = 0.685
CD106(+)CD16/32(+)CD31(+) stroma&amp;CD8(+) T cells has p value = 0.015
CD106(+)CD16/32(+)CD31(+) stroma&amp;ERTR7(+) stroma has p value = 0.556
CD106(+)CD16/32(+)CD31(+) stroma&amp;F4/80(+) mphs has p value = 0.001
CD106(+)CD16/32(+)CD31(+) stroma&amp;erythroblasts has p value = 0.173
CD106(+)CD16/32(+)CD31(+) stroma&amp;granulocytes has p value = 0.062
CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma&amp;CD106(+)CD16/32(-)Ly6C(+)CD31(+) has p value = 0.285
CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma&amp;CD106(-)CD16/32(+)Ly6C(+)CD31(-) has p value = 0.018
CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma&amp;CD3(+) other markers (-) has p value = 0.021
CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma&amp;CD4(+) T cells has p value = 0.149
CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma&amp;CD4(+)CD8(-)cDC has p value = 0.016
CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma&amp;CD4(-)CD8(+)cDC has p value = 0.001
CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma&amp;CD8(+) T cells has p value = 0.118
CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma&amp;ERTR7(+) stroma has p value = 0.290
CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma&amp;F4/80(+) mphs has p value = 0.193
CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma&amp;NK cells has p value = 0.731
CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma&amp;erythroblasts has p value = 0.021
CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma&amp;granulocytes has p value = 0.007
CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma&amp;plasma cells has p value = 0.146
CD106(+)CD16/32(-)Ly6C(+)CD31(+)&amp;CD4(+) T cells has p value = 0.010
CD106(+)CD16/32(-)Ly6C(+)CD31(+)&amp;CD4(+)CD8(-)cDC has p value = 0.218
CD106(+)CD16/32(-)Ly6C(+)CD31(+)&amp;CD8(+) T cells has p value = 0.025
CD106(+)CD16/32(-)Ly6C(+)CD31(+)&amp;ERTR7(+) stroma has p value = 0.834
CD106(+)CD16/32(-)Ly6C(+)CD31(+)&amp;F4/80(+) mphs has p value = 0.001
CD106(+)CD16/32(-)Ly6C(+)CD31(+)&amp;erythroblasts has p value = 0.236
CD106(+)CD16/32(-)Ly6C(+)CD31(+)&amp;granulocytes has p value = 0.610
CD106(-)CD16/32(+)Ly6C(+)CD31(-)&amp;CD4(+) T cells has p value = 0.014
CD106(-)CD16/32(+)Ly6C(+)CD31(-)&amp;CD4(+)CD8(-)cDC has p value = 0.013
CD106(-)CD16/32(+)Ly6C(+)CD31(-)&amp;CD8(+) T cells has p value = 0.008
CD106(-)CD16/32(+)Ly6C(+)CD31(-)&amp;ERTR7(+) stroma has p value = 0.079
CD106(-)CD16/32(+)Ly6C(+)CD31(-)&amp;F4/80(+) mphs has p value = 0.013
CD106(-)CD16/32(+)Ly6C(+)CD31(-)&amp;erythroblasts has p value = 0.001
CD106(-)CD16/32(+)Ly6C(+)CD31(-)&amp;granulocytes has p value = 0.000
CD3(+) other markers (-)&amp;CD4(+) T cells has p value = 0.036
CD3(+) other markers (-)&amp;CD8(+) T cells has p value = 0.038
CD3(+) other markers (-)&amp;F4/80(+) mphs has p value = 0.193
CD3(+) other markers (-)&amp;erythroblasts has p value = 0.013
CD3(+) other markers (-)&amp;granulocytes has p value = 0.012
CD4(+) T cells&amp;CD4(+)CD8(-)cDC has p value = 0.013
CD4(+) T cells&amp;CD4(-)CD8(+)cDC has p value = 0.000
CD4(+) T cells&amp;CD4(-)CD8(-) cDC has p value = 0.204
CD4(+) T cells&amp;CD8(+) T cells has p value = 0.403
CD4(+) T cells&amp;ERTR7(+) stroma has p value = 0.575
CD4(+) T cells&amp;F4/80(+) mphs has p value = 0.013
CD4(+) T cells&amp;NK cells has p value = 0.013
CD4(+) T cells&amp;erythroblasts has p value = 0.265
CD4(+) T cells&amp;granulocytes has p value = 0.062
CD4(+) T cells&amp;marginal zone mphs has p value = 0.019
CD4(+) T cells&amp;plasma cells has p value = 0.169
CD4(+)CD8(-)cDC&amp;CD4(-)CD8(+)cDC has p value = 0.001
CD4(+)CD8(-)cDC&amp;CD8(+) T cells has p value = 0.010
CD4(+)CD8(-)cDC&amp;ERTR7(+) stroma has p value = 0.088
CD4(+)CD8(-)cDC&amp;F4/80(+) mphs has p value = 0.610
CD4(+)CD8(-)cDC&amp;NK cells has p value = 0.156
CD4(+)CD8(-)cDC&amp;erythroblasts has p value = 0.014
CD4(+)CD8(-)cDC&amp;granulocytes has p value = 0.012
CD4(+)CD8(-)cDC&amp;plasma cells has p value = 0.088
CD4(-)CD8(+)cDC&amp;CD8(+) T cells has p value = 0.000
CD4(-)CD8(+)cDC&amp;ERTR7(+) stroma has p value = 0.010
CD4(-)CD8(+)cDC&amp;F4/80(+) mphs has p value = 0.013
CD4(-)CD8(+)cDC&amp;erythroblasts has p value = 0.001
CD4(-)CD8(+)cDC&amp;granulocytes has p value = 0.001
CD8(+) T cells&amp;ERTR7(+) stroma has p value = 0.396
CD8(+) T cells&amp;F4/80(+) mphs has p value = 0.043
CD8(+) T cells&amp;NK cells has p value = 0.036
CD8(+) T cells&amp;erythroblasts has p value = 0.263
CD8(+) T cells&amp;granulocytes has p value = 0.036
CD8(+) T cells&amp;plasma cells has p value = 0.199
ERTR7(+) stroma&amp;F4/80(+) mphs has p value = 0.025
ERTR7(+) stroma&amp;NK cells has p value = 0.610
ERTR7(+) stroma&amp;erythroblasts has p value = 0.610
ERTR7(+) stroma&amp;granulocytes has p value = 0.062
ERTR7(+) stroma&amp;plasma cells has p value = 0.589
F4/80(+) mphs&amp;NK cells has p value = 0.012
F4/80(+) mphs&amp;erythroblasts has p value = 0.019
F4/80(+) mphs&amp;granulocytes has p value = 0.610
F4/80(+) mphs&amp;plasma cells has p value = 0.013
NK cells&amp;erythroblasts has p value = 0.610
NK cells&amp;granulocytes has p value = 0.166
erythroblasts&amp;granulocytes has p value = 0.001
erythroblasts&amp;plasma cells has p value = 0.610
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_tutorials_MESA_tutorial_ecospatial_murine_56_3.png" src="../../_images/notebooks_tutorials_MESA_tutorial_ecospatial_murine_56_3.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Spot Cell Co-Occurrence</span>
<span class="c1"># Multi-index to single-index column</span>
<span class="n">new_columns</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">spot_co_occurrence_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>  <span class="c1"># This checks if the column is a MultiIndex</span>
        <span class="c1"># Join only if the column name is not &#39;Mouse&#39; or &#39;Condition&#39;</span>
        <span class="k">if</span> <span class="s2">&quot;Mouse&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">col</span> <span class="ow">and</span> <span class="s2">&quot;Condition&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">col</span><span class="p">:</span>
            <span class="n">new_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&amp;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">col</span><span class="p">))</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If &#39;Mouse&#39; or &#39;Condition&#39; is in the column, it is not joined with &#39;&amp;&#39;</span>
            <span class="n">new_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">new_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>

<span class="n">spot_co_occurrence_df_single</span> <span class="o">=</span> <span class="n">spot_co_occurrence_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">spot_co_occurrence_df_single</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">new_columns</span>
<span class="n">spot_co_occurrence_df_single</span> <span class="o">=</span> <span class="n">spot_co_occurrence_df_single</span><span class="p">[[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">spot_co_occurrence_df_single</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s1">&#39;noid&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">col</span><span class="p">]]</span>

<span class="c1"># Melt the DataFrame</span>
<span class="n">spot_co_occurrence_melted</span> <span class="o">=</span> <span class="n">spot_co_occurrence_df_single</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">id_vars</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Mouse&#39;</span><span class="p">,</span> <span class="s1">&#39;Condition&#39;</span><span class="p">],</span> <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;Cell Combination&#39;</span><span class="p">,</span> <span class="n">value_name</span><span class="o">=</span><span class="s1">&#39;Frequency&#39;</span><span class="p">)</span>
<span class="n">spot_co_occurrence_melted</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Mouse</th>
      <th>Condition</th>
      <th>Cell Combination</th>
      <th>Frequency</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>BALBc-1</td>
      <td>BALBc</td>
      <td>CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma&amp;CD4(+)...</td>
      <td>0.136827</td>
    </tr>
    <tr>
      <th>1</th>
      <td>BALBc-2</td>
      <td>BALBc</td>
      <td>CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma&amp;CD4(+)...</td>
      <td>0.106933</td>
    </tr>
    <tr>
      <th>2</th>
      <td>BALBc-3</td>
      <td>BALBc</td>
      <td>CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma&amp;CD4(+)...</td>
      <td>0.120787</td>
    </tr>
    <tr>
      <th>3</th>
      <td>MRL-4</td>
      <td>MRL</td>
      <td>CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma&amp;CD4(+)...</td>
      <td>0.306250</td>
    </tr>
    <tr>
      <th>4</th>
      <td>MRL-5</td>
      <td>MRL</td>
      <td>CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma&amp;CD4(+)...</td>
      <td>0.444695</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>976</th>
      <td>MRL-5</td>
      <td>MRL</td>
      <td>CD8(+) T cells&amp;F4/80(+) mphs</td>
      <td>0.232506</td>
    </tr>
    <tr>
      <th>977</th>
      <td>MRL-6</td>
      <td>MRL</td>
      <td>CD8(+) T cells&amp;F4/80(+) mphs</td>
      <td>0.371166</td>
    </tr>
    <tr>
      <th>978</th>
      <td>MRL-7</td>
      <td>MRL</td>
      <td>CD8(+) T cells&amp;F4/80(+) mphs</td>
      <td>0.354709</td>
    </tr>
    <tr>
      <th>979</th>
      <td>MRL-8</td>
      <td>MRL</td>
      <td>CD8(+) T cells&amp;F4/80(+) mphs</td>
      <td>0.205438</td>
    </tr>
    <tr>
      <th>980</th>
      <td>MRL-9</td>
      <td>MRL</td>
      <td>CD8(+) T cells&amp;F4/80(+) mphs</td>
      <td>0.201149</td>
    </tr>
  </tbody>
</table>
<p>981 rows × 4 columns</p>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Spot Cell Co-Occurrence</span>
<span class="n">selected_cell_types</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">spot_co_occurrence_melted</span><span class="p">[</span><span class="s1">&#39;Cell Combination&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="n">selected_p_values</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Perform t-tests</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;p-value before correction: &quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">ct</span> <span class="ow">in</span> <span class="n">selected_cell_types</span><span class="p">:</span> <span class="c1"># df_melted[&#39;CellType&#39;].unique():</span>
    <span class="n">subset</span> <span class="o">=</span> <span class="n">spot_co_occurrence_melted</span><span class="p">[</span><span class="n">spot_co_occurrence_melted</span><span class="p">[</span><span class="s1">&#39;Cell Combination&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ct</span><span class="p">]</span>
    <span class="n">group1</span> <span class="o">=</span> <span class="n">subset</span><span class="p">[</span><span class="n">subset</span><span class="p">[</span><span class="s1">&#39;Condition&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;BALBc&#39;</span><span class="p">][</span><span class="s1">&#39;Frequency&#39;</span><span class="p">]</span>
    <span class="n">group2</span> <span class="o">=</span> <span class="n">subset</span><span class="p">[</span><span class="n">subset</span><span class="p">[</span><span class="s1">&#39;Condition&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;MRL&#39;</span><span class="p">][</span><span class="s1">&#39;Frequency&#39;</span><span class="p">]</span>

    <span class="n">t_stat</span><span class="p">,</span> <span class="n">p_value</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">ttest_ind</span><span class="p">(</span><span class="n">group1</span><span class="p">,</span> <span class="n">group2</span><span class="p">,</span> <span class="n">equal_var</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ct</span><span class="si">}</span><span class="s2"> has p value = </span><span class="si">{</span><span class="n">p_value</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">selected_p_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_value</span><span class="p">)</span>

<span class="c1"># Filter the dataframe based on selected CellTypes</span>
<span class="n">df_filtered</span> <span class="o">=</span> <span class="n">spot_co_occurrence_melted</span><span class="p">[</span><span class="n">spot_co_occurrence_melted</span><span class="p">[</span><span class="s1">&#39;Cell Combination&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">selected_cell_types</span><span class="p">)]</span>

<span class="c1"># Plot the filtered data</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">42</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df_filtered</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;Cell Combination&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;Frequency&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;Condition&#39;</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="s1">&#39;muted&#39;</span><span class="p">,</span> <span class="n">boxprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">.3</span><span class="p">),</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">dodge</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="n">selected_cell_types</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">swarmplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df_filtered</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;Cell Combination&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;Frequency&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;Condition&#39;</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="s1">&#39;dark:black&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">dodge</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="n">selected_cell_types</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="n">handles</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">labels</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Groups&quot;</span><span class="p">,</span> <span class="n">handletextpad</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">columnspacing</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">hot_pvals_corrected</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">false_discovery_control</span><span class="p">(</span><span class="n">selected_p_values</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;bh&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">42</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;p-values after correction:&quot;</span><span class="p">)</span>

<span class="n">highlighted_comb</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">yrange</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ct</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">selected_cell_types</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">yrange</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;p = </span><span class="si">{</span><span class="n">pvals_corrected</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ct</span><span class="si">}</span><span class="s2"> in hot spots has p value = </span><span class="si">{</span><span class="n">hot_pvals_corrected</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">hot_pvals_corrected</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.05</span> <span class="ow">and</span> <span class="n">p_vals_corrected_dict</span><span class="p">[</span><span class="n">ct</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">0.05</span><span class="p">:</span>
        <span class="n">highlighted_comb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">strip</span><span class="p">,</span> <span class="n">ct</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&amp;&#39;</span><span class="p">))))</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ct</span><span class="si">}</span><span class="s2"> in whole tissue has p value = </span><span class="si">{</span><span class="n">p_vals_corrected_dict</span><span class="p">[</span><span class="n">ct</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="o">*</span><span class="mi">42</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">selected_cell_types</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mf">0.55</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Frequency&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
p-value before correction:
B cells&amp;B220(+) DN T cells has p value = 0.004
B cells&amp;CD106(+)CD16/32(+)CD31(+) stroma has p value = 0.000
B cells&amp;CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma has p value = 0.252
B cells&amp;CD106(+)CD16/32(-)Ly6C(+)CD31(+) has p value = 0.008
B cells&amp;CD106(-)CD16/32(+)Ly6C(+)CD31(-) has p value = 0.093
B cells&amp;CD3(+) other markers (-) has p value = 0.390
B cells&amp;CD4(+) T cells has p value = 0.006
B cells&amp;CD4(+)CD8(-)cDC has p value = 0.408
B cells&amp;CD4(-)CD8(+)cDC has p value = 0.007
B cells&amp;CD8(+) T cells has p value = 0.016
B cells&amp;ERTR7(+) stroma has p value = 0.027
B cells&amp;F4/80(+) mphs has p value = 0.000
B cells&amp;NK cells has p value = 0.010
B cells&amp;erythroblasts has p value = 0.004
B cells&amp;granulocytes has p value = 0.679
B cells&amp;marginal zone mphs has p value = 0.024
B cells&amp;plasma cells has p value = 0.314
B220(+) DN T cells&amp;CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma has p value = 0.010
B220(+) DN T cells&amp;CD4(+) T cells has p value = 0.002
B220(+) DN T cells&amp;CD4(+)CD8(-)cDC has p value = 0.002
B220(+) DN T cells&amp;CD4(-)CD8(+)cDC has p value = 0.000
B220(+) DN T cells&amp;CD8(+) T cells has p value = 0.001
B220(+) DN T cells&amp;ERTR7(+) stroma has p value = 0.043
B220(+) DN T cells&amp;F4/80(+) mphs has p value = 0.025
B220(+) DN T cells&amp;erythroblasts has p value = 0.010
B220(+) DN T cells&amp;granulocytes has p value = 0.010
CD106(+)CD16/32(+)CD31(+) stroma&amp;CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma has p value = 0.632
CD106(+)CD16/32(+)CD31(+) stroma&amp;CD4(+) T cells has p value = 0.006
CD106(+)CD16/32(+)CD31(+) stroma&amp;CD4(+)CD8(-)cDC has p value = 0.240
CD106(+)CD16/32(+)CD31(+) stroma&amp;CD8(+) T cells has p value = 0.005
CD106(+)CD16/32(+)CD31(+) stroma&amp;ERTR7(+) stroma has p value = 0.721
CD106(+)CD16/32(+)CD31(+) stroma&amp;F4/80(+) mphs has p value = 0.000
CD106(+)CD16/32(+)CD31(+) stroma&amp;erythroblasts has p value = 0.021
CD106(+)CD16/32(+)CD31(+) stroma&amp;granulocytes has p value = 0.329
CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma&amp;CD106(+)CD16/32(-)Ly6C(+)CD31(+) has p value = 0.966
CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma&amp;CD106(-)CD16/32(+)Ly6C(+)CD31(-) has p value = 0.014
CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma&amp;CD3(+) other markers (-) has p value = 0.019
CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma&amp;CD4(+) T cells has p value = 0.000
CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma&amp;CD4(+)CD8(-)cDC has p value = 0.001
CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma&amp;CD4(-)CD8(+)cDC has p value = 0.000
CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma&amp;CD8(+) T cells has p value = 0.000
CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma&amp;ERTR7(+) stroma has p value = 0.065
CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma&amp;F4/80(+) mphs has p value = 0.060
CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma&amp;NK cells has p value = 0.292
CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma&amp;erythroblasts has p value = 0.014
CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma&amp;granulocytes has p value = 0.004
CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma&amp;plasma cells has p value = 0.193
CD106(+)CD16/32(-)Ly6C(+)CD31(+)&amp;CD4(+) T cells has p value = 0.012
CD106(+)CD16/32(-)Ly6C(+)CD31(+)&amp;CD4(+)CD8(-)cDC has p value = 0.154
CD106(+)CD16/32(-)Ly6C(+)CD31(+)&amp;CD8(+) T cells has p value = 0.091
CD106(+)CD16/32(-)Ly6C(+)CD31(+)&amp;ERTR7(+) stroma has p value = 0.596
CD106(+)CD16/32(-)Ly6C(+)CD31(+)&amp;F4/80(+) mphs has p value = 0.014
CD106(+)CD16/32(-)Ly6C(+)CD31(+)&amp;erythroblasts has p value = 0.260
CD106(+)CD16/32(-)Ly6C(+)CD31(+)&amp;granulocytes has p value = 0.149
CD106(-)CD16/32(+)Ly6C(+)CD31(-)&amp;CD4(+) T cells has p value = 0.014
CD106(-)CD16/32(+)Ly6C(+)CD31(-)&amp;CD4(+)CD8(-)cDC has p value = 0.002
CD106(-)CD16/32(+)Ly6C(+)CD31(-)&amp;CD8(+) T cells has p value = 0.005
CD106(-)CD16/32(+)Ly6C(+)CD31(-)&amp;ERTR7(+) stroma has p value = 0.059
CD106(-)CD16/32(+)Ly6C(+)CD31(-)&amp;F4/80(+) mphs has p value = 0.025
CD106(-)CD16/32(+)Ly6C(+)CD31(-)&amp;erythroblasts has p value = 0.012
CD106(-)CD16/32(+)Ly6C(+)CD31(-)&amp;granulocytes has p value = 0.006
CD3(+) other markers (-)&amp;CD4(+) T cells has p value = 0.112
CD3(+) other markers (-)&amp;CD8(+) T cells has p value = 0.106
CD3(+) other markers (-)&amp;F4/80(+) mphs has p value = 0.393
CD3(+) other markers (-)&amp;erythroblasts has p value = 0.041
CD3(+) other markers (-)&amp;granulocytes has p value = 0.029
CD4(+) T cells&amp;CD4(+)CD8(-)cDC has p value = 0.003
CD4(+) T cells&amp;CD4(-)CD8(+)cDC has p value = 0.001
CD4(+) T cells&amp;CD4(-)CD8(-) cDC has p value = 0.216
CD4(+) T cells&amp;CD8(+) T cells has p value = 0.954
CD4(+) T cells&amp;ERTR7(+) stroma has p value = 0.038
CD4(+) T cells&amp;F4/80(+) mphs has p value = 0.000
CD4(+) T cells&amp;NK cells has p value = 0.019
CD4(+) T cells&amp;erythroblasts has p value = 0.677
CD4(+) T cells&amp;granulocytes has p value = 0.009
CD4(+) T cells&amp;marginal zone mphs has p value = 0.043
CD4(+) T cells&amp;plasma cells has p value = 0.239
CD4(+)CD8(-)cDC&amp;CD4(-)CD8(+)cDC has p value = 0.006
CD4(+)CD8(-)cDC&amp;CD8(+) T cells has p value = 0.008
CD4(+)CD8(-)cDC&amp;ERTR7(+) stroma has p value = 0.003
CD4(+)CD8(-)cDC&amp;F4/80(+) mphs has p value = 0.448
CD4(+)CD8(-)cDC&amp;NK cells has p value = 0.048
CD4(+)CD8(-)cDC&amp;erythroblasts has p value = 0.011
CD4(+)CD8(-)cDC&amp;granulocytes has p value = 0.001
CD4(+)CD8(-)cDC&amp;plasma cells has p value = 0.156
CD4(-)CD8(+)cDC&amp;CD8(+) T cells has p value = 0.000
CD4(-)CD8(+)cDC&amp;ERTR7(+) stroma has p value = 0.000
CD4(-)CD8(+)cDC&amp;F4/80(+) mphs has p value = 0.010
CD4(-)CD8(+)cDC&amp;erythroblasts has p value = 0.000
CD4(-)CD8(+)cDC&amp;granulocytes has p value = 0.001
CD8(+) T cells&amp;ERTR7(+) stroma has p value = 0.015
CD8(+) T cells&amp;F4/80(+) mphs has p value = 0.005
CD8(+) T cells&amp;NK cells has p value = 0.153
CD8(+) T cells&amp;erythroblasts has p value = 0.899
CD8(+) T cells&amp;granulocytes has p value = 0.007
CD8(+) T cells&amp;plasma cells has p value = 0.259
ERTR7(+) stroma&amp;F4/80(+) mphs has p value = 0.035
ERTR7(+) stroma&amp;NK cells has p value = 0.829
ERTR7(+) stroma&amp;erythroblasts has p value = 0.350
ERTR7(+) stroma&amp;granulocytes has p value = 0.018
ERTR7(+) stroma&amp;plasma cells has p value = 0.293
F4/80(+) mphs&amp;NK cells has p value = 0.001
F4/80(+) mphs&amp;erythroblasts has p value = 0.001
F4/80(+) mphs&amp;granulocytes has p value = 0.475
F4/80(+) mphs&amp;plasma cells has p value = 0.002
NK cells&amp;erythroblasts has p value = 0.118
NK cells&amp;granulocytes has p value = 0.234
erythroblasts&amp;granulocytes has p value = 0.003
erythroblasts&amp;plasma cells has p value = 0.686
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/var/folders/7g/phdhh_ld3dlbnrst0t60bwzr0000gn/T/ipykernel_61050/1275659436.py:22: FutureWarning: Use &#34;auto&#34; to set automatic grayscale colors. From v0.14.0, &#34;gray&#34; will default to matplotlib&#39;s definition.
  sns.swarmplot(data=df_filtered, x=&#39;Cell Combination&#39;, y=&#39;Frequency&#39;, hue=&#39;Condition&#39;, palette=&#39;dark:black&#39;, size=2.0, dodge=True,order=selected_cell_types, ax=ax, edgecolor=&#39;gray&#39;, linewidth=0.5)
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
------------------------------------------
p-values after correction:
B cells&amp;B220(+) DN T cells in hot spots has p value = 0.015
B cells&amp;B220(+) DN T cells in whole tissue has p value = 0.062
******************************************
B cells&amp;CD106(+)CD16/32(+)CD31(+) stroma in hot spots has p value = 0.002
B cells&amp;CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma in hot spots has p value = 0.316
B cells&amp;CD106(+)CD16/32(-)Ly6C(+)CD31(+) in hot spots has p value = 0.022
B cells&amp;CD106(-)CD16/32(+)Ly6C(+)CD31(-) in hot spots has p value = 0.137
B cells&amp;CD3(+) other markers (-) in hot spots has p value = 0.446
B cells&amp;CD4(+) T cells in hot spots has p value = 0.019
B cells&amp;CD4(+)CD8(-)cDC in hot spots has p value = 0.458
B cells&amp;CD4(-)CD8(+)cDC in hot spots has p value = 0.021
B cells&amp;CD8(+) T cells in hot spots has p value = 0.033
B cells&amp;ERTR7(+) stroma in hot spots has p value = 0.047
B cells&amp;ERTR7(+) stroma in whole tissue has p value = 0.061
******************************************
B cells&amp;F4/80(+) mphs in hot spots has p value = 0.002
B cells&amp;NK cells in hot spots has p value = 0.025
B cells&amp;erythroblasts in hot spots has p value = 0.015
B cells&amp;erythroblasts in whole tissue has p value = 0.059
******************************************
B cells&amp;granulocytes in hot spots has p value = 0.718
B cells&amp;marginal zone mphs in hot spots has p value = 0.045
B cells&amp;plasma cells in hot spots has p value = 0.372
B220(+) DN T cells&amp;CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma in hot spots has p value = 0.025
B220(+) DN T cells&amp;CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma in whole tissue has p value = 0.068
******************************************
B220(+) DN T cells&amp;CD4(+) T cells in hot spots has p value = 0.010
B220(+) DN T cells&amp;CD4(+) T cells in whole tissue has p value = 0.059
******************************************
B220(+) DN T cells&amp;CD4(+)CD8(-)cDC in hot spots has p value = 0.010
B220(+) DN T cells&amp;CD4(-)CD8(+)cDC in hot spots has p value = 0.003
B220(+) DN T cells&amp;CD8(+) T cells in hot spots has p value = 0.005
B220(+) DN T cells&amp;CD8(+) T cells in whole tissue has p value = 0.059
******************************************
B220(+) DN T cells&amp;ERTR7(+) stroma in hot spots has p value = 0.069
B220(+) DN T cells&amp;F4/80(+) mphs in hot spots has p value = 0.045
B220(+) DN T cells&amp;F4/80(+) mphs in whole tissue has p value = 0.068
******************************************
B220(+) DN T cells&amp;erythroblasts in hot spots has p value = 0.025
B220(+) DN T cells&amp;granulocytes in hot spots has p value = 0.025
B220(+) DN T cells&amp;granulocytes in whole tissue has p value = 0.063
******************************************
CD106(+)CD16/32(+)CD31(+) stroma&amp;CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma in hot spots has p value = 0.682
CD106(+)CD16/32(+)CD31(+) stroma&amp;CD4(+) T cells in hot spots has p value = 0.019
CD106(+)CD16/32(+)CD31(+) stroma&amp;CD4(+)CD8(-)cDC in hot spots has p value = 0.304
CD106(+)CD16/32(+)CD31(+) stroma&amp;CD8(+) T cells in hot spots has p value = 0.018
CD106(+)CD16/32(+)CD31(+) stroma&amp;ERTR7(+) stroma in hot spots has p value = 0.748
CD106(+)CD16/32(+)CD31(+) stroma&amp;F4/80(+) mphs in hot spots has p value = 0.002
CD106(+)CD16/32(+)CD31(+) stroma&amp;erythroblasts in hot spots has p value = 0.039
CD106(+)CD16/32(+)CD31(+) stroma&amp;erythroblasts in whole tissue has p value = 0.173
******************************************
CD106(+)CD16/32(+)CD31(+) stroma&amp;granulocytes in hot spots has p value = 0.386
CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma&amp;CD106(+)CD16/32(-)Ly6C(+)CD31(+) in hot spots has p value = 0.966
CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma&amp;CD106(-)CD16/32(+)Ly6C(+)CD31(-) in hot spots has p value = 0.030
CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma&amp;CD3(+) other markers (-) in hot spots has p value = 0.037
CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma&amp;CD4(+) T cells in hot spots has p value = 0.003
CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma&amp;CD4(+) T cells in whole tissue has p value = 0.149
******************************************
CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma&amp;CD4(+)CD8(-)cDC in hot spots has p value = 0.006
CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma&amp;CD4(-)CD8(+)cDC in hot spots has p value = 0.002
CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma&amp;CD8(+) T cells in hot spots has p value = 0.003
CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma&amp;CD8(+) T cells in whole tissue has p value = 0.118
******************************************
CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma&amp;ERTR7(+) stroma in hot spots has p value = 0.098
CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma&amp;F4/80(+) mphs in hot spots has p value = 0.091
CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma&amp;NK cells in hot spots has p value = 0.351
CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma&amp;erythroblasts in hot spots has p value = 0.030
CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma&amp;granulocytes in hot spots has p value = 0.015
CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma&amp;plasma cells in hot spots has p value = 0.256
CD106(+)CD16/32(-)Ly6C(+)CD31(+)&amp;CD4(+) T cells in hot spots has p value = 0.028
CD106(+)CD16/32(-)Ly6C(+)CD31(+)&amp;CD4(+)CD8(-)cDC in hot spots has p value = 0.210
CD106(+)CD16/32(-)Ly6C(+)CD31(+)&amp;CD8(+) T cells in hot spots has p value = 0.136
CD106(+)CD16/32(-)Ly6C(+)CD31(+)&amp;ERTR7(+) stroma in hot spots has p value = 0.649
CD106(+)CD16/32(-)Ly6C(+)CD31(+)&amp;F4/80(+) mphs in hot spots has p value = 0.030
CD106(+)CD16/32(-)Ly6C(+)CD31(+)&amp;erythroblasts in hot spots has p value = 0.318
CD106(+)CD16/32(-)Ly6C(+)CD31(+)&amp;granulocytes in hot spots has p value = 0.208
CD106(-)CD16/32(+)Ly6C(+)CD31(-)&amp;CD4(+) T cells in hot spots has p value = 0.030
CD106(-)CD16/32(+)Ly6C(+)CD31(-)&amp;CD4(+)CD8(-)cDC in hot spots has p value = 0.010
CD106(-)CD16/32(+)Ly6C(+)CD31(-)&amp;CD8(+) T cells in hot spots has p value = 0.017
CD106(-)CD16/32(+)Ly6C(+)CD31(-)&amp;ERTR7(+) stroma in hot spots has p value = 0.091
CD106(-)CD16/32(+)Ly6C(+)CD31(-)&amp;F4/80(+) mphs in hot spots has p value = 0.045
CD106(-)CD16/32(+)Ly6C(+)CD31(-)&amp;erythroblasts in hot spots has p value = 0.028
CD106(-)CD16/32(+)Ly6C(+)CD31(-)&amp;granulocytes in hot spots has p value = 0.019
CD3(+) other markers (-)&amp;CD4(+) T cells in hot spots has p value = 0.160
CD3(+) other markers (-)&amp;CD8(+) T cells in hot spots has p value = 0.153
CD3(+) other markers (-)&amp;F4/80(+) mphs in hot spots has p value = 0.446
CD3(+) other markers (-)&amp;erythroblasts in hot spots has p value = 0.068
CD3(+) other markers (-)&amp;granulocytes in hot spots has p value = 0.050
CD4(+) T cells&amp;CD4(+)CD8(-)cDC in hot spots has p value = 0.013
CD4(+) T cells&amp;CD4(-)CD8(+)cDC in hot spots has p value = 0.005
CD4(+) T cells&amp;CD4(-)CD8(-) cDC in hot spots has p value = 0.283
CD4(+) T cells&amp;CD8(+) T cells in hot spots has p value = 0.963
CD4(+) T cells&amp;ERTR7(+) stroma in hot spots has p value = 0.064
CD4(+) T cells&amp;F4/80(+) mphs in hot spots has p value = 0.005
CD4(+) T cells&amp;NK cells in hot spots has p value = 0.037
CD4(+) T cells&amp;erythroblasts in hot spots has p value = 0.718
CD4(+) T cells&amp;granulocytes in hot spots has p value = 0.025
CD4(+) T cells&amp;granulocytes in whole tissue has p value = 0.062
******************************************
CD4(+) T cells&amp;marginal zone mphs in hot spots has p value = 0.069
CD4(+) T cells&amp;plasma cells in hot spots has p value = 0.304
CD4(+)CD8(-)cDC&amp;CD4(-)CD8(+)cDC in hot spots has p value = 0.019
CD4(+)CD8(-)cDC&amp;CD8(+) T cells in hot spots has p value = 0.022
CD4(+)CD8(-)cDC&amp;ERTR7(+) stroma in hot spots has p value = 0.012
CD4(+)CD8(-)cDC&amp;ERTR7(+) stroma in whole tissue has p value = 0.088
******************************************
CD4(+)CD8(-)cDC&amp;F4/80(+) mphs in hot spots has p value = 0.499
CD4(+)CD8(-)cDC&amp;NK cells in hot spots has p value = 0.076
CD4(+)CD8(-)cDC&amp;erythroblasts in hot spots has p value = 0.026
CD4(+)CD8(-)cDC&amp;granulocytes in hot spots has p value = 0.009
CD4(+)CD8(-)cDC&amp;plasma cells in hot spots has p value = 0.210
CD4(-)CD8(+)cDC&amp;CD8(+) T cells in hot spots has p value = 0.004
CD4(-)CD8(+)cDC&amp;ERTR7(+) stroma in hot spots has p value = 0.002
CD4(-)CD8(+)cDC&amp;F4/80(+) mphs in hot spots has p value = 0.025
CD4(-)CD8(+)cDC&amp;erythroblasts in hot spots has p value = 0.002
CD4(-)CD8(+)cDC&amp;granulocytes in hot spots has p value = 0.007
CD8(+) T cells&amp;ERTR7(+) stroma in hot spots has p value = 0.031
CD8(+) T cells&amp;ERTR7(+) stroma in whole tissue has p value = 0.396
******************************************
CD8(+) T cells&amp;F4/80(+) mphs in hot spots has p value = 0.018
CD8(+) T cells&amp;NK cells in hot spots has p value = 0.210
CD8(+) T cells&amp;erythroblasts in hot spots has p value = 0.916
CD8(+) T cells&amp;granulocytes in hot spots has p value = 0.020
CD8(+) T cells&amp;plasma cells in hot spots has p value = 0.318
ERTR7(+) stroma&amp;F4/80(+) mphs in hot spots has p value = 0.059
ERTR7(+) stroma&amp;NK cells in hot spots has p value = 0.852
ERTR7(+) stroma&amp;erythroblasts in hot spots has p value = 0.406
ERTR7(+) stroma&amp;granulocytes in hot spots has p value = 0.036
ERTR7(+) stroma&amp;granulocytes in whole tissue has p value = 0.062
******************************************
ERTR7(+) stroma&amp;plasma cells in hot spots has p value = 0.351
F4/80(+) mphs&amp;NK cells in hot spots has p value = 0.005
F4/80(+) mphs&amp;erythroblasts in hot spots has p value = 0.005
F4/80(+) mphs&amp;granulocytes in hot spots has p value = 0.523
F4/80(+) mphs&amp;plasma cells in hot spots has p value = 0.012
NK cells&amp;erythroblasts in hot spots has p value = 0.167
NK cells&amp;granulocytes in hot spots has p value = 0.303
erythroblasts&amp;granulocytes in hot spots has p value = 0.013
erythroblasts&amp;plasma cells in hot spots has p value = 0.719
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_tutorials_MESA_tutorial_ecospatial_murine_58_3.png" src="../../_images/notebooks_tutorials_MESA_tutorial_ecospatial_murine_58_3.png" />
</div>
</div>
</section>
<section id="Cell-Co-Occurrence-Circle-Plot">
<h3>Cell Co-Occurrence Circle Plot<a class="headerlink" href="#Cell-Co-Occurrence-Circle-Plot" title="Link to this heading"></a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[40]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">circoplot_df1</span> <span class="o">=</span> <span class="n">global_co_occurrence_df</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Mouse&#39;</span><span class="p">])</span>
<span class="n">circoplot_df1</span> <span class="o">=</span> <span class="n">circoplot_df1</span><span class="p">[[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">circoplot_df1</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s1">&#39;noid&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">col</span><span class="p">]]</span>
<span class="c1"># Group by &#39;Condition&#39; and calculate the mean of the other columns</span>
<span class="n">circoplot_df1</span> <span class="o">=</span> <span class="n">circoplot_df1</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;Condition&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">circoplot_df1</span> <span class="o">=</span> <span class="n">circoplot_df1</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Condition&#39;</span><span class="p">)</span>
<span class="n">circoplot_df1</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[40]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th colspan="10" halign="left">B cells</th>
      <th>...</th>
      <th colspan="2" halign="left">ERTR7(+) stroma</th>
      <th colspan="4" halign="left">F4/80(+) mphs</th>
      <th colspan="2" halign="left">NK cells</th>
      <th colspan="2" halign="left">erythroblasts</th>
    </tr>
    <tr>
      <th></th>
      <th>B220(+) DN T cells</th>
      <th>CD106(+)CD16/32(+)CD31(+) stroma</th>
      <th>CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma</th>
      <th>CD106(+)CD16/32(-)Ly6C(+)CD31(+)</th>
      <th>CD106(-)CD16/32(+)Ly6C(+)CD31(-)</th>
      <th>CD3(+) other markers (-)</th>
      <th>CD4(+) T cells</th>
      <th>CD4(+)CD8(-)cDC</th>
      <th>CD4(-)CD8(+)cDC</th>
      <th>CD8(+) T cells</th>
      <th>...</th>
      <th>granulocytes</th>
      <th>plasma cells</th>
      <th>NK cells</th>
      <th>erythroblasts</th>
      <th>granulocytes</th>
      <th>plasma cells</th>
      <th>erythroblasts</th>
      <th>granulocytes</th>
      <th>granulocytes</th>
      <th>plasma cells</th>
    </tr>
    <tr>
      <th>Condition</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>BALBc</th>
      <td>0.073364</td>
      <td>0.154887</td>
      <td>0.256508</td>
      <td>0.117092</td>
      <td>0.026082</td>
      <td>0.024203</td>
      <td>0.609478</td>
      <td>0.133404</td>
      <td>0.033559</td>
      <td>0.435705</td>
      <td>...</td>
      <td>0.037708</td>
      <td>0.020787</td>
      <td>0.11371</td>
      <td>0.393021</td>
      <td>0.120370</td>
      <td>0.046403</td>
      <td>0.097886</td>
      <td>0.034235</td>
      <td>0.101013</td>
      <td>0.041810</td>
    </tr>
    <tr>
      <th>MRL</th>
      <td>0.190871</td>
      <td>0.059676</td>
      <td>0.186811</td>
      <td>0.060700</td>
      <td>0.051504</td>
      <td>0.036226</td>
      <td>0.382356</td>
      <td>0.140771</td>
      <td>0.115103</td>
      <td>0.272822</td>
      <td>...</td>
      <td>0.102183</td>
      <td>0.026166</td>
      <td>0.04952</td>
      <td>0.251273</td>
      <td>0.133979</td>
      <td>0.024188</td>
      <td>0.089268</td>
      <td>0.051191</td>
      <td>0.250753</td>
      <td>0.047435</td>
    </tr>
  </tbody>
</table>
<p>2 rows × 109 columns</p>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[41]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">circoplot_df2</span> <span class="o">=</span> <span class="n">global_cellfreq_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;noid&#39;</span><span class="p">])</span>
<span class="c1"># Group by &#39;Condition&#39; and calculate the mean of the other columns</span>
<span class="n">circoplot_df2</span> <span class="o">=</span> <span class="n">circoplot_df2</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;Condition&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">circoplot_df2</span> <span class="o">=</span> <span class="n">circoplot_df2</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Condition&#39;</span><span class="p">)</span>
<span class="n">circoplot_df2</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[41]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>cell_type</th>
      <th>B220(+) DN T cells</th>
      <th>B cells</th>
      <th>CD3(+) other markers (-)</th>
      <th>CD4(+) T cells</th>
      <th>CD4(+)CD8(-)cDC</th>
      <th>CD4(+)MHCII(+)</th>
      <th>CD4(-)CD8(+)cDC</th>
      <th>CD4(-)CD8(-) cDC</th>
      <th>CD8(+) T cells</th>
      <th>CD11c(+) B cells</th>
      <th>...</th>
      <th>ERTR7(+) stroma</th>
      <th>F4/80(+) mphs</th>
      <th>FDCs</th>
      <th>NK cells</th>
      <th>capsule</th>
      <th>erythroblasts</th>
      <th>granulocytes</th>
      <th>marginal zone mphs</th>
      <th>megakaryocytes</th>
      <th>plasma cells</th>
    </tr>
    <tr>
      <th>Condition</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>BALBc</th>
      <td>0.004396</td>
      <td>0.412367</td>
      <td>0.001354</td>
      <td>0.203280</td>
      <td>0.008805</td>
      <td>0.001392</td>
      <td>0.002227</td>
      <td>0.000868</td>
      <td>0.092659</td>
      <td>0.002509</td>
      <td>...</td>
      <td>0.026396</td>
      <td>0.087874</td>
      <td>0.014105</td>
      <td>0.007839</td>
      <td>0.003246</td>
      <td>0.049971</td>
      <td>0.010219</td>
      <td>0.014744</td>
      <td>0.000903</td>
      <td>0.004050</td>
    </tr>
    <tr>
      <th>MRL</th>
      <td>0.084533</td>
      <td>0.198221</td>
      <td>0.004375</td>
      <td>0.170439</td>
      <td>0.026252</td>
      <td>0.002132</td>
      <td>0.018900</td>
      <td>0.003761</td>
      <td>0.088126</td>
      <td>0.000890</td>
      <td>...</td>
      <td>0.032504</td>
      <td>0.024637</td>
      <td>0.001688</td>
      <td>0.007359</td>
      <td>0.000383</td>
      <td>0.189346</td>
      <td>0.038826</td>
      <td>0.003152</td>
      <td>0.003147</td>
      <td>0.007477</td>
    </tr>
  </tbody>
</table>
<p>2 rows × 26 columns</p>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[46]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">patient_group</span> <span class="o">=</span> <span class="s1">&#39;BALBc&#39;</span>
<span class="n">eco</span><span class="o">.</span><span class="n">create_circos_plot</span><span class="p">(</span><span class="n">circoplot_df1</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="n">patient_group</span><span class="p">]],</span>
                       <span class="n">cell_type_colors_hex</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">cell_abundance</span><span class="o">=</span><span class="n">circoplot_df2</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="n">patient_group</span><span class="p">]],</span>
                       <span class="n">threshold</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
                       <span class="n">edge_weights_scaler</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                       <span class="n">highlighted_edges</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">node_weights_scaler</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span>
                       <span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span>
                       <span class="n">save_path</span><span class="o">=</span><span class="s1">&#39;/Users/Emrys/Downloads/&#39;</span><span class="o">+</span><span class="n">patient_group</span><span class="o">+</span><span class="s1">&#39;_wholetissue_circoplot.svg&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_tutorials_MESA_tutorial_ecospatial_murine_62_0.png" src="../../_images/notebooks_tutorials_MESA_tutorial_ecospatial_murine_62_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">circoplot_df1</span> <span class="o">=</span> <span class="n">spot_co_occurrence_df</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Mouse&#39;</span><span class="p">])</span>
<span class="n">circoplot_df1</span> <span class="o">=</span> <span class="n">circoplot_df1</span><span class="p">[[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">circoplot_df1</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s1">&#39;noid&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">col</span><span class="p">]]</span>
<span class="c1"># Group by &#39;Condition&#39; and calculate the mean of the other columns</span>
<span class="n">circoplot_df1</span> <span class="o">=</span> <span class="n">circoplot_df1</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;Condition&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">circoplot_df1</span> <span class="o">=</span> <span class="n">circoplot_df1</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Condition&#39;</span><span class="p">)</span>
<span class="n">circoplot_df1</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th colspan="10" halign="left">B cells</th>
      <th>...</th>
      <th colspan="2" halign="left">ERTR7(+) stroma</th>
      <th colspan="4" halign="left">F4/80(+) mphs</th>
      <th colspan="2" halign="left">NK cells</th>
      <th colspan="2" halign="left">erythroblasts</th>
    </tr>
    <tr>
      <th></th>
      <th>B220(+) DN T cells</th>
      <th>CD106(+)CD16/32(+)CD31(+) stroma</th>
      <th>CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma</th>
      <th>CD106(+)CD16/32(-)Ly6C(+)CD31(+)</th>
      <th>CD106(-)CD16/32(+)Ly6C(+)CD31(-)</th>
      <th>CD3(+) other markers (-)</th>
      <th>CD4(+) T cells</th>
      <th>CD4(+)CD8(-)cDC</th>
      <th>CD4(-)CD8(+)cDC</th>
      <th>CD8(+) T cells</th>
      <th>...</th>
      <th>granulocytes</th>
      <th>plasma cells</th>
      <th>NK cells</th>
      <th>erythroblasts</th>
      <th>granulocytes</th>
      <th>plasma cells</th>
      <th>erythroblasts</th>
      <th>granulocytes</th>
      <th>granulocytes</th>
      <th>plasma cells</th>
    </tr>
    <tr>
      <th>Condition</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>BALBc</th>
      <td>0.057617</td>
      <td>0.267754</td>
      <td>0.416566</td>
      <td>0.190961</td>
      <td>0.060190</td>
      <td>0.061251</td>
      <td>0.734347</td>
      <td>0.224730</td>
      <td>0.043511</td>
      <td>0.565753</td>
      <td>...</td>
      <td>0.079555</td>
      <td>0.043365</td>
      <td>0.244668</td>
      <td>0.770760</td>
      <td>0.266262</td>
      <td>0.113863</td>
      <td>0.208335</td>
      <td>0.087958</td>
      <td>0.226096</td>
      <td>0.099391</td>
    </tr>
    <tr>
      <th>MRL</th>
      <td>0.138697</td>
      <td>0.076683</td>
      <td>0.332347</td>
      <td>0.103709</td>
      <td>0.120283</td>
      <td>0.084381</td>
      <td>0.430770</td>
      <td>0.261946</td>
      <td>0.143579</td>
      <td>0.348793</td>
      <td>...</td>
      <td>0.264536</td>
      <td>0.067245</td>
      <td>0.106753</td>
      <td>0.438014</td>
      <td>0.298846</td>
      <td>0.057091</td>
      <td>0.162662</td>
      <td>0.123358</td>
      <td>0.465931</td>
      <td>0.111451</td>
    </tr>
  </tbody>
</table>
<p>2 rows × 109 columns</p>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[37]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">circoplot_df2</span> <span class="o">=</span> <span class="n">spot_cellfreq_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;noid&#39;</span><span class="p">,</span> <span class="s1">&#39;Mouse&#39;</span><span class="p">])</span>
<span class="c1"># Group by &#39;Condition&#39; and calculate the mean of the other columns</span>
<span class="n">circoplot_df2</span> <span class="o">=</span> <span class="n">circoplot_df2</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;Condition&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">circoplot_df2</span> <span class="o">=</span> <span class="n">circoplot_df2</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Condition&#39;</span><span class="p">)</span>
<span class="n">circoplot_df2</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[37]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>B cells</th>
      <th>B220(+) DN T cells</th>
      <th>CD106(+)CD16/32(+)CD31(+) stroma</th>
      <th>CD106(+)CD16/32(+)CD31(-)Ly6C(-) stroma</th>
      <th>CD106(+)CD16/32(-)Ly6C(+)CD31(+)</th>
      <th>CD106(-)CD16/32(+)Ly6C(+)CD31(-)</th>
      <th>CD106(-)CD16/32(-)Ly6C(+)CD31(+) stroma</th>
      <th>CD11c(+) B cells</th>
      <th>CD3(+) other markers (-)</th>
      <th>CD31(hi) vascular</th>
      <th>...</th>
      <th>ERTR7(+) stroma</th>
      <th>F4/80(+) mphs</th>
      <th>FDCs</th>
      <th>NK cells</th>
      <th>capsule</th>
      <th>erythroblasts</th>
      <th>granulocytes</th>
      <th>marginal zone mphs</th>
      <th>megakaryocytes</th>
      <th>plasma cells</th>
    </tr>
    <tr>
      <th>Condition</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>BALBc</th>
      <td>0.286122</td>
      <td>0.003563</td>
      <td>0.024994</td>
      <td>0.035697</td>
      <td>0.015001</td>
      <td>0.003794</td>
      <td>0.000047</td>
      <td>0.003634</td>
      <td>0.003974</td>
      <td>0.002357</td>
      <td>...</td>
      <td>0.046011</td>
      <td>0.19085</td>
      <td>0.000028</td>
      <td>0.017559</td>
      <td>0.001526</td>
      <td>0.108952</td>
      <td>0.026025</td>
      <td>0.004240</td>
      <td>0.001321</td>
      <td>0.011325</td>
    </tr>
    <tr>
      <th>MRL</th>
      <td>0.090528</td>
      <td>0.026797</td>
      <td>0.012673</td>
      <td>0.102604</td>
      <td>0.014580</td>
      <td>0.026811</td>
      <td>0.003775</td>
      <td>0.001113</td>
      <td>0.009032</td>
      <td>0.004166</td>
      <td>...</td>
      <td>0.063478</td>
      <td>0.04965</td>
      <td>0.000058</td>
      <td>0.013987</td>
      <td>0.000819</td>
      <td>0.150498</td>
      <td>0.074897</td>
      <td>0.001001</td>
      <td>0.005919</td>
      <td>0.017193</td>
    </tr>
  </tbody>
</table>
<p>2 rows × 26 columns</p>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[39]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">patient_group</span> <span class="o">=</span> <span class="s1">&#39;MRL&#39;</span>
<span class="n">eco</span><span class="o">.</span><span class="n">create_circos_plot</span><span class="p">(</span><span class="n">circoplot_df1</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="n">patient_group</span><span class="p">]],</span>
                       <span class="n">cell_type_colors_hex</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">cell_abundance</span><span class="o">=</span><span class="n">circoplot_df2</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="n">patient_group</span><span class="p">]],</span>
                       <span class="n">threshold</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
                       <span class="n">edge_weights_scaler</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                       <span class="n">highlighted_edges</span><span class="o">=</span><span class="n">highlighted_comb</span><span class="p">,</span>
                       <span class="n">node_weights_scaler</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span>
                       <span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span>
                       <span class="n">save_path</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_tutorials_MESA_tutorial_ecospatial_murine_65_0.png" src="../../_images/notebooks_tutorials_MESA_tutorial_ecospatial_murine_65_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../../tutorials.html" class="btn btn-neutral float-left" title="Tutorials" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="MESA_tutorial_ecospatial_crc.html" class="btn btn-neutral float-right" title="MESA Ecospatial Tutorials (Colorectal Cancer, CODEX)" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Daisy Yi Ding, Zeyu Tang, Bokai Zhu.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>