<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MESA Ecospatial Tutorials (hepatocellular carcinoma, CosMx) &mdash; MESA 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../_static/nbsphinx-code-cells.css" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=01f34227"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
        <script src="../../_static/copybutton.js?v=f281be69"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="MESA Multiomics Tutorials" href="MESA_tutorial_multiomics.html" />
    <link rel="prev" title="MESA Ecospatial Tutorials (Colorectal Cancer, CODEX)" href="MESA_tutorial_ecospatial_crc.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            MESA
          </a>
              <div class="version">
                0.1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">General</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../tutorials.html">Tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="MESA_tutorial_ecospatial_murine.html">MESA Ecospatial Tutorials (Murine Spleen, CODEX)</a></li>
<li class="toctree-l2"><a class="reference internal" href="MESA_tutorial_ecospatial_crc.html">MESA Ecospatial Tutorials (Colorectal Cancer, CODEX)</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">MESA Ecospatial Tutorials (hepatocellular carcinoma, CosMx)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Helper-functions">Helper functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Read-Data">Read Data</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Perform-Ecospatial-Analysis-on-one-sample">Perform Ecospatial Analysis on one sample</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Perform-Ecospatial-Analysis-on-all-samples">Perform Ecospatial Analysis on all samples</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Calculate-Global-Cell-Frequency-&amp;-Cell-Co-Occurrence">Calculate Global Cell Frequency &amp; Cell Co-Occurrence</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Calculate-Cell-Frequency-and-Cell-Co-Occurrence-in-hot/coldspots">Calculate Cell Frequency and Cell Co-Occurrence in hot/coldspots</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Process-Cell-Co-Occurrence-Dataframe">Process Cell Co-Occurrence Dataframe</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Cell-Co-Occurrence-Circle-Plot">Cell Co-Occurrence Circle Plot</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="MESA_tutorial_multiomics.html">MESA Multiomics Tutorials</a></li>
<li class="toctree-l2"><a class="reference internal" href="MESA_in_R.html">Using MESA in R</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../unit_test.html">UnitTest</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">MESA</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../tutorials.html">Tutorials</a></li>
      <li class="breadcrumb-item active">MESA Ecospatial Tutorials (hepatocellular carcinoma, CosMx)</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/notebooks/tutorials/MESA_tutorial_ecospatial_liver.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="MESA-Ecospatial-Tutorials-(hepatocellular-carcinoma,-CosMx)">
<h1>MESA Ecospatial Tutorials (hepatocellular carcinoma, CosMx)<a class="headerlink" href="#MESA-Ecospatial-Tutorials-(hepatocellular-carcinoma,-CosMx)" title="Link to this heading"></a></h1>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">anndata</span> <span class="k">as</span> <span class="nn">ad</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.colors</span> <span class="k">as</span> <span class="nn">mcolors</span>
<span class="kn">from</span> <span class="nn">matplotlib.figure</span> <span class="kn">import</span> <span class="n">figaspect</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="n">os</span><span class="o">.</span><span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;../../../&#39;</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">mesa</span> <span class="kn">import</span> <span class="n">ecospatial</span> <span class="k">as</span> <span class="n">eco</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/opt/miniconda3/envs/mesa/lib/python3.11/site-packages/geopandas/_compat.py:106: UserWarning: The Shapely GEOS version (3.8.0-CAPI-1.13.1) is incompatible with the GEOS version PyGEOS was compiled with (3.10.4-CAPI-1.16.2). Conversions between both will be slow.
  warnings.warn(
OMP: Info #276: omp_set_nested routine deprecated, please use omp_set_max_active_levels instead.
/opt/miniconda3/envs/mesa/lib/python3.11/site-packages/spaghetti/network.py:41: FutureWarning: The next major release of pysal/spaghetti (2.0.0) will drop support for all ``libpysal.cg`` geometries. This change is a first step in refactoring ``spaghetti`` that is expected to result in dramatically reduced runtimes for network instantiation and operations. Users currently requiring network and point pattern input as ``libpysal.cg`` geometries should prepare for this simply by converting to ``shapely`` geometries.
  warnings.warn(dep_msg, FutureWarning, stacklevel=1)
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;font.family&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Arial&#39;</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;svg.fonttype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>  <span class="c1"># To keep text as editable text in SVGs</span>
</pre></div>
</div>
</div>
<section id="Helper-functions">
<h2>Helper functions<a class="headerlink" href="#Helper-functions" title="Link to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span><span class="p">,</span><span class="n">List</span>
<span class="k">def</span> <span class="nf">overlap_check</span><span class="p">(</span><span class="n">new_patch</span><span class="p">,</span> <span class="n">existing_patches</span><span class="p">,</span> <span class="n">max_overlap_ratio</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function checks if the new patch overlaps with any of the existing patches.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    new_patch: tuple</span>
<span class="sd">        The coordinates of the new patch to be checked for overlaps.</span>
<span class="sd">    existing_patches: list</span>
<span class="sd">        A list of existing patches to check for overlaps.</span>
<span class="sd">    max_overlap_ratio: float</span>
<span class="sd">        The maximum allowable overlap ratio for a new patch.</span>

<span class="sd">    Returns:</span>
<span class="sd">    bool</span>
<span class="sd">        Returns True if the new patch doesn&#39;t overlap with any existing patch beyond the allowable overlap ratio.</span>
<span class="sd">        Otherwise, returns False.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">patch_area</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_patch</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">new_patch</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">new_patch</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">new_patch</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">max_overlap</span> <span class="o">=</span> <span class="n">max_overlap_ratio</span> <span class="o">*</span> <span class="n">patch_area</span>
    <span class="k">for</span> <span class="n">patch</span> <span class="ow">in</span> <span class="n">existing_patches</span><span class="p">:</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">new_patch</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">patch</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">-</span> <span class="nb">max</span><span class="p">(</span><span class="n">new_patch</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">patch</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">new_patch</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">patch</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">-</span> <span class="nb">max</span><span class="p">(</span><span class="n">new_patch</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">patch</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">dx</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">dy</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">dx</span><span class="o">*</span><span class="n">dy</span> <span class="o">&gt;</span> <span class="n">max_overlap</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span>

<span class="k">def</span> <span class="nf">contains_points</span><span class="p">(</span><span class="n">patch</span><span class="p">,</span> <span class="n">spatial_values</span><span class="p">,</span> <span class="n">min_points</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function checks if a patch contains a certain number of spatial values (points).</span>

<span class="sd">    Parameters:</span>
<span class="sd">    patch: tuple</span>
<span class="sd">        The coordinates of the patch to be checked.</span>
<span class="sd">    spatial_values: list</span>
<span class="sd">        A list of spatial values (cells&#39; coordinates) to check if they are within the patch.</span>
<span class="sd">    min_points: int</span>
<span class="sd">        The minimum number of points that the patch should contain.</span>

<span class="sd">    Returns:</span>
<span class="sd">    bool</span>
<span class="sd">        Returns True if the patch contains at least &#39;min_points&#39; number of spatial values（cells&#39; coordinates）. Otherwise, returns False.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Count the points within the patch</span>
    <span class="n">points_in_patch</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">((</span><span class="n">patch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">patch</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="n">patch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">patch</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">spatial_values</span><span class="p">)</span>

    <span class="c1"># Check if the number of points in the patch is at least min_points</span>
    <span class="k">return</span> <span class="n">points_in_patch</span> <span class="o">&gt;=</span> <span class="n">min_points</span>
<span class="k">def</span> <span class="nf">subsampling_randomly</span><span class="p">(</span><span class="n">spatial_data</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">ad</span><span class="o">.</span><span class="n">AnnData</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">],</span>
                         <span class="n">library_key</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span>
                         <span class="n">library_id</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span>
                         <span class="n">sample_size</span><span class="p">:</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span><span class="nb">float</span><span class="p">],</span>
                         <span class="n">sample_number</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span>
                         <span class="n">spatial_key</span><span class="p">:</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
                         <span class="n">max_overlap</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                         <span class="n">random_seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">min_points</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>

    <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">random_seed</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spatial_data</span><span class="p">,</span> <span class="n">ad</span><span class="o">.</span><span class="n">AnnData</span><span class="p">):</span>
        <span class="n">spatial_data_filtered</span> <span class="o">=</span> <span class="n">spatial_data</span><span class="p">[</span><span class="n">spatial_data</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">library_key</span><span class="p">]</span> <span class="o">==</span> <span class="n">library_id</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spatial_data</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">spatial_data_filtered</span> <span class="o">=</span> <span class="n">spatial_data</span><span class="p">[</span><span class="n">spatial_data</span><span class="p">[</span><span class="n">library_key</span><span class="p">]</span> <span class="o">==</span> <span class="n">library_id</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;spatial_data should be either an AnnData object or a pandas DataFrame&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spatial_data</span><span class="p">,</span> <span class="n">ad</span><span class="o">.</span><span class="n">AnnData</span><span class="p">):</span>
        <span class="n">spatial_values</span> <span class="o">=</span> <span class="n">spatial_data_filtered</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="n">spatial_key</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spatial_data</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">spatial_values</span> <span class="o">=</span> <span class="n">spatial_data_filtered</span><span class="p">[</span><span class="n">spatial_key</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;spatial_data should be either an AnnData object or a pandas DataFrame&quot;</span><span class="p">)</span>

    <span class="n">width</span> <span class="o">=</span> <span class="n">spatial_values</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">spatial_values</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">height</span> <span class="o">=</span> <span class="n">spatial_values</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">spatial_values</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">patch_width</span> <span class="o">=</span> <span class="n">sample_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">patch_height</span> <span class="o">=</span> <span class="n">sample_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">sample_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">else</span> <span class="n">sample_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">num_patches</span> <span class="o">=</span> <span class="n">sample_number</span>

    <span class="n">patches</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">used_coordinates</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_patches</span><span class="p">):</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>  <span class="c1"># seconds</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Could not generate a new patch within 5 seconds. Return </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">patches</span><span class="p">)</span><span class="si">}</span><span class="s2"> out of </span><span class="si">{</span><span class="n">num_patches</span><span class="si">}</span><span class="s2"> patches&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">patches</span>

            <span class="n">x0</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">spatial_values</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">spatial_values</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">patch_width</span><span class="p">)</span>
            <span class="n">y0</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">spatial_values</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="n">spatial_values</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">patch_height</span><span class="p">)</span>
            <span class="n">x1</span> <span class="o">=</span> <span class="n">x0</span> <span class="o">+</span> <span class="n">patch_width</span>
            <span class="n">y1</span> <span class="o">=</span> <span class="n">y0</span> <span class="o">+</span> <span class="n">patch_height</span>
            <span class="n">new_patch</span> <span class="o">=</span> <span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">used_coordinates</span> <span class="ow">and</span>
                <span class="n">overlap_check</span><span class="p">(</span><span class="n">new_patch</span><span class="p">,</span> <span class="n">patches</span><span class="p">,</span> <span class="n">max_overlap</span><span class="p">)</span> <span class="ow">and</span>
                <span class="n">contains_points</span><span class="p">(</span><span class="n">new_patch</span><span class="p">,</span> <span class="n">spatial_values</span><span class="p">,</span> <span class="n">min_points</span><span class="p">)</span>  <span class="p">):</span>
                <span class="n">used_coordinates</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">))</span>
                <span class="n">patches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_patch</span><span class="p">)</span>
                <span class="k">break</span>

    <span class="k">return</span> <span class="n">patches</span>
</pre></div>
</div>
</div>
</section>
<section id="Read-Data">
<h2>Read Data<a class="headerlink" href="#Read-Data" title="Link to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">liver_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;/Users/Emrys/Dropbox/spatial_augmentation/data/cosMx_liver/data/cosMx_liver_meta.csv&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">liver_df</span> <span class="o">=</span> <span class="n">liver_df</span><span class="p">[[</span><span class="s1">&#39;cell_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;Run_Tissue_name&#39;</span><span class="p">,</span> <span class="s1">&#39;x_slide_mm&#39;</span><span class="p">,</span> <span class="s1">&#39;y_slide_mm&#39;</span><span class="p">,</span> <span class="s1">&#39;fov&#39;</span><span class="p">,</span> <span class="s1">&#39;nCell&#39;</span><span class="p">,</span> <span class="s1">&#39;cellType&#39;</span><span class="p">,</span> <span class="s1">&#39;niche&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">liver_df</span><span class="p">[</span><span class="s1">&#39;x_slide_um&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">liver_df</span><span class="p">[</span><span class="s1">&#39;x_slide_mm&#39;</span><span class="p">]</span><span class="o">*</span><span class="mf">1000.0</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">liver_df</span><span class="p">[</span><span class="s1">&#39;y_slide_um&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">liver_df</span><span class="p">[</span><span class="s1">&#39;y_slide_mm&#39;</span><span class="p">]</span><span class="o">*</span><span class="mf">1000.0</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">liver_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>cell_ID</th>
      <th>Run_Tissue_name</th>
      <th>x_slide_mm</th>
      <th>y_slide_mm</th>
      <th>fov</th>
      <th>nCell</th>
      <th>cellType</th>
      <th>niche</th>
      <th>x_slide_um</th>
      <th>y_slide_um</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>c_1_100_10</td>
      <td>NormalLiver</td>
      <td>9.03144</td>
      <td>9.73500</td>
      <td>100</td>
      <td>1265</td>
      <td>Hep.3</td>
      <td>Zone_3a</td>
      <td>9031.0</td>
      <td>9735.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>c_1_100_1078</td>
      <td>NormalLiver</td>
      <td>8.77440</td>
      <td>9.25824</td>
      <td>100</td>
      <td>1265</td>
      <td>Hep.4</td>
      <td>Zone_2a</td>
      <td>8774.0</td>
      <td>9258.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>c_1_100_1135</td>
      <td>NormalLiver</td>
      <td>8.87928</td>
      <td>9.23412</td>
      <td>100</td>
      <td>1265</td>
      <td>Inflammatory.macrophages</td>
      <td>Zone_2a</td>
      <td>8879.0</td>
      <td>9234.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>c_1_100_267</td>
      <td>NormalLiver</td>
      <td>9.12132</td>
      <td>9.61104</td>
      <td>100</td>
      <td>1265</td>
      <td>Hep.5</td>
      <td>Zone_2a</td>
      <td>9121.0</td>
      <td>9611.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>c_1_100_732</td>
      <td>NormalLiver</td>
      <td>9.08436</td>
      <td>9.40548</td>
      <td>100</td>
      <td>1265</td>
      <td>Central.venous.LSECs</td>
      <td>Zone_2a</td>
      <td>9084.0</td>
      <td>9405.0</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">liver_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;sample&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;-1&#39;</span>  <span class="c1"># Initialize the &#39;patches&#39; column with -1</span>
<span class="n">patches_coord_dict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">tissue_type</span> <span class="ow">in</span> <span class="n">pd</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">liver_df</span><span class="p">[</span><span class="s1">&#39;Run_Tissue_name&#39;</span><span class="p">]):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing </span><span class="si">{</span><span class="n">tissue_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># patches_coord = subsampling(liver_df,</span>
    <span class="c1">#                             &#39;Run_Tissue_name&#39;,</span>
    <span class="c1">#                             tissue_type,</span>
    <span class="c1">#                             num_squares=[11.0,8.0],</span>
    <span class="c1">#                             spatial_key=[&#39;x_slide_um&#39;, &#39;y_slide_um&#39;])</span>

    <span class="n">patches_coord</span> <span class="o">=</span> <span class="n">subsampling_randomly</span><span class="p">(</span><span class="n">spatial_data</span><span class="o">=</span><span class="n">liver_df</span><span class="p">,</span>
                                         <span class="n">library_key</span><span class="o">=</span><span class="s1">&#39;Run_Tissue_name&#39;</span><span class="p">,</span>
                                         <span class="n">library_id</span><span class="o">=</span><span class="n">tissue_type</span><span class="p">,</span>
                                         <span class="n">sample_size</span><span class="o">=</span><span class="p">[</span><span class="mi">1600</span><span class="p">,</span><span class="mi">1600</span><span class="p">],</span>
                                         <span class="n">sample_number</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                                         <span class="n">spatial_key</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;x_slide_um&#39;</span><span class="p">,</span> <span class="s1">&#39;y_slide_um&#39;</span><span class="p">],</span>
                                         <span class="n">max_overlap</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                                         <span class="n">random_seed</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
                                         <span class="n">min_points</span><span class="o">=</span><span class="mi">12000</span><span class="p">)</span>

    <span class="n">patches_coord_dict</span><span class="p">[</span><span class="n">tissue_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">patches_coord</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total number of patches: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">patches_coord</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">patches_coord</span><span class="p">)</span>
    <span class="c1"># Iterate over patches</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">patch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">patches_coord</span><span class="p">):</span>
        <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="n">patch</span>

        <span class="c1"># Define the number of decimal places for rounding</span>
        <span class="n">decimal_places</span> <span class="o">=</span> <span class="mi">5</span>

        <span class="c1"># When assigning patch coordinates</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">decimal_places</span><span class="p">)</span>
        <span class="n">y0</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">y0</span><span class="p">,</span> <span class="n">decimal_places</span><span class="p">)</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">decimal_places</span><span class="p">)</span>
        <span class="n">y1</span> <span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">y1</span><span class="p">,</span> <span class="n">decimal_places</span><span class="p">)</span>

        <span class="c1"># Update the &#39;patches&#39; column for cells within the current patch</span>
        <span class="k">if</span> <span class="n">tissue_type</span> <span class="o">==</span> <span class="s1">&#39;NormalLiver&#39;</span><span class="p">:</span>
            <span class="n">sample_name</span> <span class="o">=</span> <span class="s1">&#39;N&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sample_name</span> <span class="o">=</span> <span class="s1">&#39;C&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="n">liver_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span><span class="n">liver_df</span><span class="p">[</span><span class="s1">&#39;Run_Tissue_name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">tissue_type</span><span class="p">)</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="n">liver_df</span><span class="p">[</span><span class="s1">&#39;x_slide_um&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">x0</span><span class="p">)</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="n">liver_df</span><span class="p">[</span><span class="s1">&#39;x_slide_um&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">x1</span><span class="p">)</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="n">liver_df</span><span class="p">[</span><span class="s1">&#39;y_slide_um&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">y0</span><span class="p">)</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="n">liver_df</span><span class="p">[</span><span class="s1">&#39;y_slide_um&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">y1</span><span class="p">),</span>
            <span class="s1">&#39;sample&#39;</span>
        <span class="p">]</span> <span class="o">=</span> <span class="n">sample_name</span>

<span class="n">liver_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">liver_df</span><span class="p">[</span> <span class="p">(</span><span class="n">liver_df</span><span class="p">[</span><span class="s1">&#39;sample&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;-1&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Processing NormalLiver
Total number of patches: 10
[(1886.6148806917008, 10025.667690297836, 3486.614880691701, 11625.667690297836), (7967.310663046048, 8786.71629929017, 9567.310663046048, 10386.71629929017), (2196.0119891029517, 6592.722490085427, 3796.0119891029517, 8192.722490085427), (4408.565586928444, 9706.33596711446, 6008.565586928444, 11306.33596711446), (5070.607250708777, 5134.232285585302, 6670.607250708777, 6734.232285585302), (2302.5292319298533, 4397.568560631123, 3902.5292319298533, 5997.568560631123), (7121.82980264373, 6728.084803351514, 8721.82980264373, 8328.084803351514), (2416.6294404359564, 8200.149971508083, 4016.6294404359564, 9800.149971508083), (9767.184347122256, 6801.335263858796, 11367.184347122256, 8401.335263858797), (4050.9145487720484, 7052.114822553971, 5650.914548772049, 8652.114822553971)]
Processing CancerousLiver
Total number of patches: 10
[(8733.940845498759, 6956.522134005294, 10333.940845498759, 8556.522134005294), (959.7836280173957, 9924.939247260912, 2559.7836280173956, 11524.939247260912), (7711.752316668252, 3299.0830280094356, 9311.752316668251, 4899.083028009436), (7918.160165240158, 1593.40573536479, 9518.160165240159, 3193.40573536479), (1571.1241343269614, 6803.766233190506, 3171.124134326961, 8403.766233190505), (4669.1734372249175, 5584.331078425471, 6269.1734372249175, 7184.331078425471), (1642.1339927717302, 4862.145660802682, 3242.13399277173, 6462.145660802682), (2705.8975080433142, 9856.173593545518, 4305.897508043314, 11456.173593545518), (6011.6105483660085, -239.7283038551871, 7611.6105483660085, 1360.271696144813), (9435.311143736182, 3758.3641717244664, 11035.311143736182, 5358.364171724466)]
</pre></div></div>
</div>
</section>
<section id="Perform-Ecospatial-Analysis-on-one-sample">
<h2>Perform Ecospatial Analysis on one sample<a class="headerlink" href="#Perform-Ecospatial-Analysis-on-one-sample" title="Link to this heading"></a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[43]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test_sample</span> <span class="o">=</span> <span class="s1">&#39;N7&#39;</span>
<span class="n">patches_coordinates</span> <span class="o">=</span> <span class="n">eco</span><span class="o">.</span><span class="n">generate_patches</span><span class="p">(</span><span class="n">liver_df</span><span class="p">,</span>
                                           <span class="s1">&#39;sample&#39;</span><span class="p">,</span>
                                           <span class="n">test_sample</span><span class="p">,</span>
                                           <span class="n">scaling_factor</span><span class="o">=</span><span class="mf">32.</span><span class="p">,</span>
                                           <span class="n">spatial_key</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;x_slide_um&#39;</span><span class="p">,</span> <span class="s1">&#39;y_slide_um&#39;</span><span class="p">])</span>

<span class="n">patch_indices</span><span class="p">,</span> <span class="n">patches_comp</span> <span class="o">=</span> <span class="n">eco</span><span class="o">.</span><span class="n">calculate_diversity_index</span><span class="p">(</span><span class="n">spatial_data</span><span class="o">=</span><span class="n">liver_df</span><span class="p">,</span>
                                                            <span class="n">library_key</span><span class="o">=</span><span class="s1">&#39;sample&#39;</span><span class="p">,</span>
                                                            <span class="n">library_id</span><span class="o">=</span><span class="n">test_sample</span><span class="p">,</span>
                                                            <span class="n">spatial_key</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;x_slide_um&#39;</span><span class="p">,</span> <span class="s1">&#39;y_slide_um&#39;</span><span class="p">],</span>
                                                            <span class="n">patches</span><span class="o">=</span><span class="n">patches_coordinates</span><span class="p">,</span>
                                                            <span class="n">cluster_key</span><span class="o">=</span><span class="s1">&#39;cellType&#39;</span><span class="p">,</span>
                                                            <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;Shannon Diversity&#39;</span><span class="p">,</span> <span class="n">return_comp</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="c1"># Visualize the heterogeneity indices</span>
<span class="n">grid</span><span class="p">,</span> <span class="n">heatmap_fig</span> <span class="o">=</span> <span class="n">eco</span><span class="o">.</span><span class="n">diversity_heatmap</span><span class="p">(</span><span class="n">spatial_data</span><span class="o">=</span><span class="n">liver_df</span><span class="p">,</span>
                                          <span class="n">library_key</span><span class="o">=</span><span class="s1">&#39;sample&#39;</span><span class="p">,</span>
                                          <span class="n">library_id</span><span class="o">=</span><span class="n">test_sample</span><span class="p">,</span>
                                          <span class="n">spatial_key</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;x_slide_um&#39;</span><span class="p">,</span> <span class="s1">&#39;y_slide_um&#39;</span><span class="p">],</span>
                                          <span class="n">patches</span><span class="o">=</span><span class="n">patches_coordinates</span><span class="p">,</span>
                                          <span class="n">heterogeneity_indices</span><span class="o">=</span><span class="n">patch_indices</span><span class="p">,</span>
                                          <span class="n">tissue_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                          <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                          <span class="n">return_fig</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
1.953 per cent patches are empty
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_tutorials_MESA_tutorial_ecospatial_liver_10_1.png" src="../../_images/notebooks_tutorials_MESA_tutorial_ecospatial_liver_10_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[44]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">eco</span><span class="o">.</span><span class="n">global_spatial_stats</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">tissue_only</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Global spatial stats restricted to tissue region with w of shape (1004, 1004)
(0.09882209548413516, 0.001)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[45]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hotspots</span><span class="p">,</span> <span class="n">coldspots</span> <span class="o">=</span> <span class="n">eco</span><span class="o">.</span><span class="n">local_spatial_stats</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span><span class="n">tissue_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">p_value</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">plot_weights</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">hotspots</span><span class="o">.</span><span class="n">flatten</span><span class="p">()),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">coldspots</span><span class="o">.</span><span class="n">flatten</span><span class="p">()),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(1004,)
Local spatial stats restricted to tissue region with w of shape(1004, 1004)
Using MoranI
26
21
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[41]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Hot</span><span class="o">=</span><span class="kc">True</span>
<span class="k">if</span> <span class="n">Hot</span><span class="p">:</span>
    <span class="n">filtered_patches_coordinates</span> <span class="o">=</span> <span class="p">[</span><span class="n">patch</span> <span class="k">for</span> <span class="n">patch</span><span class="p">,</span> <span class="n">is_hotspot</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">patches_coordinates</span><span class="p">,</span> <span class="n">hotspots</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span> <span class="k">if</span> <span class="n">is_hotspot</span><span class="p">]</span>
    <span class="n">filtered_patches_comp</span> <span class="o">=</span> <span class="p">[</span><span class="n">patch</span> <span class="k">for</span> <span class="n">patch</span><span class="p">,</span> <span class="n">is_hotspot</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">patches_comp</span><span class="p">,</span> <span class="n">hotspots</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span> <span class="k">if</span> <span class="n">is_hotspot</span><span class="p">]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">filtered_patches_coordinates</span> <span class="o">=</span> <span class="p">[</span><span class="n">patch</span> <span class="k">for</span> <span class="n">patch</span><span class="p">,</span> <span class="n">is_coldspot</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">patches_coordinates</span><span class="p">,</span> <span class="n">coldspots</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span> <span class="k">if</span> <span class="n">is_coldspot</span><span class="p">]</span>
    <span class="n">filtered_patches_comp</span> <span class="o">=</span> <span class="p">[</span><span class="n">patch</span> <span class="k">for</span> <span class="n">patch</span><span class="p">,</span> <span class="n">is_coldspot</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">patches_comp</span><span class="p">,</span> <span class="n">coldspots</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span> <span class="k">if</span> <span class="n">is_coldspot</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[42]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">filtered_patches_comp</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[42]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
cellType
tumor_2                          42.0
tumor_1                         290.0
Periportal.LSECs                 31.0
Stellate.cells                   91.0
CD3+.alpha.beta.T.cells         184.0
Inflammatory.macrophages        206.0
Non.inflammatory.macrophages     53.0
NK.like.cells                     6.0
Central.venous.LSECs             14.0
Mature.B.cells                   39.0
gamma.delta.T.cells.1             3.0
Portal.endothelial.cells          2.0
Cholangiocytes                    1.0
dtype: float64
</pre></div></div>
</div>
</section>
<section id="Perform-Ecospatial-Analysis-on-all-samples">
<h2>Perform Ecospatial Analysis on all samples<a class="headerlink" href="#Perform-Ecospatial-Analysis-on-all-samples" title="Link to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">library_ids</span> <span class="o">=</span> <span class="n">liver_df</span><span class="p">[</span><span class="s1">&#39;sample&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">library_ids</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">library_ids</span> <span class="k">if</span> <span class="s1">&#39;N&#39;</span> <span class="ow">in</span> <span class="n">l</span> <span class="ow">or</span> <span class="s1">&#39;C&#39;</span> <span class="ow">in</span> <span class="n">l</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
<section id="Calculate-Global-Cell-Frequency-&amp;-Cell-Co-Occurrence">
<h3>Calculate Global Cell Frequency &amp; Cell Co-Occurrence<a class="headerlink" href="#Calculate-Global-Cell-Frequency-&-Cell-Co-Occurrence" title="Link to this heading"></a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">global_cellfreq_df</span><span class="p">,</span> <span class="n">global_co_occurrence_df</span> <span class="o">=</span> <span class="n">eco</span><span class="o">.</span><span class="n">spot_cellfreq</span><span class="p">(</span><span class="n">spatial_data</span><span class="o">=</span><span class="n">liver_df</span><span class="p">,</span>
                                                                <span class="n">scale</span><span class="o">=</span><span class="mf">32.0</span><span class="p">,</span>
                                                                <span class="n">library_key</span><span class="o">=</span><span class="s1">&#39;sample&#39;</span><span class="p">,</span>
                                                                <span class="n">library_id</span><span class="o">=</span><span class="n">library_ids</span><span class="p">,</span>
                                                                <span class="n">spatial_key</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;x_slide_um&#39;</span><span class="p">,</span> <span class="s1">&#39;y_slide_um&#39;</span><span class="p">],</span>
                                                                <span class="n">cluster_key</span><span class="o">=</span><span class="s1">&#39;cellType&#39;</span><span class="p">,</span>
                                                                <span class="n">spots</span><span class="o">=</span><span class="s1">&#39;global&#39;</span><span class="p">,</span>
                                                                <span class="n">top</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                                <span class="n">selected_comb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                                <span class="n">restricted</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                                <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;Shannon Diversity&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Processing region: N1 at scale 32.0
1.465 per cent patches are empty
Using MoranI
Considering whole tissue
Processing region: N7 at scale 32.0
1.953 per cent patches are empty
Using MoranI
Considering whole tissue
Processing region: N9 at scale 32.0
0.000 per cent patches are empty
Using MoranI
Considering whole tissue
Processing region: N6 at scale 32.0
0.195 per cent patches are empty
Using MoranI
Considering whole tissue
Processing region: N8 at scale 32.0
0.195 per cent patches are empty
Using MoranI
Considering whole tissue
Processing region: N2 at scale 32.0
0.000 per cent patches are empty
Using MoranI
Considering whole tissue
Processing region: N4 at scale 32.0
0.000 per cent patches are empty
Using MoranI
Considering whole tissue
Processing region: N5 at scale 32.0
0.098 per cent patches are empty
Using MoranI
Considering whole tissue
Processing region: N0 at scale 32.0
0.684 per cent patches are empty
Using MoranI
Considering whole tissue
Processing region: N3 at scale 32.0
0.195 per cent patches are empty
Using MoranI
Considering whole tissue
Processing region: C4 at scale 32.0
0.000 per cent patches are empty
Using MoranI
Considering whole tissue
Processing region: C0 at scale 32.0
0.000 per cent patches are empty
Using MoranI
Considering whole tissue
Processing region: C1 at scale 32.0
1.953 per cent patches are empty
Using MoranI
Considering whole tissue
Processing region: C5 at scale 32.0
0.000 per cent patches are empty
Using MoranI
Considering whole tissue
Processing region: C6 at scale 32.0
4.297 per cent patches are empty
Using MoranI
Considering whole tissue
Processing region: C7 at scale 32.0
0.000 per cent patches are empty
Using MoranI
Considering whole tissue
Processing region: C9 at scale 32.0
1.953 per cent patches are empty
Using MoranI
Considering whole tissue
Processing region: C2 at scale 32.0
0.000 per cent patches are empty
Using MoranI
Considering whole tissue
Processing region: C3 at scale 32.0
2.930 per cent patches are empty
Using MoranI
Considering whole tissue
Processing region: C8 at scale 32.0
6.348 per cent patches are empty
Using MoranI
Considering whole tissue
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">global_cellfreq_df</span><span class="p">[</span><span class="s1">&#39;Condition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span>
<span class="n">global_cellfreq_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">global_cellfreq_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;N&#39;</span><span class="p">),</span> <span class="s1">&#39;Condition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Healthy&#39;</span>
<span class="n">global_cellfreq_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">global_cellfreq_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">),</span> <span class="s1">&#39;Condition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;HCC&#39;</span>

<span class="n">global_co_occurrence_subcols</span> <span class="o">=</span> <span class="n">global_co_occurrence_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">global_co_occurrence_df</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">&gt;</span><span class="mf">0.05</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">global_co_occurrence_df</span><span class="p">[</span><span class="s1">&#39;Condition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span>
<span class="n">global_co_occurrence_df</span><span class="p">[</span><span class="s1">&#39;sample&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">global_co_occurrence_df</span><span class="o">.</span><span class="n">index</span>
<span class="n">global_co_occurrence_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">global_co_occurrence_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;N&#39;</span><span class="p">),</span> <span class="s1">&#39;Condition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Healthy&#39;</span>
<span class="n">global_co_occurrence_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">global_co_occurrence_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">),</span> <span class="s1">&#39;Condition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;HCC&#39;</span>
<span class="n">global_co_occurrence_subcols</span><span class="o">.</span><span class="n">extend</span><span class="p">([(</span><span class="s1">&#39;Condition&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">),(</span><span class="s1">&#39;sample&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)])</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Melt the dataframe for easier plotting and statistical analysis</span>
<span class="n">global_cellfreq_df_melt</span> <span class="o">=</span> <span class="n">global_cellfreq_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">id_vars</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sample&#39;</span><span class="p">,</span> <span class="s1">&#39;Condition&#39;</span><span class="p">])</span>
<span class="n">global_cellfreq_df_melt</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sample&#39;</span><span class="p">,</span> <span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="s1">&#39;cellType&#39;</span><span class="p">,</span> <span class="s1">&#39;Frequency&#39;</span><span class="p">]</span>

<span class="n">global_cellfreq_df_melt</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>sample</th>
      <th>group</th>
      <th>cellType</th>
      <th>Frequency</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>C0</td>
      <td>HCC</td>
      <td>Antibody.secreting.B.cells</td>
      <td>0.001204</td>
    </tr>
    <tr>
      <th>1</th>
      <td>C1</td>
      <td>HCC</td>
      <td>Antibody.secreting.B.cells</td>
      <td>0.000233</td>
    </tr>
    <tr>
      <th>2</th>
      <td>C2</td>
      <td>HCC</td>
      <td>Antibody.secreting.B.cells</td>
      <td>0.003202</td>
    </tr>
    <tr>
      <th>3</th>
      <td>C3</td>
      <td>HCC</td>
      <td>Antibody.secreting.B.cells</td>
      <td>0.004519</td>
    </tr>
    <tr>
      <th>4</th>
      <td>C4</td>
      <td>HCC</td>
      <td>Antibody.secreting.B.cells</td>
      <td>0.001152</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>435</th>
      <td>N5</td>
      <td>Healthy</td>
      <td>tumor_2</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>436</th>
      <td>N6</td>
      <td>Healthy</td>
      <td>tumor_2</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>437</th>
      <td>N7</td>
      <td>Healthy</td>
      <td>tumor_2</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>438</th>
      <td>N8</td>
      <td>Healthy</td>
      <td>tumor_2</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>439</th>
      <td>N9</td>
      <td>Healthy</td>
      <td>tumor_2</td>
      <td>0.000000</td>
    </tr>
  </tbody>
</table>
<p>440 rows × 4 columns</p>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Perform t-tests</span>
<span class="n">selected_cell_types</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">liver_df</span><span class="p">[</span><span class="s1">&#39;cellType&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="n">selected_p_values</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">ct</span> <span class="ow">in</span> <span class="n">selected_cell_types</span><span class="p">:</span>
    <span class="n">group1</span> <span class="o">=</span> <span class="n">global_cellfreq_df_melt</span><span class="p">[(</span><span class="n">global_cellfreq_df_melt</span><span class="p">[</span><span class="s1">&#39;cellType&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ct</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">global_cellfreq_df_melt</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Healthy&#39;</span><span class="p">)][</span><span class="s1">&#39;Frequency&#39;</span><span class="p">]</span>
    <span class="n">group2</span> <span class="o">=</span> <span class="n">global_cellfreq_df_melt</span><span class="p">[(</span><span class="n">global_cellfreq_df_melt</span><span class="p">[</span><span class="s1">&#39;cellType&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ct</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">global_cellfreq_df_melt</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;HCC&#39;</span><span class="p">)][</span><span class="s1">&#39;Frequency&#39;</span><span class="p">]</span>
    <span class="n">t_stat</span><span class="p">,</span> <span class="n">p_value</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">ttest_ind</span><span class="p">(</span><span class="n">group1</span><span class="p">,</span> <span class="n">group2</span><span class="p">,</span> <span class="n">equal_var</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ct</span><span class="si">}</span><span class="s2"> has p value of </span><span class="si">{</span><span class="n">p_value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">selected_p_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_value</span><span class="p">)</span>

<span class="n">pvals_corrected</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">false_discovery_control</span><span class="p">(</span><span class="n">selected_p_values</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;bh&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">42</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;p-values after correction:&quot;</span><span class="p">)</span>

<span class="c1"># Plot</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">global_cellfreq_df_melt</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;cellType&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;Frequency&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="s1">&#39;muted&#39;</span><span class="p">,</span> <span class="n">boxprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">.3</span><span class="p">),</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">dodge</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">selected_cell_types</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">swarmplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">global_cellfreq_df_melt</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;cellType&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;Frequency&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="s1">&#39;dark:black&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">dodge</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">selected_cell_types</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">handles</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">labels</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Groups&quot;</span><span class="p">,</span> <span class="n">handletextpad</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">columnspacing</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>

<span class="n">p_vals_corrected_dict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">yrange</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ct</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">selected_cell_types</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">yrange</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;p = </span><span class="si">{</span><span class="n">pvals_corrected</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ct</span><span class="si">}</span><span class="s2"> has p value = </span><span class="si">{</span><span class="n">pvals_corrected</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">p_vals_corrected_dict</span><span class="p">[</span><span class="n">ct</span><span class="p">]</span> <span class="o">=</span> <span class="n">pvals_corrected</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">selected_cell_types</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mf">0.55</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Frequency&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Antibody.secreting.B.cells has p value of 0.7253105069107637
CD3+.alpha.beta.T.cells has p value of 0.6688961489467853
Central.venous.LSECs has p value of 1.3650725054199515e-09
Cholangiocytes has p value of 5.184474315672871e-05
Erthyroid.cells has p value of 1.962577398118726e-08
Hep has p value of 0.3128233608731258
Hep.1 has p value of 1.4655635733085782e-05
Hep.3 has p value of 2.517630979080062e-10
Hep.4 has p value of 5.087963668099555e-10
Hep.5 has p value of 3.9066463036613865e-11
Hep.6 has p value of 2.0930984873598823e-06
Inflammatory.macrophages has p value of 0.14611237799276483
Mature.B.cells has p value of 0.5028132228052369
NK.like.cells has p value of 3.7138952557959555e-07
Non.inflammatory.macrophages has p value of 0.3171705903870426
NotDet has p value of 0.9868237859133563
Periportal.LSECs has p value of 0.3792861739107447
Portal.endothelial.cells has p value of 0.042454116173829735
Stellate.cells has p value of 0.0038202017195151047
gamma.delta.T.cells.1 has p value of 8.353966741526583e-06
tumor_1 has p value of 6.801927672934746e-07
tumor_2 has p value of 0.002071201681775486
------------------------------------------
p-values after correction:
Antibody.secreting.B.cells has p value = 0.760
CD3+.alpha.beta.T.cells has p value = 0.736
Central.venous.LSECs has p value = 0.000
Cholangiocytes has p value = 0.000
Erthyroid.cells has p value = 0.000
Hep has p value = 0.410
Hep.1 has p value = 0.000
Hep.3 has p value = 0.000
Hep.4 has p value = 0.000
Hep.5 has p value = 0.000
Hep.6 has p value = 0.000
Inflammatory.macrophages has p value = 0.214
Mature.B.cells has p value = 0.582
NK.like.cells has p value = 0.000
Non.inflammatory.macrophages has p value = 0.410
NotDet has p value = 0.987
Periportal.LSECs has p value = 0.464
Portal.endothelial.cells has p value = 0.067
Stellate.cells has p value = 0.006
gamma.delta.T.cells.1 has p value = 0.000
tumor_1 has p value = 0.000
tumor_2 has p value = 0.004
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_tutorials_MESA_tutorial_ecospatial_liver_21_1.png" src="../../_images/notebooks_tutorials_MESA_tutorial_ecospatial_liver_21_1.png" />
</div>
</div>
</section>
<section id="Calculate-Cell-Frequency-and-Cell-Co-Occurrence-in-hot/coldspots">
<h3>Calculate Cell Frequency and Cell Co-Occurrence in hot/coldspots<a class="headerlink" href="#Calculate-Cell-Frequency-and-Cell-Co-Occurrence-in-hot/coldspots" title="Link to this heading"></a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spot_cellfreq_df</span><span class="p">,</span> <span class="n">spot_co_occurrence_df</span> <span class="o">=</span> <span class="n">eco</span><span class="o">.</span><span class="n">spot_cellfreq</span><span class="p">(</span><span class="n">spatial_data</span><span class="o">=</span><span class="n">liver_df</span><span class="p">,</span>
                                                            <span class="n">scale</span><span class="o">=</span><span class="mf">32.0</span><span class="p">,</span>
                                                            <span class="n">library_key</span><span class="o">=</span><span class="s1">&#39;sample&#39;</span><span class="p">,</span>
                                                            <span class="n">library_id</span><span class="o">=</span><span class="n">library_ids</span><span class="p">,</span>
                                                            <span class="n">spatial_key</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;x_slide_um&#39;</span><span class="p">,</span> <span class="s1">&#39;y_slide_um&#39;</span><span class="p">],</span>
                                                            <span class="n">cluster_key</span><span class="o">=</span><span class="s1">&#39;cellType&#39;</span><span class="p">,</span>
                                                            <span class="n">spots</span><span class="o">=</span><span class="s1">&#39;hot&#39;</span><span class="p">,</span>
                                                            <span class="n">top</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                            <span class="n">selected_comb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                            <span class="n">restricted</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                            <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;Shannon Diversity&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Processing region: N1 at scale 32.0
1.465 per cent patches are empty
(1009,)
Local spatial stats restricted to tissue region with w of shape(1009, 1009)
Using MoranI
Region N1 contains 6 diversity hotspots
Processing region: N7 at scale 32.0
1.953 per cent patches are empty
(1004,)
Local spatial stats restricted to tissue region with w of shape(1004, 1004)
Using MoranI
Region N7 contains 26 diversity hotspots
Processing region: N9 at scale 32.0
0.000 per cent patches are empty
(1024,)
Local spatial stats restricted to tissue region with w of shape(1024, 1024)
Using MoranI
Region N9 contains 13 diversity hotspots
Processing region: N6 at scale 32.0
0.195 per cent patches are empty
(1022,)
Local spatial stats restricted to tissue region with w of shape(1022, 1022)
Using MoranI
Region N6 contains 13 diversity hotspots
Processing region: N8 at scale 32.0
0.195 per cent patches are empty
(1022,)
Local spatial stats restricted to tissue region with w of shape(1022, 1022)
Using MoranI
Region N8 contains 14 diversity hotspots
Processing region: N2 at scale 32.0
0.000 per cent patches are empty
(1024,)
Local spatial stats restricted to tissue region with w of shape(1024, 1024)
Using MoranI
Region N2 contains 2 diversity hotspots
Processing region: N4 at scale 32.0
0.000 per cent patches are empty
(1024,)
Local spatial stats restricted to tissue region with w of shape(1024, 1024)
Using MoranI
Region N4 contains 24 diversity hotspots
Processing region: N5 at scale 32.0
0.098 per cent patches are empty
(1023,)
Local spatial stats restricted to tissue region with w of shape(1023, 1023)
Using MoranI
Region N5 contains 26 diversity hotspots
Processing region: N0 at scale 32.0
0.684 per cent patches are empty
(1017,)
Local spatial stats restricted to tissue region with w of shape(1017, 1017)
Using MoranI
Region N0 contains 30 diversity hotspots
Processing region: N3 at scale 32.0
0.195 per cent patches are empty
(1022,)
Local spatial stats restricted to tissue region with w of shape(1022, 1022)
Using MoranI
Region N3 contains 3 diversity hotspots
Processing region: C4 at scale 32.0
0.000 per cent patches are empty
(1024,)
Local spatial stats restricted to tissue region with w of shape(1024, 1024)
Using MoranI
Region C4 contains 77 diversity hotspots
Processing region: C0 at scale 32.0
0.000 per cent patches are empty
(1024,)
Local spatial stats restricted to tissue region with w of shape(1024, 1024)
Using MoranI
Region C0 contains 15 diversity hotspots
Processing region: C1 at scale 32.0
1.953 per cent patches are empty
(1004,)
Local spatial stats restricted to tissue region with w of shape(1004, 1004)
Using MoranI
Region C1 contains 17 diversity hotspots
Processing region: C5 at scale 32.0
0.000 per cent patches are empty
(1024,)
Local spatial stats restricted to tissue region with w of shape(1024, 1024)
Using MoranI
Region C5 contains 47 diversity hotspots
Processing region: C6 at scale 32.0
4.297 per cent patches are empty
(980,)
Local spatial stats restricted to tissue region with w of shape(980, 980)
Using MoranI
Region C6 contains 67 diversity hotspots
Processing region: C7 at scale 32.0
0.000 per cent patches are empty
(1024,)
Local spatial stats restricted to tissue region with w of shape(1024, 1024)
Using MoranI
Region C7 contains 98 diversity hotspots
Processing region: C9 at scale 32.0
1.953 per cent patches are empty
(1004,)
Local spatial stats restricted to tissue region with w of shape(1004, 1004)
Using MoranI
Region C9 contains 19 diversity hotspots
Processing region: C2 at scale 32.0
0.000 per cent patches are empty
(1024,)
Local spatial stats restricted to tissue region with w of shape(1024, 1024)
Using MoranI
Region C2 contains 26 diversity hotspots
Processing region: C3 at scale 32.0
2.930 per cent patches are empty
(994,)
Local spatial stats restricted to tissue region with w of shape(994, 994)
Using MoranI
Region C3 contains 81 diversity hotspots
Processing region: C8 at scale 32.0
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/Users/Emrys/MESA/docs/notebooks/tutorials/../../../mesa/ecospatial/_ecospatial.py:111: UserWarning: The weights matrix is not fully connected:
 There are 2 disconnected components.
 There is 1 island with id: 46.
  w_new = weights.W(neighbors=new_neighbors, weights=new_weights)
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
6.348 per cent patches are empty
(959,)
Local spatial stats restricted to tissue region with w of shape(959, 959)
Using MoranI
Region C8 contains 25 diversity hotspots
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/Users/Emrys/MESA/docs/notebooks/tutorials/../../../mesa/ecospatial/_ecospatial.py:111: UserWarning: The weights matrix is not fully connected:
 There are 3 disconnected components.
 There are 2 islands with ids: 31, 35.
  w_new = weights.W(neighbors=new_neighbors, weights=new_weights)
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spot_cellfreq_df</span><span class="p">[</span><span class="s1">&#39;Condition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span>
<span class="k">if</span> <span class="s1">&#39;NotDet&#39;</span> <span class="ow">in</span> <span class="n">spot_cellfreq_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="n">spot_cellfreq_df</span> <span class="o">=</span> <span class="n">spot_cellfreq_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;NotDet&#39;</span><span class="p">)</span>
<span class="n">spot_cellfreq_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spot_cellfreq_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;N&#39;</span><span class="p">),</span> <span class="s1">&#39;Condition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Healthy&#39;</span>
<span class="n">spot_cellfreq_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spot_cellfreq_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">),</span> <span class="s1">&#39;Condition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;HCC&#39;</span>

<span class="n">spot_co_occurrence_subcols</span> <span class="o">=</span> <span class="n">spot_co_occurrence_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">spot_co_occurrence_df</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">&gt;</span><span class="mf">0.05</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">spot_co_occurrence_df</span><span class="p">[</span><span class="s1">&#39;Condition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span>
<span class="n">spot_co_occurrence_df</span><span class="p">[</span><span class="s1">&#39;sample&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spot_co_occurrence_df</span><span class="o">.</span><span class="n">index</span>
<span class="n">spot_co_occurrence_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spot_co_occurrence_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;N&#39;</span><span class="p">),</span> <span class="s1">&#39;Condition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Healthy&#39;</span>
<span class="n">spot_co_occurrence_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spot_co_occurrence_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">),</span> <span class="s1">&#39;Condition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;HCC&#39;</span>
<span class="n">spot_co_occurrence_subcols</span><span class="o">.</span><span class="n">extend</span><span class="p">([(</span><span class="s1">&#39;Condition&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">),(</span><span class="s1">&#39;sample&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)])</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spot_cellfreq_df</span><span class="p">[</span><span class="s1">&#39;sample&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spot_cellfreq_df</span><span class="o">.</span><span class="n">index</span>

<span class="c1"># Melt the DataFrame</span>
<span class="n">spot_cellfreq_df_melt</span> <span class="o">=</span> <span class="n">spot_cellfreq_df</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">id_vars</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sample&#39;</span><span class="p">,</span> <span class="s1">&#39;Condition&#39;</span><span class="p">],</span> <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;CellType&#39;</span><span class="p">,</span> <span class="n">value_name</span><span class="o">=</span><span class="s1">&#39;Frequency&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spot_cellfreq_df_melt</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>sample</th>
      <th>Condition</th>
      <th>CellType</th>
      <th>Frequency</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>N1</td>
      <td>Healthy</td>
      <td>Antibody.secreting.B.cells</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>N7</td>
      <td>Healthy</td>
      <td>Antibody.secreting.B.cells</td>
      <td>0.042184</td>
    </tr>
    <tr>
      <th>2</th>
      <td>N9</td>
      <td>Healthy</td>
      <td>Antibody.secreting.B.cells</td>
      <td>0.028409</td>
    </tr>
    <tr>
      <th>3</th>
      <td>N6</td>
      <td>Healthy</td>
      <td>Antibody.secreting.B.cells</td>
      <td>0.040201</td>
    </tr>
    <tr>
      <th>4</th>
      <td>N8</td>
      <td>Healthy</td>
      <td>Antibody.secreting.B.cells</td>
      <td>0.012658</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>415</th>
      <td>C7</td>
      <td>HCC</td>
      <td>tumor_2</td>
      <td>0.043659</td>
    </tr>
    <tr>
      <th>416</th>
      <td>C9</td>
      <td>HCC</td>
      <td>tumor_2</td>
      <td>0.091346</td>
    </tr>
    <tr>
      <th>417</th>
      <td>C2</td>
      <td>HCC</td>
      <td>tumor_2</td>
      <td>0.207407</td>
    </tr>
    <tr>
      <th>418</th>
      <td>C3</td>
      <td>HCC</td>
      <td>tumor_2</td>
      <td>0.125506</td>
    </tr>
    <tr>
      <th>419</th>
      <td>C8</td>
      <td>HCC</td>
      <td>tumor_2</td>
      <td>0.000000</td>
    </tr>
  </tbody>
</table>
<p>420 rows × 4 columns</p>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">selected_cell_types</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">spot_cellfreq_df_melt</span><span class="p">[</span><span class="s1">&#39;CellType&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="n">selected_p_values</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Perform t-tests</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;p-value before correction:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">ct</span> <span class="ow">in</span> <span class="n">selected_cell_types</span><span class="p">:</span> <span class="c1"># df_melted[&#39;CellType&#39;].unique():</span>
    <span class="n">subset</span> <span class="o">=</span> <span class="n">spot_cellfreq_df_melt</span><span class="p">[</span><span class="n">spot_cellfreq_df_melt</span><span class="p">[</span><span class="s1">&#39;CellType&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ct</span><span class="p">]</span>
    <span class="n">group1</span> <span class="o">=</span> <span class="n">subset</span><span class="p">[</span><span class="n">subset</span><span class="p">[</span><span class="s1">&#39;Condition&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Healthy&#39;</span><span class="p">][</span><span class="s1">&#39;Frequency&#39;</span><span class="p">]</span>
    <span class="n">group2</span> <span class="o">=</span> <span class="n">subset</span><span class="p">[</span><span class="n">subset</span><span class="p">[</span><span class="s1">&#39;Condition&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;HCC&#39;</span><span class="p">][</span><span class="s1">&#39;Frequency&#39;</span><span class="p">]</span>

    <span class="n">t_stat</span><span class="p">,</span> <span class="n">p_value</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">ttest_ind</span><span class="p">(</span><span class="n">group1</span><span class="p">,</span> <span class="n">group2</span><span class="p">,</span> <span class="n">equal_var</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ct</span><span class="si">}</span><span class="s2"> has p value = </span><span class="si">{</span><span class="n">p_value</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">selected_p_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_value</span><span class="p">)</span>

<span class="c1"># Filter the dataframe based on selected CellTypes</span>
<span class="n">df_filtered</span> <span class="o">=</span> <span class="n">spot_cellfreq_df_melt</span><span class="p">[</span><span class="n">spot_cellfreq_df_melt</span><span class="p">[</span><span class="s1">&#39;CellType&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">selected_cell_types</span><span class="p">)]</span>

<span class="c1"># Plot the filtered data</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df_filtered</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;CellType&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;Frequency&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;Condition&#39;</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="s1">&#39;muted&#39;</span><span class="p">,</span> <span class="n">boxprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">.3</span><span class="p">),</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">dodge</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="n">selected_cell_types</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">swarmplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df_filtered</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;CellType&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;Frequency&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;Condition&#39;</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="s1">&#39;dark:black&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">dodge</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">selected_cell_types</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="n">handles</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">labels</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Groups&quot;</span><span class="p">,</span> <span class="n">handletextpad</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">columnspacing</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">spot_pvals_corrected</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">false_discovery_control</span><span class="p">(</span><span class="n">selected_p_values</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;bh&#39;</span><span class="p">)</span>
<span class="n">spot_pvals_corrected</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="p">:</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="p">,</span> <span class="n">selected_cell_types</span><span class="p">,</span> <span class="n">spot_pvals_corrected</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">42</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;p-values after correction: &quot;</span><span class="p">)</span>

<span class="n">yrange</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ct</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">selected_cell_types</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">yrange</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;p = </span><span class="si">{</span><span class="n">spot_pvals_corrected</span><span class="p">[</span><span class="n">ct</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ct</span><span class="si">}</span><span class="s2"> in hot spots has p value = </span><span class="si">{</span><span class="n">spot_pvals_corrected</span><span class="p">[</span><span class="n">ct</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">spot_pvals_corrected</span><span class="p">[</span><span class="n">ct</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.05</span> <span class="ow">and</span> <span class="n">p_vals_corrected_dict</span><span class="p">[</span><span class="n">ct</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.05</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ct</span><span class="si">}</span><span class="s2"> in whole tissue has p value = </span><span class="si">{</span><span class="n">p_vals_corrected_dict</span><span class="p">[</span><span class="n">ct</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="o">*</span><span class="mi">42</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">selected_cell_types</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mf">0.55</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Frequency&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
p-value before correction:
Antibody.secreting.B.cells has p value = 0.6141
CD3+.alpha.beta.T.cells has p value = 0.0936
Central.venous.LSECs has p value = 0.0433
Cholangiocytes has p value = 0.0485
Erthyroid.cells has p value = 0.0451
Hep has p value = 0.2253
Hep.1 has p value = 0.0046
Hep.3 has p value = 0.0001
Hep.4 has p value = 0.0001
Hep.5 has p value = 0.0002
Hep.6 has p value = 0.0055
Inflammatory.macrophages has p value = 0.0018
Mature.B.cells has p value = 0.0876
NK.like.cells has p value = 0.0342
Non.inflammatory.macrophages has p value = 0.2004
Periportal.LSECs has p value = 0.5968
Portal.endothelial.cells has p value = 0.5409
Stellate.cells has p value = 0.3656
gamma.delta.T.cells.1 has p value = 0.4125
tumor_1 has p value = 0.0000
tumor_2 has p value = 0.0020
------------------------------------------
p-values after correction:
Antibody.secreting.B.cells in hot spots has p value = 0.614
CD3+.alpha.beta.T.cells in hot spots has p value = 0.140
Central.venous.LSECs in hot spots has p value = 0.085
Cholangiocytes in hot spots has p value = 0.085
Erthyroid.cells in hot spots has p value = 0.085
Hep in hot spots has p value = 0.296
Hep.1 in hot spots has p value = 0.014
Hep.3 in hot spots has p value = 0.001
Hep.4 in hot spots has p value = 0.001
Hep.5 in hot spots has p value = 0.001
Hep.6 in hot spots has p value = 0.014
Inflammatory.macrophages in hot spots has p value = 0.007
Inflammatory.macrophages in whole tissue has p value = 0.214
******************************************
Mature.B.cells in hot spots has p value = 0.140
NK.like.cells in hot spots has p value = 0.080
Non.inflammatory.macrophages in hot spots has p value = 0.281
Periportal.LSECs in hot spots has p value = 0.614
Portal.endothelial.cells in hot spots has p value = 0.598
Stellate.cells in hot spots has p value = 0.452
gamma.delta.T.cells.1 in hot spots has p value = 0.481
tumor_1 in hot spots has p value = 0.000
tumor_2 in hot spots has p value = 0.007
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_tutorials_MESA_tutorial_ecospatial_liver_27_1.png" src="../../_images/notebooks_tutorials_MESA_tutorial_ecospatial_liver_27_1.png" />
</div>
</div>
</section>
<section id="Process-Cell-Co-Occurrence-Dataframe">
<h3>Process Cell Co-Occurrence Dataframe<a class="headerlink" href="#Process-Cell-Co-Occurrence-Dataframe" title="Link to this heading"></a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">union_cols</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">global_co_occurrence_subcols</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">spot_co_occurrence_subcols</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Make them have the same set of columns</span>
<span class="n">global_co_occurrence_df</span> <span class="o">=</span> <span class="n">global_co_occurrence_df</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">union_cols</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">spot_co_occurrence_df</span> <span class="o">=</span> <span class="n">spot_co_occurrence_df</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">union_cols</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Global Cell Co-Occurrence</span>
<span class="c1"># Multi-index to single-index column</span>
<span class="n">new_columns</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">global_co_occurrence_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>  <span class="c1"># This checks if the column is a MultiIndex</span>
        <span class="c1"># Join only if the column name is not &#39;Mouse&#39; or &#39;Condition&#39;</span>
        <span class="k">if</span> <span class="s2">&quot;sample&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">col</span> <span class="ow">and</span> <span class="s2">&quot;Condition&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">col</span><span class="p">:</span>
            <span class="n">new_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&amp;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">col</span><span class="p">))</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If &#39;Mouse&#39; or &#39;Condition&#39; is in the column, it is not joined with &#39;&amp;&#39;</span>
            <span class="n">new_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">new_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>

<span class="n">global_co_occurrence_df_single</span> <span class="o">=</span> <span class="n">global_co_occurrence_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">global_co_occurrence_df_single</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">new_columns</span>
<span class="n">global_co_occurrence_df_single</span> <span class="o">=</span> <span class="n">global_co_occurrence_df_single</span><span class="p">[[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">global_co_occurrence_df_single</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s1">&#39;NotDet&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">col</span><span class="p">]]</span>

<span class="c1"># Melt the DataFrame</span>
<span class="n">global_co_occurrence_melted</span> <span class="o">=</span> <span class="n">global_co_occurrence_df_single</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">id_vars</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sample&#39;</span><span class="p">,</span> <span class="s1">&#39;Condition&#39;</span><span class="p">],</span> <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;Cell Combination&#39;</span><span class="p">,</span> <span class="n">value_name</span><span class="o">=</span><span class="s1">&#39;Frequency&#39;</span><span class="p">)</span>
<span class="n">global_co_occurrence_melted</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>sample</th>
      <th>Condition</th>
      <th>Cell Combination</th>
      <th>Frequency</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>N1</td>
      <td>Healthy</td>
      <td>Periportal.LSECs&amp;tumor_1</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>N7</td>
      <td>Healthy</td>
      <td>Periportal.LSECs&amp;tumor_1</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>N9</td>
      <td>Healthy</td>
      <td>Periportal.LSECs&amp;tumor_1</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>N6</td>
      <td>Healthy</td>
      <td>Periportal.LSECs&amp;tumor_1</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>N8</td>
      <td>Healthy</td>
      <td>Periportal.LSECs&amp;tumor_1</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>1555</th>
      <td>C7</td>
      <td>HCC</td>
      <td>CD3+.alpha.beta.T.cells&amp;Hep.6</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>1556</th>
      <td>C9</td>
      <td>HCC</td>
      <td>CD3+.alpha.beta.T.cells&amp;Hep.6</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>1557</th>
      <td>C2</td>
      <td>HCC</td>
      <td>CD3+.alpha.beta.T.cells&amp;Hep.6</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>1558</th>
      <td>C3</td>
      <td>HCC</td>
      <td>CD3+.alpha.beta.T.cells&amp;Hep.6</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>1559</th>
      <td>C8</td>
      <td>HCC</td>
      <td>CD3+.alpha.beta.T.cells&amp;Hep.6</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
<p>1560 rows × 4 columns</p>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Global Cell Co-Occurrence</span>
<span class="n">selected_cell_types</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">global_co_occurrence_melted</span><span class="p">[</span><span class="s1">&#39;Cell Combination&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="n">selected_p_values</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Perform t-tests</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;p-value before correction:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">ct</span> <span class="ow">in</span> <span class="n">selected_cell_types</span><span class="p">:</span>
    <span class="n">subset</span> <span class="o">=</span> <span class="n">global_co_occurrence_melted</span><span class="p">[</span><span class="n">global_co_occurrence_melted</span><span class="p">[</span><span class="s1">&#39;Cell Combination&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ct</span><span class="p">]</span>
    <span class="n">group1</span> <span class="o">=</span> <span class="n">subset</span><span class="p">[</span><span class="n">subset</span><span class="p">[</span><span class="s1">&#39;Condition&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Healthy&#39;</span><span class="p">][</span><span class="s1">&#39;Frequency&#39;</span><span class="p">]</span>
    <span class="n">group2</span> <span class="o">=</span> <span class="n">subset</span><span class="p">[</span><span class="n">subset</span><span class="p">[</span><span class="s1">&#39;Condition&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;HCC&#39;</span><span class="p">][</span><span class="s1">&#39;Frequency&#39;</span><span class="p">]</span>

    <span class="n">t_stat</span><span class="p">,</span> <span class="n">p_value</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">ttest_ind</span><span class="p">(</span><span class="n">group1</span><span class="p">,</span> <span class="n">group2</span><span class="p">,</span> <span class="n">equal_var</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ct</span><span class="si">}</span><span class="s2"> has p value = </span><span class="si">{</span><span class="n">p_value</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">selected_p_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_value</span><span class="p">)</span>

<span class="c1"># Filter the dataframe based on selected Cell Combinations</span>
<span class="n">df_filtered</span> <span class="o">=</span> <span class="n">global_co_occurrence_melted</span><span class="p">[</span><span class="n">global_co_occurrence_melted</span><span class="p">[</span><span class="s1">&#39;Cell Combination&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">selected_cell_types</span><span class="p">)]</span>

<span class="c1"># Plot the filtered data</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">45</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df_filtered</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;Cell Combination&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;Frequency&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;Condition&#39;</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="s1">&#39;muted&#39;</span><span class="p">,</span> <span class="n">boxprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">.3</span><span class="p">),</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">dodge</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="n">selected_cell_types</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">swarmplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df_filtered</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;Cell Combination&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;Frequency&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;Condition&#39;</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="s1">&#39;dark:black&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">dodge</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="n">selected_cell_types</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="n">handles</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">labels</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Groups&quot;</span><span class="p">,</span> <span class="n">handletextpad</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">columnspacing</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">pvals_corrected</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">false_discovery_control</span><span class="p">(</span><span class="n">selected_p_values</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;bh&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">42</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;p-values after correction:&quot;</span><span class="p">)</span>

<span class="n">p_vals_corrected_dict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">yrange</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ct</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">selected_cell_types</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">yrange</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;p = </span><span class="si">{</span><span class="n">pvals_corrected</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ct</span><span class="si">}</span><span class="s2"> has p value = </span><span class="si">{</span><span class="n">pvals_corrected</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">p_vals_corrected_dict</span><span class="p">[</span><span class="n">ct</span><span class="p">]</span> <span class="o">=</span> <span class="n">pvals_corrected</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">selected_cell_types</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mf">0.55</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Frequency&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
p-value before correction:
Antibody.secreting.B.cells&amp;CD3+.alpha.beta.T.cells has p value = 0.962
Antibody.secreting.B.cells&amp;Inflammatory.macrophages has p value = 0.734
Antibody.secreting.B.cells&amp;Mature.B.cells has p value = 0.560
Antibody.secreting.B.cells&amp;Periportal.LSECs has p value = 0.111
Antibody.secreting.B.cells&amp;Stellate.cells has p value = 0.406
CD3+.alpha.beta.T.cells&amp;Central.venous.LSECs has p value = 0.001
CD3+.alpha.beta.T.cells&amp;Cholangiocytes has p value = 0.000
CD3+.alpha.beta.T.cells&amp;Hep.1 has p value = 0.000
CD3+.alpha.beta.T.cells&amp;Hep.3 has p value = 0.000
CD3+.alpha.beta.T.cells&amp;Hep.4 has p value = 0.000
CD3+.alpha.beta.T.cells&amp;Hep.5 has p value = 0.000
CD3+.alpha.beta.T.cells&amp;Hep.6 has p value = 0.000
CD3+.alpha.beta.T.cells&amp;Inflammatory.macrophages has p value = 0.204
CD3+.alpha.beta.T.cells&amp;Mature.B.cells has p value = 0.420
CD3+.alpha.beta.T.cells&amp;NK.like.cells has p value = 0.004
CD3+.alpha.beta.T.cells&amp;Non.inflammatory.macrophages has p value = 0.945
CD3+.alpha.beta.T.cells&amp;Periportal.LSECs has p value = 0.044
CD3+.alpha.beta.T.cells&amp;Stellate.cells has p value = 0.123
CD3+.alpha.beta.T.cells&amp;tumor_1 has p value = 0.000
CD3+.alpha.beta.T.cells&amp;tumor_2 has p value = 0.000
Central.venous.LSECs&amp;Hep.1 has p value = 0.000
Central.venous.LSECs&amp;Hep.3 has p value = 0.000
Central.venous.LSECs&amp;Hep.4 has p value = 0.000
Central.venous.LSECs&amp;Hep.5 has p value = 0.000
Central.venous.LSECs&amp;Inflammatory.macrophages has p value = 0.223
Central.venous.LSECs&amp;Non.inflammatory.macrophages has p value = 0.000
Central.venous.LSECs&amp;Stellate.cells has p value = 0.000
Cholangiocytes&amp;Hep.4 has p value = 0.000
Cholangiocytes&amp;Inflammatory.macrophages has p value = 0.001
Cholangiocytes&amp;Mature.B.cells has p value = 0.001
Cholangiocytes&amp;Periportal.LSECs has p value = 0.000
Cholangiocytes&amp;Stellate.cells has p value = 0.000
Hep.1&amp;Hep.3 has p value = 0.000
Hep.1&amp;Hep.4 has p value = 0.000
Hep.1&amp;Hep.5 has p value = 0.000
Hep.1&amp;Hep.6 has p value = 0.000
Hep.1&amp;Inflammatory.macrophages has p value = 0.000
Hep.1&amp;Non.inflammatory.macrophages has p value = 0.000
Hep.1&amp;Stellate.cells has p value = 0.000
Hep.3&amp;Hep.4 has p value = 0.000
Hep.3&amp;Hep.5 has p value = 0.000
Hep.3&amp;Hep.6 has p value = 0.000
Hep.3&amp;Inflammatory.macrophages has p value = 0.000
Hep.3&amp;Mature.B.cells has p value = 0.000
Hep.3&amp;Non.inflammatory.macrophages has p value = 0.000
Hep.3&amp;Periportal.LSECs has p value = 0.000
Hep.3&amp;Stellate.cells has p value = 0.000
Hep.4&amp;Hep.5 has p value = 0.000
Hep.4&amp;Hep.6 has p value = 0.000
Hep.4&amp;Inflammatory.macrophages has p value = 0.000
Hep.4&amp;Mature.B.cells has p value = 0.000
Hep.4&amp;Non.inflammatory.macrophages has p value = 0.000
Hep.4&amp;Periportal.LSECs has p value = 0.000
Hep.4&amp;Stellate.cells has p value = 0.000
Hep.5&amp;Hep.6 has p value = 0.000
Hep.5&amp;Inflammatory.macrophages has p value = 0.000
Hep.5&amp;Non.inflammatory.macrophages has p value = 0.000
Hep.5&amp;Stellate.cells has p value = 0.000
Inflammatory.macrophages&amp;Mature.B.cells has p value = 0.157
Inflammatory.macrophages&amp;Non.inflammatory.macrophages has p value = 0.213
Inflammatory.macrophages&amp;Periportal.LSECs has p value = 0.013
Inflammatory.macrophages&amp;Stellate.cells has p value = 0.790
Inflammatory.macrophages&amp;tumor_1 has p value = 0.000
Inflammatory.macrophages&amp;tumor_2 has p value = 0.000
Mature.B.cells&amp;Non.inflammatory.macrophages has p value = 0.337
Mature.B.cells&amp;Periportal.LSECs has p value = 0.072
Mature.B.cells&amp;Stellate.cells has p value = 0.863
Mature.B.cells&amp;tumor_1 has p value = 0.000
NK.like.cells&amp;Stellate.cells has p value = 0.000
Non.inflammatory.macrophages&amp;Periportal.LSECs has p value = 0.004
Non.inflammatory.macrophages&amp;Stellate.cells has p value = 0.201
Non.inflammatory.macrophages&amp;tumor_1 has p value = 0.000
Periportal.LSECs&amp;Stellate.cells has p value = 0.616
Periportal.LSECs&amp;tumor_1 has p value = 0.000
Periportal.LSECs&amp;tumor_2 has p value = 0.001
Stellate.cells&amp;tumor_1 has p value = 0.000
Stellate.cells&amp;tumor_2 has p value = 0.000
tumor_1&amp;tumor_2 has p value = 0.001
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/var/folders/7g/phdhh_ld3dlbnrst0t60bwzr0000gn/T/ipykernel_73139/917667374.py:22: FutureWarning: Use &#34;auto&#34; to set automatic grayscale colors. From v0.14.0, &#34;gray&#34; will default to matplotlib&#39;s definition.
  sns.swarmplot(data=df_filtered, x=&#39;Cell Combination&#39;, y=&#39;Frequency&#39;, hue=&#39;Condition&#39;, palette=&#39;dark:black&#39;, size=1.0, dodge=True,order=selected_cell_types, ax=ax, edgecolor=&#39;gray&#39;, linewidth=0.5)
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
------------------------------------------
p-values after correction:
Antibody.secreting.B.cells&amp;CD3+.alpha.beta.T.cells has p value = 0.962
Antibody.secreting.B.cells&amp;Inflammatory.macrophages has p value = 0.773
Antibody.secreting.B.cells&amp;Mature.B.cells has p value = 0.607
Antibody.secreting.B.cells&amp;Periportal.LSECs has p value = 0.139
Antibody.secreting.B.cells&amp;Stellate.cells has p value = 0.452
CD3+.alpha.beta.T.cells&amp;Central.venous.LSECs has p value = 0.001
CD3+.alpha.beta.T.cells&amp;Cholangiocytes has p value = 0.000
CD3+.alpha.beta.T.cells&amp;Hep.1 has p value = 0.000
CD3+.alpha.beta.T.cells&amp;Hep.3 has p value = 0.000
CD3+.alpha.beta.T.cells&amp;Hep.4 has p value = 0.000
CD3+.alpha.beta.T.cells&amp;Hep.5 has p value = 0.000
CD3+.alpha.beta.T.cells&amp;Hep.6 has p value = 0.000
CD3+.alpha.beta.T.cells&amp;Inflammatory.macrophages has p value = 0.241
CD3+.alpha.beta.T.cells&amp;Mature.B.cells has p value = 0.461
CD3+.alpha.beta.T.cells&amp;NK.like.cells has p value = 0.005
CD3+.alpha.beta.T.cells&amp;Non.inflammatory.macrophages has p value = 0.957
CD3+.alpha.beta.T.cells&amp;Periportal.LSECs has p value = 0.057
CD3+.alpha.beta.T.cells&amp;Stellate.cells has p value = 0.152
CD3+.alpha.beta.T.cells&amp;tumor_1 has p value = 0.000
CD3+.alpha.beta.T.cells&amp;tumor_2 has p value = 0.000
Central.venous.LSECs&amp;Hep.1 has p value = 0.000
Central.venous.LSECs&amp;Hep.3 has p value = 0.000
Central.venous.LSECs&amp;Hep.4 has p value = 0.000
Central.venous.LSECs&amp;Hep.5 has p value = 0.000
Central.venous.LSECs&amp;Inflammatory.macrophages has p value = 0.255
Central.venous.LSECs&amp;Non.inflammatory.macrophages has p value = 0.000
Central.venous.LSECs&amp;Stellate.cells has p value = 0.000
Cholangiocytes&amp;Hep.4 has p value = 0.000
Cholangiocytes&amp;Inflammatory.macrophages has p value = 0.001
Cholangiocytes&amp;Mature.B.cells has p value = 0.002
Cholangiocytes&amp;Periportal.LSECs has p value = 0.000
Cholangiocytes&amp;Stellate.cells has p value = 0.000
Hep.1&amp;Hep.3 has p value = 0.000
Hep.1&amp;Hep.4 has p value = 0.000
Hep.1&amp;Hep.5 has p value = 0.000
Hep.1&amp;Hep.6 has p value = 0.000
Hep.1&amp;Inflammatory.macrophages has p value = 0.000
Hep.1&amp;Non.inflammatory.macrophages has p value = 0.000
Hep.1&amp;Stellate.cells has p value = 0.000
Hep.3&amp;Hep.4 has p value = 0.000
Hep.3&amp;Hep.5 has p value = 0.000
Hep.3&amp;Hep.6 has p value = 0.000
Hep.3&amp;Inflammatory.macrophages has p value = 0.000
Hep.3&amp;Mature.B.cells has p value = 0.000
Hep.3&amp;Non.inflammatory.macrophages has p value = 0.000
Hep.3&amp;Periportal.LSECs has p value = 0.000
Hep.3&amp;Stellate.cells has p value = 0.000
Hep.4&amp;Hep.5 has p value = 0.000
Hep.4&amp;Hep.6 has p value = 0.000
Hep.4&amp;Inflammatory.macrophages has p value = 0.000
Hep.4&amp;Mature.B.cells has p value = 0.000
Hep.4&amp;Non.inflammatory.macrophages has p value = 0.000
Hep.4&amp;Periportal.LSECs has p value = 0.000
Hep.4&amp;Stellate.cells has p value = 0.000
Hep.5&amp;Hep.6 has p value = 0.000
Hep.5&amp;Inflammatory.macrophages has p value = 0.000
Hep.5&amp;Non.inflammatory.macrophages has p value = 0.000
Hep.5&amp;Stellate.cells has p value = 0.000
Inflammatory.macrophages&amp;Mature.B.cells has p value = 0.192
Inflammatory.macrophages&amp;Non.inflammatory.macrophages has p value = 0.248
Inflammatory.macrophages&amp;Periportal.LSECs has p value = 0.017
Inflammatory.macrophages&amp;Stellate.cells has p value = 0.821
Inflammatory.macrophages&amp;tumor_1 has p value = 0.000
Inflammatory.macrophages&amp;tumor_2 has p value = 0.000
Mature.B.cells&amp;Non.inflammatory.macrophages has p value = 0.381
Mature.B.cells&amp;Periportal.LSECs has p value = 0.092
Mature.B.cells&amp;Stellate.cells has p value = 0.885
Mature.B.cells&amp;tumor_1 has p value = 0.000
NK.like.cells&amp;Stellate.cells has p value = 0.000
Non.inflammatory.macrophages&amp;Periportal.LSECs has p value = 0.005
Non.inflammatory.macrophages&amp;Stellate.cells has p value = 0.241
Non.inflammatory.macrophages&amp;tumor_1 has p value = 0.000
Periportal.LSECs&amp;Stellate.cells has p value = 0.658
Periportal.LSECs&amp;tumor_1 has p value = 0.000
Periportal.LSECs&amp;tumor_2 has p value = 0.001
Stellate.cells&amp;tumor_1 has p value = 0.000
Stellate.cells&amp;tumor_2 has p value = 0.001
tumor_1&amp;tumor_2 has p value = 0.001
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_tutorials_MESA_tutorial_ecospatial_liver_32_3.png" src="../../_images/notebooks_tutorials_MESA_tutorial_ecospatial_liver_32_3.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Spot Cell Co-Occurrence</span>
<span class="c1"># Multi-index to single-index column</span>
<span class="n">new_columns</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">spot_co_occurrence_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>  <span class="c1"># This checks if the column is a MultiIndex</span>
        <span class="c1"># Join only if the column name is not &#39;Mouse&#39; or &#39;Condition&#39;</span>
        <span class="k">if</span> <span class="s2">&quot;sample&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">col</span> <span class="ow">and</span> <span class="s2">&quot;Condition&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">col</span><span class="p">:</span>
            <span class="n">new_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&amp;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">col</span><span class="p">))</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If &#39;Mouse&#39; or &#39;Condition&#39; is in the column, it is not joined with &#39;&amp;&#39;</span>
            <span class="n">new_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">new_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>

<span class="n">spot_co_occurrence_df_single</span> <span class="o">=</span> <span class="n">spot_co_occurrence_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">spot_co_occurrence_df_single</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">new_columns</span>
<span class="n">spot_co_occurrence_df_single</span> <span class="o">=</span> <span class="n">spot_co_occurrence_df_single</span><span class="p">[[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">spot_co_occurrence_df_single</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s1">&#39;noid&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">col</span><span class="p">]]</span>

<span class="c1"># Melt the DataFrame</span>
<span class="n">spot_co_occurrence_melted</span> <span class="o">=</span> <span class="n">spot_co_occurrence_df_single</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">id_vars</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sample&#39;</span><span class="p">,</span> <span class="s1">&#39;Condition&#39;</span><span class="p">],</span> <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;Cell Combination&#39;</span><span class="p">,</span> <span class="n">value_name</span><span class="o">=</span><span class="s1">&#39;Frequency&#39;</span><span class="p">)</span>
<span class="n">spot_co_occurrence_melted</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>sample</th>
      <th>Condition</th>
      <th>Cell Combination</th>
      <th>Frequency</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>N1</td>
      <td>Healthy</td>
      <td>Periportal.LSECs&amp;tumor_1</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>N7</td>
      <td>Healthy</td>
      <td>Periportal.LSECs&amp;tumor_1</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>N9</td>
      <td>Healthy</td>
      <td>Periportal.LSECs&amp;tumor_1</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>N6</td>
      <td>Healthy</td>
      <td>Periportal.LSECs&amp;tumor_1</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>N8</td>
      <td>Healthy</td>
      <td>Periportal.LSECs&amp;tumor_1</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>1555</th>
      <td>C7</td>
      <td>HCC</td>
      <td>CD3+.alpha.beta.T.cells&amp;Hep.6</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>1556</th>
      <td>C9</td>
      <td>HCC</td>
      <td>CD3+.alpha.beta.T.cells&amp;Hep.6</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>1557</th>
      <td>C2</td>
      <td>HCC</td>
      <td>CD3+.alpha.beta.T.cells&amp;Hep.6</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>1558</th>
      <td>C3</td>
      <td>HCC</td>
      <td>CD3+.alpha.beta.T.cells&amp;Hep.6</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>1559</th>
      <td>C8</td>
      <td>HCC</td>
      <td>CD3+.alpha.beta.T.cells&amp;Hep.6</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
<p>1560 rows × 4 columns</p>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Spot Cell Co-Occurrence</span>
<span class="n">selected_cell_types</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">spot_co_occurrence_melted</span><span class="p">[</span><span class="s1">&#39;Cell Combination&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="n">selected_p_values</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Perform t-tests</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;p-value before correction: &quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">ct</span> <span class="ow">in</span> <span class="n">selected_cell_types</span><span class="p">:</span> <span class="c1"># df_melted[&#39;CellType&#39;].unique():</span>
    <span class="n">subset</span> <span class="o">=</span> <span class="n">spot_co_occurrence_melted</span><span class="p">[</span><span class="n">spot_co_occurrence_melted</span><span class="p">[</span><span class="s1">&#39;Cell Combination&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ct</span><span class="p">]</span>
    <span class="n">group1</span> <span class="o">=</span> <span class="n">subset</span><span class="p">[</span><span class="n">subset</span><span class="p">[</span><span class="s1">&#39;Condition&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Healthy&#39;</span><span class="p">][</span><span class="s1">&#39;Frequency&#39;</span><span class="p">]</span>
    <span class="n">group2</span> <span class="o">=</span> <span class="n">subset</span><span class="p">[</span><span class="n">subset</span><span class="p">[</span><span class="s1">&#39;Condition&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;HCC&#39;</span><span class="p">][</span><span class="s1">&#39;Frequency&#39;</span><span class="p">]</span>

    <span class="n">t_stat</span><span class="p">,</span> <span class="n">p_value</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">ttest_ind</span><span class="p">(</span><span class="n">group1</span><span class="p">,</span> <span class="n">group2</span><span class="p">,</span> <span class="n">equal_var</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ct</span><span class="si">}</span><span class="s2"> has p value = </span><span class="si">{</span><span class="n">p_value</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">selected_p_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_value</span><span class="p">)</span>

<span class="c1"># Filter the dataframe based on selected CellTypes</span>
<span class="n">df_filtered</span> <span class="o">=</span> <span class="n">spot_co_occurrence_melted</span><span class="p">[</span><span class="n">spot_co_occurrence_melted</span><span class="p">[</span><span class="s1">&#39;Cell Combination&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">selected_cell_types</span><span class="p">)]</span>

<span class="c1"># Plot the filtered data</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">42</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df_filtered</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;Cell Combination&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;Frequency&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;Condition&#39;</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="s1">&#39;muted&#39;</span><span class="p">,</span> <span class="n">boxprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">.3</span><span class="p">),</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">dodge</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="n">selected_cell_types</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">swarmplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df_filtered</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;Cell Combination&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;Frequency&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;Condition&#39;</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="s1">&#39;dark:black&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">dodge</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="n">selected_cell_types</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="n">handles</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">labels</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Groups&quot;</span><span class="p">,</span> <span class="n">handletextpad</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">columnspacing</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">hot_pvals_corrected</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">false_discovery_control</span><span class="p">(</span><span class="n">selected_p_values</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;bh&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">42</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;p-values after correction:&quot;</span><span class="p">)</span>

<span class="n">highlighted_comb</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">yrange</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ct</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">selected_cell_types</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">yrange</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;p = </span><span class="si">{</span><span class="n">pvals_corrected</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ct</span><span class="si">}</span><span class="s2"> in hot spots has p value = </span><span class="si">{</span><span class="n">hot_pvals_corrected</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">hot_pvals_corrected</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.05</span> <span class="ow">and</span> <span class="n">p_vals_corrected_dict</span><span class="p">[</span><span class="n">ct</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">0.05</span><span class="p">:</span>
        <span class="n">highlighted_comb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">strip</span><span class="p">,</span> <span class="n">ct</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&amp;&#39;</span><span class="p">))))</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ct</span><span class="si">}</span><span class="s2"> in whole tissue has p value = </span><span class="si">{</span><span class="n">p_vals_corrected_dict</span><span class="p">[</span><span class="n">ct</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="o">*</span><span class="mi">42</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">selected_cell_types</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mf">0.55</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Frequency&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
p-value before correction:
Antibody.secreting.B.cells&amp;CD3+.alpha.beta.T.cells has p value = 0.293
Antibody.secreting.B.cells&amp;Inflammatory.macrophages has p value = 0.400
Antibody.secreting.B.cells&amp;Mature.B.cells has p value = 0.456
Antibody.secreting.B.cells&amp;Periportal.LSECs has p value = 0.092
Antibody.secreting.B.cells&amp;Stellate.cells has p value = 0.211
CD3+.alpha.beta.T.cells&amp;Central.venous.LSECs has p value = 0.069
CD3+.alpha.beta.T.cells&amp;Cholangiocytes has p value = 0.037
CD3+.alpha.beta.T.cells&amp;Hep.1 has p value = 0.001
CD3+.alpha.beta.T.cells&amp;Hep.3 has p value = 0.000
CD3+.alpha.beta.T.cells&amp;Hep.4 has p value = 0.000
CD3+.alpha.beta.T.cells&amp;Hep.5 has p value = 0.000
CD3+.alpha.beta.T.cells&amp;Hep.6 has p value = 0.023
CD3+.alpha.beta.T.cells&amp;Inflammatory.macrophages has p value = 0.060
CD3+.alpha.beta.T.cells&amp;Mature.B.cells has p value = 0.266
CD3+.alpha.beta.T.cells&amp;NK.like.cells has p value = 0.016
CD3+.alpha.beta.T.cells&amp;Non.inflammatory.macrophages has p value = 0.008
CD3+.alpha.beta.T.cells&amp;Periportal.LSECs has p value = 0.928
CD3+.alpha.beta.T.cells&amp;Stellate.cells has p value = 0.569
CD3+.alpha.beta.T.cells&amp;tumor_1 has p value = 0.000
CD3+.alpha.beta.T.cells&amp;tumor_2 has p value = 0.001
Central.venous.LSECs&amp;Hep.1 has p value = 0.034
Central.venous.LSECs&amp;Hep.3 has p value = 0.021
Central.venous.LSECs&amp;Hep.4 has p value = 0.013
Central.venous.LSECs&amp;Hep.5 has p value = 0.004
Central.venous.LSECs&amp;Inflammatory.macrophages has p value = 0.526
Central.venous.LSECs&amp;Non.inflammatory.macrophages has p value = 0.278
Central.venous.LSECs&amp;Stellate.cells has p value = 0.177
Cholangiocytes&amp;Hep.4 has p value = 0.021
Cholangiocytes&amp;Inflammatory.macrophages has p value = 0.104
Cholangiocytes&amp;Mature.B.cells has p value = 0.161
Cholangiocytes&amp;Periportal.LSECs has p value = 0.033
Cholangiocytes&amp;Stellate.cells has p value = 0.035
Hep.1&amp;Hep.3 has p value = 0.002
Hep.1&amp;Hep.4 has p value = 0.001
Hep.1&amp;Hep.5 has p value = 0.000
Hep.1&amp;Hep.6 has p value = 0.009
Hep.1&amp;Inflammatory.macrophages has p value = 0.087
Hep.1&amp;Non.inflammatory.macrophages has p value = 0.053
Hep.1&amp;Stellate.cells has p value = 0.002
Hep.3&amp;Hep.4 has p value = 0.000
Hep.3&amp;Hep.5 has p value = 0.000
Hep.3&amp;Hep.6 has p value = 0.006
Hep.3&amp;Inflammatory.macrophages has p value = 0.005
Hep.3&amp;Mature.B.cells has p value = 0.004
Hep.3&amp;Non.inflammatory.macrophages has p value = 0.027
Hep.3&amp;Periportal.LSECs has p value = 0.009
Hep.3&amp;Stellate.cells has p value = 0.000
Hep.4&amp;Hep.5 has p value = 0.000
Hep.4&amp;Hep.6 has p value = 0.005
Hep.4&amp;Inflammatory.macrophages has p value = 0.005
Hep.4&amp;Mature.B.cells has p value = 0.005
Hep.4&amp;Non.inflammatory.macrophages has p value = 0.019
Hep.4&amp;Periportal.LSECs has p value = 0.025
Hep.4&amp;Stellate.cells has p value = 0.000
Hep.5&amp;Hep.6 has p value = 0.007
Hep.5&amp;Inflammatory.macrophages has p value = 0.002
Hep.5&amp;Non.inflammatory.macrophages has p value = 0.012
Hep.5&amp;Stellate.cells has p value = 0.000
Inflammatory.macrophages&amp;Mature.B.cells has p value = 0.024
Inflammatory.macrophages&amp;Non.inflammatory.macrophages has p value = 0.017
Inflammatory.macrophages&amp;Periportal.LSECs has p value = 0.617
Inflammatory.macrophages&amp;Stellate.cells has p value = 0.252
Inflammatory.macrophages&amp;tumor_1 has p value = 0.000
Inflammatory.macrophages&amp;tumor_2 has p value = 0.001
Mature.B.cells&amp;Non.inflammatory.macrophages has p value = 0.346
Mature.B.cells&amp;Periportal.LSECs has p value = 0.671
Mature.B.cells&amp;Stellate.cells has p value = 0.757
Mature.B.cells&amp;tumor_1 has p value = 0.001
NK.like.cells&amp;Stellate.cells has p value = 0.016
Non.inflammatory.macrophages&amp;Periportal.LSECs has p value = 0.003
Non.inflammatory.macrophages&amp;Stellate.cells has p value = 0.122
Non.inflammatory.macrophages&amp;tumor_1 has p value = 0.000
Periportal.LSECs&amp;Stellate.cells has p value = 0.655
Periportal.LSECs&amp;tumor_1 has p value = 0.000
Periportal.LSECs&amp;tumor_2 has p value = 0.003
Stellate.cells&amp;tumor_1 has p value = 0.000
Stellate.cells&amp;tumor_2 has p value = 0.002
tumor_1&amp;tumor_2 has p value = 0.001
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/var/folders/7g/phdhh_ld3dlbnrst0t60bwzr0000gn/T/ipykernel_73139/754806585.py:22: FutureWarning: Use &#34;auto&#34; to set automatic grayscale colors. From v0.14.0, &#34;gray&#34; will default to matplotlib&#39;s definition.
  sns.swarmplot(data=df_filtered, x=&#39;Cell Combination&#39;, y=&#39;Frequency&#39;, hue=&#39;Condition&#39;, palette=&#39;dark:black&#39;, size=2.0, dodge=True,order=selected_cell_types, ax=ax, edgecolor=&#39;gray&#39;, linewidth=0.5)
/opt/miniconda3/envs/mesa/lib/python3.11/site-packages/seaborn/categorical.py:3370: UserWarning: 10.0% of the points cannot be placed; you may want to decrease the size of the markers or use stripplot.
  warnings.warn(msg, UserWarning)
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
------------------------------------------
p-values after correction:
Antibody.secreting.B.cells&amp;CD3+.alpha.beta.T.cells in hot spots has p value = 0.336
Antibody.secreting.B.cells&amp;Inflammatory.macrophages in hot spots has p value = 0.446
Antibody.secreting.B.cells&amp;Mature.B.cells in hot spots has p value = 0.501
Antibody.secreting.B.cells&amp;Periportal.LSECs in hot spots has p value = 0.122
Antibody.secreting.B.cells&amp;Stellate.cells in hot spots has p value = 0.257
CD3+.alpha.beta.T.cells&amp;Central.venous.LSECs in hot spots has p value = 0.094
CD3+.alpha.beta.T.cells&amp;Cholangiocytes in hot spots has p value = 0.053
CD3+.alpha.beta.T.cells&amp;Hep.1 in hot spots has p value = 0.002
CD3+.alpha.beta.T.cells&amp;Hep.3 in hot spots has p value = 0.000
CD3+.alpha.beta.T.cells&amp;Hep.4 in hot spots has p value = 0.000
CD3+.alpha.beta.T.cells&amp;Hep.5 in hot spots has p value = 0.000
CD3+.alpha.beta.T.cells&amp;Hep.6 in hot spots has p value = 0.039
CD3+.alpha.beta.T.cells&amp;Inflammatory.macrophages in hot spots has p value = 0.084
CD3+.alpha.beta.T.cells&amp;Mature.B.cells in hot spots has p value = 0.314
CD3+.alpha.beta.T.cells&amp;NK.like.cells in hot spots has p value = 0.030
CD3+.alpha.beta.T.cells&amp;Non.inflammatory.macrophages in hot spots has p value = 0.018
CD3+.alpha.beta.T.cells&amp;Non.inflammatory.macrophages in whole tissue has p value = 0.957
******************************************
CD3+.alpha.beta.T.cells&amp;Periportal.LSECs in hot spots has p value = 0.928
CD3+.alpha.beta.T.cells&amp;Stellate.cells in hot spots has p value = 0.608
CD3+.alpha.beta.T.cells&amp;tumor_1 in hot spots has p value = 0.000
CD3+.alpha.beta.T.cells&amp;tumor_2 in hot spots has p value = 0.003
Central.venous.LSECs&amp;Hep.1 in hot spots has p value = 0.050
Central.venous.LSECs&amp;Hep.3 in hot spots has p value = 0.036
Central.venous.LSECs&amp;Hep.4 in hot spots has p value = 0.026
Central.venous.LSECs&amp;Hep.5 in hot spots has p value = 0.011
Central.venous.LSECs&amp;Inflammatory.macrophages in hot spots has p value = 0.570
Central.venous.LSECs&amp;Non.inflammatory.macrophages in hot spots has p value = 0.323
Central.venous.LSECs&amp;Stellate.cells in hot spots has p value = 0.219
Cholangiocytes&amp;Hep.4 in hot spots has p value = 0.036
Cholangiocytes&amp;Inflammatory.macrophages in hot spots has p value = 0.136
Cholangiocytes&amp;Mature.B.cells in hot spots has p value = 0.203
Cholangiocytes&amp;Periportal.LSECs in hot spots has p value = 0.050
Cholangiocytes&amp;Stellate.cells in hot spots has p value = 0.052
Hep.1&amp;Hep.3 in hot spots has p value = 0.007
Hep.1&amp;Hep.4 in hot spots has p value = 0.004
Hep.1&amp;Hep.5 in hot spots has p value = 0.002
Hep.1&amp;Hep.6 in hot spots has p value = 0.019
Hep.1&amp;Inflammatory.macrophages in hot spots has p value = 0.117
Hep.1&amp;Non.inflammatory.macrophages in hot spots has p value = 0.075
Hep.1&amp;Stellate.cells in hot spots has p value = 0.006
Hep.3&amp;Hep.4 in hot spots has p value = 0.000
Hep.3&amp;Hep.5 in hot spots has p value = 0.000
Hep.3&amp;Hep.6 in hot spots has p value = 0.014
Hep.3&amp;Inflammatory.macrophages in hot spots has p value = 0.013
Hep.3&amp;Mature.B.cells in hot spots has p value = 0.012
Hep.3&amp;Non.inflammatory.macrophages in hot spots has p value = 0.043
Hep.3&amp;Periportal.LSECs in hot spots has p value = 0.018
Hep.3&amp;Stellate.cells in hot spots has p value = 0.000
Hep.4&amp;Hep.5 in hot spots has p value = 0.000
Hep.4&amp;Hep.6 in hot spots has p value = 0.013
Hep.4&amp;Inflammatory.macrophages in hot spots has p value = 0.013
Hep.4&amp;Mature.B.cells in hot spots has p value = 0.013
Hep.4&amp;Non.inflammatory.macrophages in hot spots has p value = 0.033
Hep.4&amp;Periportal.LSECs in hot spots has p value = 0.040
Hep.4&amp;Stellate.cells in hot spots has p value = 0.000
Hep.5&amp;Hep.6 in hot spots has p value = 0.015
Hep.5&amp;Inflammatory.macrophages in hot spots has p value = 0.006
Hep.5&amp;Non.inflammatory.macrophages in hot spots has p value = 0.024
Hep.5&amp;Stellate.cells in hot spots has p value = 0.000
Inflammatory.macrophages&amp;Mature.B.cells in hot spots has p value = 0.039
Inflammatory.macrophages&amp;Mature.B.cells in whole tissue has p value = 0.192
******************************************
Inflammatory.macrophages&amp;Non.inflammatory.macrophages in hot spots has p value = 0.031
Inflammatory.macrophages&amp;Non.inflammatory.macrophages in whole tissue has p value = 0.248
******************************************
Inflammatory.macrophages&amp;Periportal.LSECs in hot spots has p value = 0.650
Inflammatory.macrophages&amp;Stellate.cells in hot spots has p value = 0.303
Inflammatory.macrophages&amp;tumor_1 in hot spots has p value = 0.000
Inflammatory.macrophages&amp;tumor_2 in hot spots has p value = 0.002
Mature.B.cells&amp;Non.inflammatory.macrophages in hot spots has p value = 0.391
Mature.B.cells&amp;Periportal.LSECs in hot spots has p value = 0.689
Mature.B.cells&amp;Stellate.cells in hot spots has p value = 0.767
Mature.B.cells&amp;tumor_1 in hot spots has p value = 0.004
NK.like.cells&amp;Stellate.cells in hot spots has p value = 0.030
Non.inflammatory.macrophages&amp;Periportal.LSECs in hot spots has p value = 0.010
Non.inflammatory.macrophages&amp;Stellate.cells in hot spots has p value = 0.156
Non.inflammatory.macrophages&amp;tumor_1 in hot spots has p value = 0.000
Periportal.LSECs&amp;Stellate.cells in hot spots has p value = 0.681
Periportal.LSECs&amp;tumor_1 in hot spots has p value = 0.000
Periportal.LSECs&amp;tumor_2 in hot spots has p value = 0.009
Stellate.cells&amp;tumor_1 in hot spots has p value = 0.000
Stellate.cells&amp;tumor_2 in hot spots has p value = 0.006
tumor_1&amp;tumor_2 in hot spots has p value = 0.003
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_tutorials_MESA_tutorial_ecospatial_liver_34_3.png" src="../../_images/notebooks_tutorials_MESA_tutorial_ecospatial_liver_34_3.png" />
</div>
</div>
</section>
<section id="Cell-Co-Occurrence-Circle-Plot">
<h3>Cell Co-Occurrence Circle Plot<a class="headerlink" href="#Cell-Co-Occurrence-Circle-Plot" title="Link to this heading"></a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">circoplot_df1</span> <span class="o">=</span> <span class="n">global_co_occurrence_df</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sample&#39;</span><span class="p">])</span>
<span class="n">circoplot_df1</span> <span class="o">=</span> <span class="n">circoplot_df1</span><span class="p">[[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">circoplot_df1</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s1">&#39;NotDet&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">col</span><span class="p">]]</span>
<span class="c1"># Group by &#39;Condition&#39; and calculate the mean of the other columns</span>
<span class="n">circoplot_df1</span> <span class="o">=</span> <span class="n">circoplot_df1</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;Condition&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">circoplot_df1</span> <span class="o">=</span> <span class="n">circoplot_df1</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Condition&#39;</span><span class="p">)</span>
<span class="n">circoplot_df1</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th colspan="5" halign="left">Antibody.secreting.B.cells</th>
      <th colspan="5" halign="left">CD3+.alpha.beta.T.cells</th>
      <th>...</th>
      <th>NK.like.cells</th>
      <th colspan="3" halign="left">Non.inflammatory.macrophages</th>
      <th colspan="3" halign="left">Periportal.LSECs</th>
      <th colspan="2" halign="left">Stellate.cells</th>
      <th>tumor_1</th>
    </tr>
    <tr>
      <th></th>
      <th>CD3+.alpha.beta.T.cells</th>
      <th>Inflammatory.macrophages</th>
      <th>Mature.B.cells</th>
      <th>Periportal.LSECs</th>
      <th>Stellate.cells</th>
      <th>Central.venous.LSECs</th>
      <th>Cholangiocytes</th>
      <th>Hep.1</th>
      <th>Hep.3</th>
      <th>Hep.4</th>
      <th>...</th>
      <th>Stellate.cells</th>
      <th>Periportal.LSECs</th>
      <th>Stellate.cells</th>
      <th>tumor_1</th>
      <th>Stellate.cells</th>
      <th>tumor_1</th>
      <th>tumor_2</th>
      <th>tumor_1</th>
      <th>tumor_2</th>
      <th>tumor_2</th>
    </tr>
    <tr>
      <th>Condition</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>HCC</th>
      <td>0.022196</td>
      <td>0.018992</td>
      <td>0.016074</td>
      <td>0.011441</td>
      <td>0.016042</td>
      <td>0.023526</td>
      <td>0.006582</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>...</td>
      <td>0.006711</td>
      <td>0.065835</td>
      <td>0.058693</td>
      <td>0.153495</td>
      <td>0.080329</td>
      <td>0.195998</td>
      <td>0.034058</td>
      <td>0.127627</td>
      <td>0.027149</td>
      <td>0.167421</td>
    </tr>
    <tr>
      <th>Healthy</th>
      <td>0.021499</td>
      <td>0.014525</td>
      <td>0.009815</td>
      <td>0.023953</td>
      <td>0.025427</td>
      <td>0.046878</td>
      <td>0.043016</td>
      <td>0.091162</td>
      <td>0.179436</td>
      <td>0.305974</td>
      <td>...</td>
      <td>0.034734</td>
      <td>0.006585</td>
      <td>0.096116</td>
      <td>0.000000</td>
      <td>0.091030</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
  </tbody>
</table>
<p>2 rows × 78 columns</p>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[35]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">circoplot_df2</span> <span class="o">=</span> <span class="n">global_cellfreq_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;NotDet&#39;</span><span class="p">])</span>
<span class="c1"># Group by &#39;Condition&#39; and calculate the mean of the other columns</span>
<span class="n">circoplot_df2</span> <span class="o">=</span> <span class="n">circoplot_df2</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;Condition&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">circoplot_df2</span> <span class="o">=</span> <span class="n">circoplot_df2</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Condition&#39;</span><span class="p">)</span>
<span class="n">circoplot_df2</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[35]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>cellType</th>
      <th>Antibody.secreting.B.cells</th>
      <th>CD3+.alpha.beta.T.cells</th>
      <th>Central.venous.LSECs</th>
      <th>Cholangiocytes</th>
      <th>Erthyroid.cells</th>
      <th>Hep</th>
      <th>Hep.1</th>
      <th>Hep.3</th>
      <th>Hep.4</th>
      <th>Hep.5</th>
      <th>...</th>
      <th>Inflammatory.macrophages</th>
      <th>Mature.B.cells</th>
      <th>NK.like.cells</th>
      <th>Non.inflammatory.macrophages</th>
      <th>Periportal.LSECs</th>
      <th>Portal.endothelial.cells</th>
      <th>Stellate.cells</th>
      <th>gamma.delta.T.cells.1</th>
      <th>tumor_1</th>
      <th>tumor_2</th>
    </tr>
    <tr>
      <th>Condition</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>HCC</th>
      <td>0.004335</td>
      <td>0.052099</td>
      <td>0.004248</td>
      <td>0.001246</td>
      <td>0.000355</td>
      <td>0.004334</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>...</td>
      <td>0.041426</td>
      <td>0.012241</td>
      <td>0.001372</td>
      <td>0.021900</td>
      <td>0.029793</td>
      <td>0.002345</td>
      <td>0.024236</td>
      <td>0.001431</td>
      <td>0.743387</td>
      <td>0.055246</td>
    </tr>
    <tr>
      <th>Healthy</th>
      <td>0.005318</td>
      <td>0.042423</td>
      <td>0.012634</td>
      <td>0.018712</td>
      <td>0.003344</td>
      <td>0.000000</td>
      <td>0.041616</td>
      <td>0.068025</td>
      <td>0.368931</td>
      <td>0.263174</td>
      <td>...</td>
      <td>0.019289</td>
      <td>0.008970</td>
      <td>0.008195</td>
      <td>0.028868</td>
      <td>0.024384</td>
      <td>0.001588</td>
      <td>0.055661</td>
      <td>0.009370</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
  </tbody>
</table>
<p>2 rows × 21 columns</p>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[37]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">patient_group</span> <span class="o">=</span> <span class="s1">&#39;HCC&#39;</span>
<span class="n">eco</span><span class="o">.</span><span class="n">create_circos_plot</span><span class="p">(</span><span class="n">circoplot_df1</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="n">patient_group</span><span class="p">]],</span>
                       <span class="n">cell_type_colors_hex</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">cell_abundance</span><span class="o">=</span><span class="n">circoplot_df2</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="n">patient_group</span><span class="p">]],</span>
                       <span class="n">threshold</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
                       <span class="n">edge_weights_scaler</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                       <span class="n">highlighted_edges</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">node_weights_scaler</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span>
                       <span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span>
                       <span class="n">save_path</span><span class="o">=</span><span class="s1">&#39;/Users/Emrys/Downloads/&#39;</span><span class="o">+</span><span class="n">patient_group</span><span class="o">+</span><span class="s1">&#39;_wholetissue_circoplot.svg&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_tutorials_MESA_tutorial_ecospatial_liver_38_0.png" src="../../_images/notebooks_tutorials_MESA_tutorial_ecospatial_liver_38_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[38]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">circoplot_df1</span> <span class="o">=</span> <span class="n">spot_co_occurrence_df</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sample&#39;</span><span class="p">])</span>
<span class="n">circoplot_df1</span> <span class="o">=</span> <span class="n">circoplot_df1</span><span class="p">[[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">circoplot_df1</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s1">&#39;NotDet&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">col</span><span class="p">]]</span>
<span class="c1"># Group by &#39;Condition&#39; and calculate the mean of the other columns</span>
<span class="n">circoplot_df1</span> <span class="o">=</span> <span class="n">circoplot_df1</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;Condition&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">circoplot_df1</span> <span class="o">=</span> <span class="n">circoplot_df1</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Condition&#39;</span><span class="p">)</span>
<span class="n">circoplot_df1</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[38]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th colspan="5" halign="left">Antibody.secreting.B.cells</th>
      <th colspan="5" halign="left">CD3+.alpha.beta.T.cells</th>
      <th>...</th>
      <th>NK.like.cells</th>
      <th colspan="3" halign="left">Non.inflammatory.macrophages</th>
      <th colspan="3" halign="left">Periportal.LSECs</th>
      <th colspan="2" halign="left">Stellate.cells</th>
      <th>tumor_1</th>
    </tr>
    <tr>
      <th></th>
      <th>CD3+.alpha.beta.T.cells</th>
      <th>Inflammatory.macrophages</th>
      <th>Mature.B.cells</th>
      <th>Periportal.LSECs</th>
      <th>Stellate.cells</th>
      <th>Central.venous.LSECs</th>
      <th>Cholangiocytes</th>
      <th>Hep.1</th>
      <th>Hep.3</th>
      <th>Hep.4</th>
      <th>...</th>
      <th>Stellate.cells</th>
      <th>Periportal.LSECs</th>
      <th>Stellate.cells</th>
      <th>tumor_1</th>
      <th>Stellate.cells</th>
      <th>tumor_1</th>
      <th>tumor_2</th>
      <th>tumor_1</th>
      <th>tumor_2</th>
      <th>tumor_2</th>
    </tr>
    <tr>
      <th>Condition</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>HCC</th>
      <td>0.071472</td>
      <td>0.054681</td>
      <td>0.048080</td>
      <td>0.041909</td>
      <td>0.060433</td>
      <td>0.061259</td>
      <td>0.042978</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>...</td>
      <td>0.015938</td>
      <td>0.106321</td>
      <td>0.180634</td>
      <td>0.213524</td>
      <td>0.280178</td>
      <td>0.363789</td>
      <td>0.146445</td>
      <td>0.40268</td>
      <td>0.134935</td>
      <td>0.35633</td>
    </tr>
    <tr>
      <th>Healthy</th>
      <td>0.133004</td>
      <td>0.090733</td>
      <td>0.075861</td>
      <td>0.144542</td>
      <td>0.136850</td>
      <td>0.171346</td>
      <td>0.195916</td>
      <td>0.267537</td>
      <td>0.408425</td>
      <td>0.444679</td>
      <td>...</td>
      <td>0.104890</td>
      <td>0.007692</td>
      <td>0.072244</td>
      <td>0.000000</td>
      <td>0.324560</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.00000</td>
      <td>0.000000</td>
      <td>0.00000</td>
    </tr>
  </tbody>
</table>
<p>2 rows × 78 columns</p>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[40]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">circoplot_df2</span> <span class="o">=</span> <span class="n">spot_cellfreq_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sample&#39;</span><span class="p">])</span>
<span class="c1"># Group by &#39;Condition&#39; and calculate the mean of the other columns</span>
<span class="n">circoplot_df2</span> <span class="o">=</span> <span class="n">circoplot_df2</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;Condition&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">circoplot_df2</span> <span class="o">=</span> <span class="n">circoplot_df2</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Condition&#39;</span><span class="p">)</span>
<span class="n">circoplot_df2</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[40]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Antibody.secreting.B.cells</th>
      <th>CD3+.alpha.beta.T.cells</th>
      <th>Central.venous.LSECs</th>
      <th>Cholangiocytes</th>
      <th>Erthyroid.cells</th>
      <th>Hep</th>
      <th>Hep.1</th>
      <th>Hep.3</th>
      <th>Hep.4</th>
      <th>Hep.5</th>
      <th>...</th>
      <th>Inflammatory.macrophages</th>
      <th>Mature.B.cells</th>
      <th>NK.like.cells</th>
      <th>Non.inflammatory.macrophages</th>
      <th>Periportal.LSECs</th>
      <th>Portal.endothelial.cells</th>
      <th>Stellate.cells</th>
      <th>gamma.delta.T.cells.1</th>
      <th>tumor_1</th>
      <th>tumor_2</th>
    </tr>
    <tr>
      <th>Condition</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>HCC</th>
      <td>0.014845</td>
      <td>0.131641</td>
      <td>0.009099</td>
      <td>0.007342</td>
      <td>0.00000</td>
      <td>0.01286</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>...</td>
      <td>0.114776</td>
      <td>0.035472</td>
      <td>0.002622</td>
      <td>0.034992</td>
      <td>0.064790</td>
      <td>0.005422</td>
      <td>0.089846</td>
      <td>0.003930</td>
      <td>0.348701</td>
      <td>0.12329</td>
    </tr>
    <tr>
      <th>Healthy</th>
      <td>0.019455</td>
      <td>0.088204</td>
      <td>0.028539</td>
      <td>0.042334</td>
      <td>0.00199</td>
      <td>0.00000</td>
      <td>0.095709</td>
      <td>0.101915</td>
      <td>0.185243</td>
      <td>0.116906</td>
      <td>...</td>
      <td>0.042112</td>
      <td>0.019463</td>
      <td>0.014303</td>
      <td>0.021344</td>
      <td>0.077415</td>
      <td>0.007962</td>
      <td>0.111953</td>
      <td>0.006503</td>
      <td>0.000000</td>
      <td>0.00000</td>
    </tr>
  </tbody>
</table>
<p>2 rows × 21 columns</p>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[42]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">patient_group</span> <span class="o">=</span> <span class="s1">&#39;HCC&#39;</span>
<span class="n">eco</span><span class="o">.</span><span class="n">create_circos_plot</span><span class="p">(</span><span class="n">circoplot_df1</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="n">patient_group</span><span class="p">]],</span>
                       <span class="n">cell_type_colors_hex</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">cell_abundance</span><span class="o">=</span><span class="n">circoplot_df2</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="n">patient_group</span><span class="p">]],</span>
                       <span class="n">threshold</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
                       <span class="n">edge_weights_scaler</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                       <span class="n">highlighted_edges</span><span class="o">=</span><span class="n">highlighted_comb</span><span class="p">,</span>
                       <span class="n">node_weights_scaler</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span>
                       <span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span>
                       <span class="n">save_path</span><span class="o">=</span><span class="s1">&#39;/Users/Emrys/Downloads/&#39;</span><span class="o">+</span><span class="n">patient_group</span><span class="o">+</span><span class="s1">&#39;_hotspots_circoplot.svg&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_tutorials_MESA_tutorial_ecospatial_liver_41_0.png" src="../../_images/notebooks_tutorials_MESA_tutorial_ecospatial_liver_41_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="MESA_tutorial_ecospatial_crc.html" class="btn btn-neutral float-left" title="MESA Ecospatial Tutorials (Colorectal Cancer, CODEX)" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="MESA_tutorial_multiomics.html" class="btn btn-neutral float-right" title="MESA Multiomics Tutorials" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Daisy Yi Ding, Zeyu Tang, Bokai Zhu.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>